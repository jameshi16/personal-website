<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.1">Jekyll</generator><link href="https://codingindex.xyz/feed.xml" rel="self" type="application/atom+xml" /><link href="https://codingindex.xyz/" rel="alternate" type="text/html" /><updated>2022-01-25T09:18:31+00:00</updated><id>https://codingindex.xyz/feed.xml</id><title type="html">CodingIndex’s Random Shenanigans</title><subtitle>A (human) index that likes to code. Also drinks way too much coffee.</subtitle><author><name>James</name></author><entry><title type="html">Duty Planning with Linear Programming</title><link href="https://codingindex.xyz/2022/01/25/duty-planning-with-linear-programming/" rel="alternate" type="text/html" title="Duty Planning with Linear Programming" /><published>2022-01-25T09:13:00+00:00</published><updated>2022-01-25T09:13:00+00:00</updated><id>https://codingindex.xyz/2022/01/25/duty-planning-with-linear-programming</id><content type="html" xml:base="https://codingindex.xyz/2022/01/25/duty-planning-with-linear-programming/"><![CDATA[<p>Hello! It sure has been a while, huh? Here, have a coffee :coffee:.</p>

<p>Today, I’ll be writing about the hidden magical gem that is Linear Programming, available in your nearest spreadsheet program, be it <a href="https://www.libreoffice.org/discover/calc/">LibreOffice Calc</a>, Excel, or Google Sheets.</p>

<hr />

<h1 id="basics-of-linear-programming">Basics of Linear Programming</h1>

<p>Unlike the other posts you might have seen within my blog, Linear Programming isn’t actually programming. Rather, it is “a method to achieve the best outcome in a mathematical model whose requirements are represented by linear relationships”, according to <a href="https://en.wikipedia.org/wiki/Linear_programming">Wikipedia</a>.</p>

<p>For those who are uninitiated, or need a mini-not-so-professional-refresher, let us break down the definition.</p>

<h2 id="a-method-to-achieve-the-best-outcome">A method to achieve the best outcome</h2>

<p>Essentially, this is “optimization”. We construct an equation, and we try to either minimize or maximize it - you probably had some exposure to it in high school when they taught us how to differentiate.</p>

<p>However, in optimization, instead of figuring out if an equation should be minimized/maximized, we <em>define</em> if the equation should be minimized/maximized based on our requirements.</p>

<h2 id="whose-requirements-are-represented-by-linear-relationships">Whose requirements are represented by linear relationships</h2>

<p>Linear relationships are essentially either equalities, or inequalities (<code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code> and so on):</p>

<p><img src="/images/20220125_1.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="An example of a linear inequality" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">An example of a linear inequality | Source: Me</p>

<p>Since the relationships must be <em>linear</em>, it implies that equations like the following cannot be solved with Linear Programming:</p>

<p><img src="/images/20220125_3.png" style="max-width: 100px; width: 100%; margin: 0 auto; display: block;" alt="An example of a non-linear inequality" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">An example of a non-linear inequality | Source: Me</p>

<p>If inequalities like the above presents itself, the best course of action would be to use another kind of solver, like a nonlinear programming solver, or a Constraint Problem (CP) solver <a href="https://developers.google.com/optimization/cp#tools">like this one by Google</a>. However, chances are, that with a touch of creativity, most problems can be expressed as a linear programming problem.</p>

<h2 id="linear-programming">Linear Programming</h2>

<p>In a nutshell, given a bunch of inputs, lets say:</p>

<p><img src="/images/20220125_2.png" style="max-width: 100px; width: 100%; margin: 0 auto; display: block;" alt="A bunch of x" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">A bunch of inputs | Source: Me</p>

<p>We can define a bunch of constraints represented via <strong>linear</strong> relationships, like:</p>

<p><img src="/images/20220125_1.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="An example of a linear inequality" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">An example of a linear inequality | Source: Me</p>

<p>For Linear Programming involving only two variables, we can visualize how it works with graphs. Let’s say our two variables are <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code>, and our constraints are:</p>

<p><img src="/images/20220125_4.png" style="max-width: 100px; width: 100%; margin: 0 auto; display: block;" alt="First Constraint" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">First Constraint | Source: Me</p>

<p><img src="/images/20220125_5.png" style="max-width: 100px; width: 100%; margin: 0 auto; display: block;" alt="Second Constraint" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Second Constraint | Source: Me</p>

<p>We will find that the graph on <a href="https://www.desmos.com/calculator">Desmos</a> will look like this:</p>

<p><img src="/images/20220125_6.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Graph" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Graph. Green represents constraint 1, Blue represents constraint 2 | Source: Me</p>

<p>The intersected area (i.e. areas where both blue and green) are the solutions to the inequality (note that the intersection itself is not a solution, since both of our inequalities are not inclusive). Now, if we were to define an objective function, which is the function we want to minimize or maximize:</p>

<p><img src="/images/20220125_7.png" style="max-width: 50px; width: 100%; margin: 0 auto; display: block;" alt="Objective Function" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Objective Function, 2x + y | Source: Me</p>

<p>And then plot it on the graph:</p>

<p><img src="/images/20220125_8.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Objective Function plotted on the graph" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Objective Function (purple) on the graph | Source: Me</p>

<p>We see that the intersection between the line, and the overlapping shaded areas contain all the values that satisfies both constraints, and also the objective function. All we need to do now is to determine what <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> should be if we choose to maximize or minimize our objective function. If it was to maximize our objective function, then the answer we seek is as close to the intersection as possible. Otherwise, if we were to minimize our objective, then the answer we seek should
technically be at another intersection, which isn’t possible with these particular constraints, hence, minimizing the objective would be “INFEASIBLE”.</p>

<p>To wrap up the example, performing linear programming would give us a few results:</p>
<ul>
  <li>The value of <code class="language-plaintext highlighter-rouge">x</code> if the objective function was minimized/maximized</li>
  <li>The value of <code class="language-plaintext highlighter-rouge">y</code> if the objective function was minimized/maximized</li>
  <li>The value of the objective function after minimizing / maximizing</li>
</ul>

<p>And subsequently, to wrap up generally:</p>
<ul>
  <li>The value of <code class="language-plaintext highlighter-rouge">x_1, x_2, x_3, ... x_n</code> if the objective function was minimized/maximized</li>
  <li>The value of the objective function after minimizing / maximizing</li>
</ul>

<p>With more variables, we are essentially working with linear constraints in n-dimensional graphs, which might sound difficult to visualize until you realize it doesn’t really matter, since the user is the one that defines the constraints anyway.</p>

<p>To learn more about how exactly to <em>solve</em> Linear Programming problems, look at the <a href="https://en.wikipedia.org/wiki/Simplex_algorithm">Simplex</a> algorithm. Good solvers would indicate if there is more than one possible answer, or if there is a “close-enough” solution should the entire system be infeasible - although, that is in no way necessary or universal in well-used solvers.</p>

<hr />

<h1 id="duty-planning">Duty Planning</h1>

<p>In my line of work (and probably most of yours, too), duty is a necessary part of work. As a software engineer, this could be translated to being on-call, as a doctor, it could be shifts to do ER, and so on. Needless to say, countless of psychological battles have been waged across the globe thanks to conflicts in agenda when it comes to planning for duty slots: “no weekends please”, or “no public holidays please”, or “my wife’s pregnant” or “I need to walk my pet rock”.</p>

<p>As a duty planner, if you were to ignore these claims, you would be seen as a cold-hearted human being. So I thought: why not just offload the work onto a computer program? Not only would this save time and be much fairer compared to a human (especially if you are also planning it yourself), you would be disguising your own stone-cold, immovable heart and instead blaming your inhumanness on a computer program.</p>

<p>Leveraging on Google Sheet’s integration with Google Forms, I modeled our own planning considerations as linear relationships, maximized preferred dates, and minimized the amount &amp; quality (defined by weekends and public holidays) of duty disparity between each duty personnel. Then, I solved them using Google’s Linear Optimization Service (GLOS).</p>

<blockquote>
  <p>Originally, I used the <a href="https://workspace.google.com/marketplace/app/opensolver/207251662973">OpenSolver</a> app on Google Sheets to solve, but I later realized how slow it was when I was developing the Google Sheet.</p>
</blockquote>

<p>Here is a <a href="https://gist.github.com/jameshi16/bf6583a09a05d490c6ad36d68d377105">GitHub snippet link</a> that contains all of the Google Apps Script used within the relevant Google Sheet. The Google Sheet itself is not open-source, since it contains sensitive data that I won’t try cleaning.</p>

<blockquote>
  <p>Did you know that Google Sheet collaboration isn’t actually simultaneous? The edits from each user just happens so quickly that you see it as simultaneous. Not only is this due to JavaScript browser engines being incapable of multi-processing, but also based on personal experience, where a script can hog out all of the users when busy.  Also, programmatically reading / writing each cell is extremely slow compared to bulk-writing an entire matrix into Google Sheets.</p>
</blockquote>

<p>Instead, allow me to explain how I managed to create linear relationships for some of our planning considerations.</p>

<p>Take <code class="language-plaintext highlighter-rouge">x_i_j</code> (synonymous to <code class="language-plaintext highlighter-rouge">x</code> generally) to be any duty date where <code class="language-plaintext highlighter-rouge">i</code> and <code class="language-plaintext highlighter-rouge">j</code> is the personnel and day respectively, and <code class="language-plaintext highlighter-rouge">b_i_j</code> (synonymous to <code class="language-plaintext highlighter-rouge">b</code> generally) to be any backup date, where the personnel is to serve as a backup for the duty personnel.</p>

<p><code class="language-plaintext highlighter-rouge">1</code> represents duty / backup on that day (depending on whether <code class="language-plaintext highlighter-rouge">x</code> or <code class="language-plaintext highlighter-rouge">b</code> is referred to), and <code class="language-plaintext highlighter-rouge">0</code> represents no duty / backup on that day.</p>

<h2 id="set-in-stone">Set-In-Stone</h2>

<p>As this is considered an “innovation” rather than an “invention”, it is meant to work as a transition between the old process (manually planning) to the new process (automatically planning). Hence, <strong>dates that are manually planted must not be changed</strong>. “Set-In-Stone” acquires non-empty cells, and adds a linear constraint for each affected cell:</p>

<ul>
  <li>If there is a duty slot on that day, then <code class="language-plaintext highlighter-rouge">x = 1</code>, <code class="language-plaintext highlighter-rouge">b = 0</code>.</li>
  <li>If there is no duty slot on that day (forced), then <code class="language-plaintext highlighter-rouge">x = 0</code>, <code class="language-plaintext highlighter-rouge">b = 0</code>.</li>
  <li>If the person is meant to be a backup personnel, then <code class="language-plaintext highlighter-rouge">x = 0</code>, <code class="language-plaintext highlighter-rouge">b = 1</code>.</li>
</ul>

<h2 id="daily-personnel">Daily personnel</h2>

<p>Every single day should have 1 personnel performing duties, while another personnel will be the backup. This is achieved simply by summing for all <code class="language-plaintext highlighter-rouge">i</code>, in the same <code class="language-plaintext highlighter-rouge">j</code>, for all duties / backups.</p>

<p><img src="/images/20220125_9.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="Sum" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Repeat this for every `j` | Source: Me</p>

<h2 id="no-consecutive-days">No consecutive days</h2>

<p>If we were to generate a duty timetable now without some specific constraints, the model would simply assign all the duty to one single person who is free. There are three ways that we are combating this:</p>

<ol>
  <li>Ensuring that there are no consecutive days being served by any given person (in this sub-header);</li>
  <li>Ensuring that everyone’s total points (sum of all of the days that they have served * a modifier based on weekend / public holiday) are <em>close</em> to the average points (pseudo-standard deviation, since we can’t break the linear property);</li>
  <li>Ensuring that all personnel has a chance to do duty, based on the projected number of duty per personnel available in the date range.</li>
</ol>

<p>For a single slot (i.e. the status of duty for a particular person on a particular day), consecutive days are prevented by using this clever little equation, iterating <code class="language-plaintext highlighter-rouge">x_ij</code> over all possible values of <code class="language-plaintext highlighter-rouge">j</code> for <code class="language-plaintext highlighter-rouge">a</code> number of days, where <code class="language-plaintext highlighter-rouge">a</code> is the limit to the number of days someone is allowed to serve.</p>

<p><img src="/images/20220125_10.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="Sum over all possible values of j for a number of days" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Clever Sum | Source: Me</p>

<p>In effect, this ensures that <code class="language-plaintext highlighter-rouge">a</code> days after a duty / backup (not shown) slot, there will not be any more duties.</p>

<h2 id="roughly-equal-points">Roughly equal points</h2>

<p>Without delving too deep into the point system details (as this is subjected to individual implementation), a common understanding between the planners and personnel involved alike are the roughly equal points that everyone should have.</p>

<p>As one of the pivotal factors to eliminate model bias, the points must be allocated fairly to each person. This is done quite simply by taking the projected amount of points (calculated by summing the possible points earned throughout the entire period, dividing by the number of days in the period), introducing a deviation variable, which dictates how many points can each person differ from one another, and then summing the points for each person, ensuring that it is between <code class="language-plaintext highlighter-rouge">point_avg -
deviation</code> to <code class="language-plaintext highlighter-rouge">point_avg + deviation</code>.</p>

<p><img src="/images/20220125_11.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="Approximate equation" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Repeat this for every i | Source: Me</p>

<p>In effect, this means that the model itself would determine the value of <code class="language-plaintext highlighter-rouge">deviation</code>, which means that we want to minimize this as much as possible.</p>

<h2 id="backup--actual-day-cannot-be-on-an-unavailable-date">Backup &amp; Actual Day cannot be on an unavailable date</h2>

<p>This is actually quite simple. After plotting each unavailable date onto a matrix, the <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">b</code> just has to be <code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">0</code> or <code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">1</code>, if unavailable or available respectively.</p>

<h2 id="backup--actual-day-cannot-be-on-the-same-slot">Backup &amp; Actual Day cannot be on the same slot</h2>

<p>This is also pretty simple. <code class="language-plaintext highlighter-rouge">0 &lt; x + b &lt; 1</code> would do the trick: <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">b</code> cannot both be <code class="language-plaintext highlighter-rouge">1</code>, as that would result to <code class="language-plaintext highlighter-rouge">2</code>, which is greater than <code class="language-plaintext highlighter-rouge">1</code>. This prevents a person from simultaneously being his own backup.</p>

<h2 id="chance-to-do-duty">Chance to do duty</h2>

<p>This is done in two parts:</p>

<ol>
  <li>Everyone must do duty based on the projected average;</li>
  <li>Everyone must do a weekday duty the equal number of times, based on projected average.</li>
</ol>

<p>The constraints are quite simple:</p>

<ol>
  <li>Sum up everyone’s duty slots (barring points, all of <code class="language-plaintext highlighter-rouge">j</code> per <code class="language-plaintext highlighter-rouge">i</code>), and it must be greater or equal to the projected average;</li>
  <li>Sum up everyone’s duty slots but only on the weekdays, and it must be greater or equal to the projected average.</li>
</ol>

<p>Weekday is chosen solely due to the large availability compared to weekends - there may be less weekends than the amount of people you are planning for!</p>

<h2 id="unsaid-constraints">Unsaid Constraints</h2>

<p>For obvious reasons, <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">b</code> can only either be <code class="language-plaintext highlighter-rouge">0</code> or <code class="language-plaintext highlighter-rouge">1</code>. <code class="language-plaintext highlighter-rouge">deviation</code> is a continuous variable, solely because points can be expressed as decimals.</p>

<hr />

<h2 id="the-objective">The Objective</h2>

<p>Combined together, the objective of our function is to prioritize &amp; maximize preferred slots (by modifying the points at the objective level, which has benefits over constraint level, as objective is suggestive, while constraints are requirements), while <em>minimizing</em> the deviation variable mentioned earlier.</p>

<p>In a nutshell we are <em>maximizing</em>:</p>

<p><img src="/images/20220125_11.png" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="Objective Function" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Objective Function | Source: Me</p>

<p>The result:</p>

<p><img src="/images/20220125_12.png" style="max-width: 800px; width: 100%; margin: 0 auto; display: block;" alt="Result" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Beautiful Result | Source: Me</p>

<blockquote>
  <p>Green is duty, Yellow is backup, Black is unavailable, and Red is nothing. C is special consideration.</p>
</blockquote>

<hr />

<h1 id="conclusion">Conclusion</h1>

<p>Before I learnt about optimization functions through a mathematical nerd friend of mine, I always thought this kind of problem would be easier solved with things like Machine Learning, or brute-force search.</p>

<p>However, optimization functions not only reduces the search-space by a lot, it also ensures that the result is mathematically sound, and a hundred percent cold and calculating so that you can freeze anyone who decides you are being too inhumane in planning. Or, you could be soft like me and add in dates of consideration (like ethnic holidays). Feel free to use my Google Apps Script code, that is, after you figure out how to create a Google Sheet that it requires as input!</p>

<p>Happy Coding,</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="practical" /><category term="linear" /><category term="programming" /><category term="non-coding" /><summary type="html"><![CDATA[Hello! It sure has been a while, huh? Here, have a coffee :coffee:.]]></summary></entry><entry><title type="html">Activities Thus Far</title><link href="https://codingindex.xyz/2021/10/31/activities-thus-far/" rel="alternate" type="text/html" title="Activities Thus Far" /><published>2021-10-31T08:44:00+00:00</published><updated>2021-10-31T08:44:00+00:00</updated><id>https://codingindex.xyz/2021/10/31/activities-thus-far</id><content type="html" xml:base="https://codingindex.xyz/2021/10/31/activities-thus-far/"><![CDATA[<p>Happy Halloween! :tada:</p>

<p>It’s been a while, huh? I’ve completely broke my <a href="/2021/02/14/zerotier-openvpn-nat-part-1/">New Year’s resolution</a> of delivering 1 blog post every month, gotten listless in my life, and generally lost a great chunk of motivation to maintain my Gentoo installation. In terms of recreation during my weekends, I spend a great deal of time playing Gacha video games (as a free-to-play because I’m broke) and watching a <a href="/anime/">bunch of anime</a>.</p>

<p>It has been a few months since I last touched code for recreation - something I regret greatly. Sometimes, in moments of panic and anxiety for the future, I would log into HackerRank just to practice. Recently, I’ve been slowly going through the <a href="https://doc.rust-lang.org/book/title-page.html">Rust Programming Language</a> book, which has a notable “borrowing” concept to manage memory that piques my interest to explore it in the near future.</p>

<p>Of course, this isn’t all I’ve been doing for the past few months. I’ve picked up chess puzzles (not chess itself), learnt how to solve the Rubik’s cube, automated some parts of my job with simple excel skills, and:</p>

<ul>
  <li>Found out my Maxtor External HDD died</li>
  <li>Repaired my HP 23es monitor</li>
  <li>Created a ephemeral Windows 10 LiveCD with WinPE</li>
</ul>

<hr />

<h1 id="maxtor-external-hdd">Maxtor External HDD</h1>

<p>This external HDD has been with me for three years, containing many projects and Linux containers used for academic purposes and hackathons. My laptop, while a powerhouse, has limited storage, and could not meet the storage demand required to archive these projects. Hence, I rely on the external HDD as-if it was a built-in drive, which meant that it was plugged in at every moment the laptop is online.</p>

<p>Despite knowing that <a href="https://www.newegg.com/insider/how-long-do-hard-drives-and-ssds-last/">the typical hard drive lasts for 3 to 5 years</a>, I thought that there was no need to do predictive maintenance (like backing up) on the drive; furthermore, S.M.A.R.T was still returning an “ok” a few weeks prior to the failure. Alas, it failed spectacularly, and I was unable to recover the data on the drive with tools like <code class="language-plaintext highlighter-rouge">dd</code> and Live Recovery CDs like <a href="https://clonezilla.org/">CloneZilla</a>.</p>

<p>To troubleshoot further, I thought about what an external (implied: portable) HDD is typically made up of:</p>
<ol>
  <li>SATA to USB3.0 converter;</li>
  <li>2.5” HDD</li>
</ol>

<p>Cracking open my Maxtor drive, I found out that my Maxtor’s internal HDD uses a 1TB harddrive from Seagate. Inputting the serial number into the Seagate warranty website suggests that the internal HDD was made particularly for Maxtor HDDs.</p>

<p><img src="/images/20211031_1.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Internal HDD photo" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Internal HDD bundled with the adapter | Source: Me</p>

<p><img src="/images/20211031_2.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="SATA to USB3" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">SATA to USB3.0 adapter | Source: Me</p>

<p>I took the Maxtor internal HDD and plugged it into a desktop with a SATA cable to try recovering the data again.</p>

<p><img src="/images/20211031_3.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Plugging in the HDD" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Plugging in the HDD | Source: Me</p>

<p>To my dismay, it didn’t work: all of the sectors after the header sector is completely unreadable; furthermore, I’ve encrypted the drive with VeraCrypt, so chances are, the data is impractical to recover.</p>

<h2 id="harddrive-lifespan">Harddrive Lifespan</h2>

<p>It may seem like I am barking up the wrong tree here, but I am quite disappointed in the performance of Seagate drives in general. A majority of the drives in my possession are from Western Digital, which are fantastic drives that have lasted me 5 - 6 years since I’ve acquired them.</p>

<p>And it’s not just me; a majority of those in the tech community agrees that WD drives (particularly WD Black) are very reliable hard drives. In my life, I’ve owned two Seagate drives; both of them have failed, despite being newer than my WD Blue drives. I also own an old WD Passport from 2015, which has outlasted everything I’ve had in my possession, although it is an unfair comparison since I don’t run the drive unless necessary.</p>

<h2 id="solution">Solution</h2>

<p>In the first place, relying on the external HDD for daily, I/O intensive stuff is generally a bad idea :tm:. So, I decided to solve the root cause: my laptop did not have enough storage capacity for my needs. My laptop has a 512GB Samsung 960 M.2 SSD, which is partitioned somewhat in half for dual-booting Windows &amp; Ubuntu. This meant around 230GB for each operating system for programs, documents, Machine Learning models, and highly bloated IDEs.</p>

<p>Hence, I decided to get a 1TB Samsung 980 M.2 SSD:</p>

<p><img src="/images/20211031_4.webp" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Samsung 980" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Samsung 980 M.2 SSD | Source: <a href="https://www.samsung.com/sg/memory-storage/nvme-ssd/980-pro-pcle-4-0-nvme-m-2-ssd-1tb-mz-v8p1t0bw/">Samsung Official Site</a></p>

<p>I also decided to replace the external HDD with a new WD Passport, to archive projects that I won’t be working on anymore. This new management of storage will allow my HDD to last much longer, and allow me to bring items with my laptop to do productive work. Furthermore, the upgrade even increased my boot times quite a bit.</p>

<hr />

<h1 id="hp-23es-monitor">HP 23es Monitor</h1>

<p>One day, my display ceased to function. To troubleshoot it, I decided to open up both of my monitors and swap parts until I figured out that:</p>

<ol>
  <li>The panel itself was still functional;</li>
  <li>The power supply still outputs the correct voltage;</li>
  <li>The motherboard couldn’t output to the functional panel &amp; functional power supply.</li>
</ol>

<p>This is the motherboard in question:</p>

<p><img src="/images/20211031_5.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="23es Motherboard" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">23es Motherboard | Source: Me</p>

<p>I bought the monitor in a sale for $150, which is an insanely good price because on Amazon, it costs about $250. However, because I have basic repair skills, I instead bought the motherboard on <a href="https://aliexpress.ru/item/1005002610876248.html?sku_id=12000021382193912&amp;spm=a2g2w.productlist.0.0.2cf2f060HjY9rb">Aliexpress</a> for $30.</p>

<p>Sure enough, swapping out the parts fixed the issue; however, seeing as how this (perfectly normal, cool-less) monitor’s motherboard broke down after a mere 4 years of usage, the problem by and large is likely the humid yet dry environment the monitor is operating in, which causes wear and tear in its components. At the same time, I have an Acer monitor that has lived longer - hopefully, this was just a one-time fluke in the operating life expectancy of the HP 23es monitor.</p>

<hr />

<h1 id="ephemeral-windows-10-livecd">Ephemeral Windows 10 LiveCD</h1>

<p>Windows is a widely used operating system used worldwide in various environments and settings. Hence, there are games and tools built specifically for Windows alone. Linux has many tools to try and bridge the gap between Windows applications and the Linux operating system, either by porting the application, building an alternative, using WINE, or optimizing virtual machines to run only for Windows applications.</p>

<p>The last option stated above has gotten <em>really</em> good recently; by applying a technique known as <a href="https://github.com/joeknock90/Single-GPU-Passthrough">Single GPU passthrough</a>, Linux users can use applications that require hardware acceleration, most notably in video games or professional video editing software. However, this technique does not work on CPUs prior to Intel Broadwell, which is unfortunately exactly what I have on my <a href="/2019/05/01/thinkpad-x220/">x220</a>.</p>

<p>As an advocate of privacy, I love the concept of ephemeral runtimes: whatever changes done by any applications within an ephemeral runtime will not be committed to the system, which makes it simple to run “throwaway” applications should I only need them occasionally, rather than frequently. When I am done with the application, I can simply shutdown the system, and it was like I never used the application in the first place. Furthermore, it does not take up space in the harddrive like a traditional operating system would, meaning that I can have more space storing the files and application that affect my day-to-day life, which makes my setup more organized and purposeful.</p>

<p>Hence, I decided to create my own ephemeral Windows 10 LiveCD, using a tool called <a href="https://en.wikipedia.org/wiki/WinBuilder">Winbuilder</a>. To support 3D applications and as wide of an application spectrum as possible, I ensured that the following feaures were enabled:</p>

<ul>
  <li>Logon as Administrator</li>
  <li>DirectX</li>
  <li>DotNet</li>
  <li>VC++ redistributable</li>
</ul>

<p>Another consideration, when choosing which project to run within Winbuilder, is the difference between WinRE and WinPE. RE stands for Recovery Environment, while PE stands for Pre-installation Environment.</p>

<p>Even though WinRE is based on WinPE, WinPE loads network drivers and is a more complete environment compared to WinRE, which provides more recovery tools than operating system utility (<a href="https://www.tomsguide.com/us/winpe-winre-bootable,review-1191-6.html">Toms’ Guide</a>). Since what I need is essentially as complete of a Windows 10 environment as possible, the natural right answer is WinPE. Furthermore, in my testing, there were some applications that just refuses to run on WinRE, but runs perfectly fine on WinPE.</p>

<hr />

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="general" /><summary type="html"><![CDATA[Happy Halloween! :tada:]]></summary></entry><entry><title type="html">Making a Signal bot</title><link href="https://codingindex.xyz/2021/06/06/making-a-signal-bot/" rel="alternate" type="text/html" title="Making a Signal bot" /><published>2021-06-06T10:38:00+00:00</published><updated>2021-06-06T10:38:00+00:00</updated><id>https://codingindex.xyz/2021/06/06/making-a-signal-bot</id><content type="html" xml:base="https://codingindex.xyz/2021/06/06/making-a-signal-bot/"><![CDATA[<p>Yes, yes, okay, I get it. I missed the May deadline. Here, calm down and have a coffee :coffee:.</p>

<p>So, I don’t have many friends. The friends that I have are… strange, to say the least.</p>

<p>A while ago, I, <a href="https://modelconverge.xyz/">ModelConverge</a> and <a href="https://nikhilr.io/">nikhilr</a> migrated to Signal, to escape from the privacy policy change imposed by Whatsapp. While Whatsapp claims that the privacy policy change will only affect Whatsapp Business users, we had already wanted to migrate away from Whatsapp ever since Facebook acquired it; so the policy change by Whatsapp simply acted as a catalyst. We are hence glad to report that we were part of the masses that hugged <a href="https://www.forbes.com/sites/rachelsandler/2021/01/15/so-many-people-are-using-signal-it-caused-an-outage/?sh=7d7968493df2">Signal to death</a> during a mass migration to the Signal platform, especially after <a href="https://twitter.com/elonmusk/status/1347165127036977153?lang=en">Elon Musk’s tweet</a>.</p>

<blockquote>
  <p>For those of you living under a rock, Signal is an instant messenger just like Whatsapp. Many people migrated to Signal because: (i) it is <a href="https://github.com/signalapp">open-source</a>, (ii) it is run by a <a href="https://signalfoundation.org/">non-profit organization</a> and (iii) has <a href="https://signal.org/docs/">libraries &amp; specifications</a> for developers who want to leverage the Signal protocol or platform to build apps.</p>
</blockquote>

<h1 id="spark">Spark</h1>

<p>The Signal messenger is wonderful; but the users - they have too much power. One of my pals, <a href="https://nikhilr.io/">nikhilr</a> decided to change the group’s avatar photo, drastically changing the friendly democratic climate we shared, effectively serving as a declaration of war between all parties involved. What followed was a great group war that is described in history books as the pivotal moment of the greatest creation.</p>

<p><img src="/images/20210606_1.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Fighting a great war" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Fighting a great war in Signal | Source: Me</p>

<p>I couldn’t just sit idly by and watch as my enemy won battle after battle, getting foothold after foothold on my sanctuary; hence, as a responsible and perfectly rational adult, I decided to abandon all of the work society had me do, and built a Signal bot to eliminate my enemy’s only advantage (free time), and exploit his weakest point (the fact that he is human and hence slower).</p>

<p><img src="/images/20210606_2.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="The bot in action, but Nikhil disrupts the policy" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Using a bot to fight the war | Source: Me</p>

<p>As you can clearly see, before nikhilr decided to remove my privileges to edit the Group Avatar like a true savage undeserving of a respectful knight, my bot fought an admirable battle, stunning my enemies who displayed sheer awe towards my cunning plot.</p>

<p>Today, we won’t be building Group Contender Bot; instead, we’ll just be making a simple Signal bot, to jog your creativity and get you started.</p>

<hr />

<h1 id="considerations">Considerations</h1>

<p>Being a container nerd, I decided that my bot <em>must</em> be setup and run in a container. Automatically, this means that the Signal bot can be run from any platform that can run Docker; furthermore, this would deploy nicely on a home server running most services on <code class="language-plaintext highlighter-rouge">docker-compose</code>.</p>

<p>When searching for a way to interface with Signal, I found <a href="https://github.com/AsamK/signal-cli">Signal CLI</a>, which exposes a DBus interface for applications to interact with. Hence, all I needed to do was to get a library that could interface with the DBus, like <a href="https://pypi.org/project/pydbus/"><code class="language-plaintext highlighter-rouge">pydbus</code></a>.</p>

<h2 id="dbus">DBus</h2>

<p>Many Linux applications talk to each other over the System DBus; according to <a href="https://unix.stackexchange.com/a/604398">this StackOverflow post</a>, it is used as an alternative to <code class="language-plaintext highlighter-rouge">sudo</code>, by allowing a non-privileged application to perform inter-process communication (IPC) to a more privileged application through a bunch of exposed functions. Hence, the system DBus is also the default DBus used by many applications.</p>

<p>Because of the <code class="language-plaintext highlighter-rouge">non-privileged &lt;-&gt; privilege</code> method of communication, container software do not normally expose the System DBus to guest containers because it would open up a whole array of possible vulnerabilities. Thankfully, when digger deeper as to what DBus actually is, I found out that it is essentially a protocol slapped on top of a UNIX socket, meaning that theoretically, it should be possible to construct my own DBus instance <em>just</em> for Signal communication.</p>

<h2 id="python">Python</h2>

<p>The beauty of using the DBus to communicate implies that any language under the sun can be used; I decided to go with Python on an impulse with no clear thought; if I were to make a rational choice, I would have selected <a href="https://golang.org/">Golang</a>, for how simple it is to spawn Go routines for multiprocessing.</p>

<p>On the other hand, Python makes the code more understandable to a wider audience, given its simplicity, and how it is the “comfy” language for most people, allowing a wider audience to develop useful Signal bots.</p>

<hr />

<h1 id="pre-requisites">Pre-requisites</h1>

<p>So, let us build a Signal bot!</p>

<p>First and foremost, we need to install all of the dependencies. On an Ubuntu system, Signal CLI requires <code class="language-plaintext highlighter-rouge">default-jre</code>, while the <code class="language-plaintext highlighter-rouge">pydbus</code> package requires <code class="language-plaintext highlighter-rouge">build-essentials</code>, <code class="language-plaintext highlighter-rouge">libcairo2-dev</code> and <code class="language-plaintext highlighter-rouge">libgirepository1.0-dev</code>. As you can see, for a bot that will run in container, there are quite a lot of dependencies; hence, instead of polluting my otherwise pure host environment, I decided to create a <code class="language-plaintext highlighter-rouge">Dockerfile</code> to build me an environment that can handle Signal CLI.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:latest</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span><span class="s2">"noninteractive"</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> python3 python3-pip default-jre coreutils curl wget libcairo2-dev libgirepository1.0-dev
<span class="k">WORKDIR</span><span class="s"> /tmp</span>
<span class="k">RUN </span>curl <span class="nt">-s</span> https://api.github.com/repos/AsamK/signal-cli/releases/latest <span class="se">\
</span>  | <span class="nb">grep</span> <span class="s2">"browser_download_url.*tar.gz"</span> <span class="se">\
</span>  | <span class="nb">cut</span> <span class="nt">-d</span> : <span class="nt">-f</span> 2,3 <span class="se">\
</span>  | <span class="nb">tr</span> <span class="nt">-d</span> <span class="se">\"</span> <span class="se">\
</span>  | <span class="nb">grep</span> <span class="s2">".gz$"</span> <span class="se">\
</span>  | wget <span class="nt">-qi</span> -
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /opt/cli <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /opt/bot <span class="o">&amp;&amp;</span> <span class="nb">tar </span>xvf <span class="k">*</span>.tar.gz <span class="nt">-C</span> /opt/cli <span class="o">&amp;&amp;</span> <span class="nb">mv</span> /opt/cli/signal<span class="k">*</span> /opt/cli/signal
<span class="k">WORKDIR</span><span class="s"> /opt/bot</span>
<span class="k">RUN </span>pip <span class="nb">install </span>pydbus PyGObject
</code></pre></div></div>

<blockquote>
  <p>I adapted the <code class="language-plaintext highlighter-rouge">curl</code> command from this <a href="https://gist.github.com/steinwaywhw/a4cd19cda655b8249d908261a62687f8">GitHub gist</a> written by <a href="https://gist.github.com/steinwaywhw"><code class="language-plaintext highlighter-rouge">@steinwaywhw</code></a>.</p>
</blockquote>

<p>This creates an Ubuntu container with the latest Signal CLI install in <code class="language-plaintext highlighter-rouge">/opt/cli</code>, and the working directory planted in <code class="language-plaintext highlighter-rouge">/opt/bot</code>. To use this container for Signal bot development, you will keep some things at hand:</p>

<ol>
  <li>A phone number you have SMS access to;</li>
  <li>A directory to store your Signal secrets;</li>
  <li>A directory for your bot project;</li>
  <li>A name for your bot.</li>
</ol>

<p>Once you have figured out the phone number &amp; directories you want to use, set them in a terminal you’ll be using for Signal bot related work:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PHONE_NUMBER="&lt;a phone number, with +countrycode prefixed&gt;"
export SIGNAL_CLI_DATA="&lt;a directory for signal secrets&gt;"
export SIGNAL_BOT_PROJECT="&lt;the directory to your bot project&gt;"
export SIGNAL_BOT_NAME="&lt;any alphanumeric name for your bot&gt;"
alias signal-cli='docker run -v "$SIGNAL_BOT_PROJECT:/opt/bot" -v "$SIGNAL_CLI_DATA:/root/.local/share/signal-cli" -e PHONE_NUMBER="$PHONE_NUMBER" signal-bot:latest /opt/cli/signal/bin/signal-cli'
</code></pre></div></div>

<p>For development purposes, we should first link the Signal CLI to our phone number, so that the bot can send and receive messages. To do this, we first copy + paste the <code class="language-plaintext highlighter-rouge">Dockerfile</code> to a local directory, and build the Docker image:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/2fff57fac78826e17ad097dcb4c7ed1e873ddb1e/Dockerfile
docker build . -t signal-bot:latest
</code></pre></div></div>

<p>Now, if you want to link to a phone number <em>you already use for daily Signal usage</em>, then run this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli link -n "$SIGNAL_BOT_NAME" &gt; /tmp/output &amp; \sleep 10 &amp;&amp; cat /tmp/output | curl -F-=\&lt;- https://qrenco.de &amp;&amp; fg
</code></pre></div></div>

<p>A QR code should be generated and then printed on your terminal window; scan the result with your phone’s Signal messenger. If you don’t know how, follow the <a href="https://support.signal.org/hc/en-us/articles/360007320551-Linked-Devices">guide on the official Signal Support</a>.</p>

<p>Your device should be linked.</p>

<p><strong>Otherwise</strong>, if you want to link a completely new phone number, then run this Signal CLI command through the container:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli -u ${PHONE_NUMBER} register
</code></pre></div></div>

<p>You should receive a SMS with your OTP code to activate Signal. Copy that verification code before running this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli -u ${PHONE_NUMBER} verify &lt;insert verification code&gt;
</code></pre></div></div>

<h1 id="writing-the-bot">Writing the bot</h1>

<p>Now, we move to the stage where we write the bot. No matter what language the bot is written in, the bot needs at least two other running processes:</p>

<ol>
  <li>A DBus daemon; and</li>
  <li>A daemonized Signal CLI process.</li>
</ol>

<p>Hence, before we can even write the content required for the bot, we must first write an entrypoint script for the Docker container. Luckily, we can quite easily write this script:</p>

<p><code class="language-plaintext highlighter-rouge">entrypoint.sh</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nb">export </span><span class="nv">DBUS_SESSION_BUS_ADDRESS</span><span class="o">=</span><span class="si">$(</span>dbus-daemon <span class="nt">--session</span> <span class="nt">--fork</span> <span class="nt">--print-address</span><span class="si">)</span>

<span class="nb">touch</span> /tmp/output.log
/opt/cli/signal/bin/signal-cli <span class="nt">-u</span> <span class="s2">"</span><span class="k">${</span><span class="nv">PHONE_NUMBER</span><span class="k">}</span><span class="s2">"</span> daemon <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp;
dbus-monitor <span class="nt">--session</span> <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp; <span class="c"># comment this out if you no longer need to monitor the bus</span>
<span class="nb">sleep </span>20s <span class="o">&amp;&amp;</span> python3 /opt/bot/script.py <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp;

<span class="nb">tail</span> <span class="nt">-f</span> /tmp/output.log
</code></pre></div></div>

<p>The script above assumes that you are executing a bot written in Python, with the entrypoint of that bot within <code class="language-plaintext highlighter-rouge">script.py</code> of your project folder, and also assumes that you have set the environmental variables right. Let’s test it out:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alias run_bot="docker run -v \"$SIGNAL_BOT_PROJECT:/opt/bot\" -v \"$SIGNAL_CLI_DATA:/root/.local/share/signal-cli\" -e PHONE_NUMBER=\"$PHONE_NUMBER\" signal-bot:latest ./entrypoint.sh"
wget -O script.py https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/fd3fc896bfe56d18741ba84c8c63d00f34c8434b/receive.py
run_bot
</code></pre></div></div>

<p>The script written by <code class="language-plaintext highlighter-rouge">mh-g</code>, modified by me to use a Session Bus instead, essentially reads every message pumped into Signal out onto the terminal window.</p>

<blockquote>
  <p>The purpose of <code class="language-plaintext highlighter-rouge">sleep 20s</code> is to give Signal CLI some time to: (i) start daemonizing, (ii) connect to the DBus, and (iii) synchronize messages a little before starting the actual script. Sometimes, this takes more than 20s, but for our purposes, it should be good enough. You may sometimes find your bot unresponsive during this stage; but trust me, it’ll work <em>eventually</em>, after catching up with all of the messages.</p>
</blockquote>

<p>Once you have verified the workability of your whole set up, it is time to write code to develop a signal bot. Let’s start with the <code class="language-plaintext highlighter-rouge">receive.py</code> sample code you downloaded to test the workability of your setup:</p>

<p><code class="language-plaintext highlighter-rouge">script.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="k">def</span> <span class="nf">msgRcv</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"msgRcv called"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">return</span>

<span class="kn">from</span> <span class="nn">pydbus</span> <span class="kn">import</span> <span class="n">SessionBus</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GLib</span>

<span class="n">bus</span> <span class="o">=</span> <span class="n">SessionBus</span><span class="p">()</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">GLib</span><span class="p">.</span><span class="n">MainLoop</span><span class="p">()</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">bus</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'org.asamk.Signal'</span><span class="p">,</span> <span class="s">'/org/asamk/Signal'</span><span class="p">)</span>
<span class="n">signal</span><span class="p">.</span><span class="n">onMessageReceived</span> <span class="o">=</span> <span class="n">msgRcv</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>If you’ve linked the bot to a number that is <em>already</em> using Signal, then you would realize that this piece of code would only work when people other than yourself messages you. If you want to receive <em>all</em> messages, including the ones from yourself, then change:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">def msgRcv(timestamp, source, groupID, message, attachments):
</span>  print("msgRcv called")
  print(message)
  return

+ def msgSyncRcv(timestamp, source, destination, groupID, message, attachments):
<span class="gi">+   msgRcv(timestamp, source, groupId, message, attachments)
+   return
</span>
...

signal = bus.get('org.asamk.Signal', '/org/asamk/Signal')
<span class="p">signal.onMessageReceived = msgRcv
</span><span class="gi">+ signal.onSyncMessageReceived = msgSyncRcv
</span>
if __name__ == '__main__':
</code></pre></div></div>

<p>And then run the bot again with the <code class="language-plaintext highlighter-rouge">run_bot</code> command.</p>

<p>Let’s make the bot respond to commands that start with the <code class="language-plaintext highlighter-rouge">/</code> prefix, by changing the contents of the <code class="language-plaintext highlighter-rouge">msgRcv</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">msgRcv</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/'</span><span class="p">:</span>
    <span class="n">signal</span><span class="p">.</span><span class="n">sendGroupMessage</span><span class="p">(</span><span class="s">"{:s} said {:s}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">message</span><span class="p">),</span> <span class="p">[],</span> <span class="n">groupID</span><span class="p">)</span>
  <span class="k">return</span>

</code></pre></div></div>

<p>Now, send a message to the bot with the <code class="language-plaintext highlighter-rouge">/</code> prefix, and you should see that the bot echos you like a parrot. With that, we now have a basic bot. For more things that the bot can do, check out <a href="https://github.com/AsamK/signal-cli/blob/master/man/signal-cli-dbus.5.adoc">Signal CLI’s DBus wiki</a>; all of the functions are available by de-capitalizing the first letter, and then accessing it as a sub-member of the <code class="language-plaintext highlighter-rouge">signal</code> object. This also includes the DBus signals listed on the manpage.</p>

<p>For a more complete guide, let’s make an 8-ball bot, which essentially just returns an 8-ball-esque response based on random probability.</p>

<p>8-ball has <a href="https://en.wikipedia.org/wiki/Magic_8-Ball#Design_and_usage">20 different answers</a>, which can be represented by the following Python list:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s">'It is Certain.'</span><span class="p">,</span> <span class="s">'It is decidedly so.'</span><span class="p">,</span> <span class="s">'Without a doubt.'</span><span class="p">,</span> <span class="s">'Yes definitely.'</span><span class="p">,</span> <span class="s">'You may rely on it.'</span><span class="p">,</span> <span class="s">'As I see it, yes.'</span><span class="p">,</span> <span class="s">'Most likely.'</span><span class="p">,</span> <span class="s">'Outlook good.'</span><span class="p">,</span> <span class="s">'Yes.'</span><span class="p">,</span> <span class="s">'Signs point to yes.'</span><span class="p">,</span> <span class="s">'Reply hazy, try again.'</span><span class="p">,</span> <span class="s">'Ask again later.'</span><span class="p">,</span> <span class="s">'Better not tell you now.'</span><span class="p">,</span> <span class="s">'Cannot predict now.'</span><span class="p">,</span> <span class="s">'Concentrate and ask again.'</span><span class="p">,</span> <span class="s">'Don</span><span class="se">\'</span><span class="s">t count on it.'</span><span class="p">,</span> <span class="s">'My reply is no.'</span><span class="p">,</span> <span class="s">'My sources say no.'</span><span class="p">,</span> <span class="s">'Outlook not so good.'</span><span class="p">,</span> <span class="s">'Very doubtful.'</span><span class="p">]</span>
</code></pre></div></div>

<p>For the <code class="language-plaintext highlighter-rouge">msgRcv</code> function, we basically just choose a random string within the list, and return it whenever we see 8 ball after the <code class="language-plaintext highlighter-rouge">/</code> prefix:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s">'It is Certain.'</span><span class="p">,</span> <span class="s">'It is decidedly so.'</span><span class="p">,</span> <span class="s">'Without a doubt.'</span><span class="p">,</span> <span class="s">'Yes definitely.'</span><span class="p">,</span> <span class="s">'You may rely on it.'</span><span class="p">,</span> <span class="s">'As I see it, yes.'</span><span class="p">,</span> <span class="s">'Most likely.'</span><span class="p">,</span> <span class="s">'Outlook good.'</span><span class="p">,</span> <span class="s">'Yes.'</span><span class="p">,</span> <span class="s">'Signs point to yes.'</span><span class="p">,</span> <span class="s">'Reply hazy, try again.'</span><span class="p">,</span> <span class="s">'Ask again later.'</span><span class="p">,</span> <span class="s">'Better not tell you now.'</span><span class="p">,</span> <span class="s">'Cannot predict now.'</span><span class="p">,</span> <span class="s">'Concentrate and ask again.'</span><span class="p">,</span> <span class="s">'Don</span><span class="se">\'</span><span class="s">t count on it.'</span><span class="p">,</span> <span class="s">'My reply is no.'</span><span class="p">,</span> <span class="s">'My sources say no.'</span><span class="p">,</span> <span class="s">'Outlook not so good.'</span><span class="p">,</span> <span class="s">'Very doubtful.'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">msgRcv</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/'</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">'8ball'</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">signal</span><span class="p">.</span><span class="n">sendGroupMessage</span><span class="p">(</span><span class="s">'8ball: '</span> <span class="o">+</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="p">[],</span> <span class="n">groupID</span><span class="p">)</span>
  <span class="k">return</span>
</code></pre></div></div>

<p>Full code for <code class="language-plaintext highlighter-rouge">script.py</code> can be found in <a href="https://gist.github.com/jameshi16/71764cc0bac84adda717e9ddb0b44364#file-script-py">my gist</a>. After editing the script, the bot can be run with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run_bot
</code></pre></div></div>

<p>Now, on Signal, messaging <code class="language-plaintext highlighter-rouge">/8ball</code> should yield:</p>

<p><img src="/images/20210606_3.PNG" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="8 ball response" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">A response from magical 8 ball | Source: Me</p>

<h1 id="docker-compose">Docker Compose</h1>

<p>The last part is probably the simplest part; writing the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file. The template should be quite self-explanatory:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">signal-bot</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/Dockerfile</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">signal-bot</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">/bin/bash -c "./entrypoint.sh"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">${SIGNAL_CLI_DATA}:/root/.local/share/signal-cli</span>
      <span class="pi">-</span> <span class="s">${SIGNAL_BOT_PROJECT}:/opt/bot</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">PHONE_NUMBER=${PHONE_NUMBER}</span>
</code></pre></div></div>

<p>Then, fill in the relevant details in the <code class="language-plaintext highlighter-rouge">.env</code> file. If you have not shutdown the terminal you used in the <a href="#pre-requisite">pre-requisite</a> stage, then you can use this command to generate the <code class="language-plaintext highlighter-rouge">.env</code> file:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -e "SIGNAL_CLI_DATA=${SIGNAL_CLI_DATA}\nSIGNAL_BOT_PROJECT=${SIGNAL_BOT_PROJECT}\nPHONE_NUMBER=${PHONE_NUMBER}" &gt; .env
docker-compose config
</code></pre></div></div>

<p>You should see all of the environment variables substituted. If they are all there, then you can run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up
</code></pre></div></div>

<p>To see the bot in action; and run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up -d
</code></pre></div></div>

<p>To detach it from the terminal, and run it in the background.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Welp, that was fun! I will make the source code for the Group Avatar Contender bot available soon; but don’t count on it to be online after this blog post. Hopefully, this blog post makes up for the missing one you would have otherwise gotten on May. There <em>should</em> be a separate blog post for June; until then, ciao!</p>

<p>Happy Coding,</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="signal" /><category term="bot" /><category term="signal" /><summary type="html"><![CDATA[Yes, yes, okay, I get it. I missed the May deadline. Here, calm down and have a coffee :coffee:.]]></summary></entry><entry><title type="html">Coffee :coffee:</title><link href="https://codingindex.xyz/2021/04/25/coffee/" rel="alternate" type="text/html" title="Coffee :coffee:" /><published>2021-04-25T11:11:00+00:00</published><updated>2021-04-25T11:11:00+00:00</updated><id>https://codingindex.xyz/2021/04/25/coffee</id><content type="html" xml:base="https://codingindex.xyz/2021/04/25/coffee/"><![CDATA[<p>Initially, I planned to write about my findings after reverse-engineering some RPG Maker XP, VX, VX Ace, MV and Wolf Editor games (which is not illegal as long as I’m not creating a copy or changing the artifact in any way according to <a href="https://en.wikipedia.org/wiki/Reverse_engineering">Wikipedia</a>, which is definitely the best source of legal advice. But seriously though, I’m doing it for educational purpose and nothing else.). However, whenever life gives you lemons, you sigh <i>ugh</i> and wait for a better fruit.</p>

<p>Instead, I changed my plans and wanted to write about studying techniques for remembering content you have little interest in, since that has been my most utilized skill for the past few months. Then, I looked at my coffee, drank the coffee, thought about how interesting it was that coffee was banned a few times in history and decided that I was going to do a blog post about coffee instead.</p>

<p>So, let’s get started!</p>

<h1 id="why-do-we-drink-coffee">Why do we drink coffee</h1>

<p>Coffee contains caffeine, which is a drug that stimulates the brain and helps us stay awake and alert (ref. 1, 2, 3). The usage of coffee is ubiquitous for almost any profession and scenario that requires the worker to stay awake - artists, musicians, labourers, architects, engineers, and of course, programmers. For enterprise programmers, it helps them trudge through client complaints, unreasonable demands from product managers, and fixing failing unit tests - just to name a few. Caffeine also boosts mood, metabolism and physical performance (ref. 8).</p>

<p>Despite its name, <em>decaffeinated</em> coffee is not fully caffeine free; a cup of coffee containing 180mg of caffeine will end up having 5.4mg of caffeine when decaffeinated (ref. 11).</p>

<h1 id="how-much-coffee-can-we-ingest-in-a-day">How much coffee can we ingest in a day?</h1>

<p>For adults, the recommended daily caffeine intake is 400mg - which is about 4 or 5 cups of coffee per day (ref. 4). For reference, a cup conventionally contains 200ml to 250ml of coffee (ref. 5) (the former will limit coffee intake to 5 cups a day, while the latter will limit coffee to 4 cups a day) - this would mean that, in metric units, an adult can drink up to 1 litre of coffee a day.</p>

<p>There exists light coffee drinkers and heavy coffee drinkers differentiated by their caffeine tolerance (ref. 6), which affects the magnitude and duration of the undesirable side effects of coffee. An individual that is unsure of their caffeine intake should try to only ingest a maximum of 200mg of caffeine per day, which amounts to 2 or 2.5 cups a day.</p>

<p>Some figures for commonly ingested source of caffeine:</p>

<p><img src="/images/20210425_5.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Caffeine doses" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Caffeine doses in coffee | Source: <a href="https://www.apa.org/gradpsych/2015/11/coffee">Stacy Lu, APA (ref. 7)</a></p>

<p>Some more figures from ref. 6:</p>

<ul>
  <li>Coffee: 96mg per cup</li>
  <li>Energy Drink: 72mg per cup</li>
  <li>Green Tea: 29mg per cup</li>
  <li>Soft Drink: 34mg per cup</li>
</ul>

<h1 id="side-effects-of-coffee">Side-effects of coffee</h1>

<p>Recalling that the recommended maximum daily caffeine intake is 400mg, ingesting 3 times the amount will likely result to toxic effects (ref. 4). Some toxic effects include (ref. 8, 9):</p>
<ol>
  <li>Anxiety</li>
  <li>Sleep disorder</li>
  <li>Increased blood sugar levels</li>
  <li>Increased heart rate &amp; blood pressure</li>
</ol>

<p><img src="/images/20210425_6.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Coffee" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Coffee | Photo by Nathan Dumlao on <a href="https://unsplash.com/photos/6VhPY27jdps">Unsplash (ref. 10)</a></p>

<h1 id="history-of-coffee">History of coffee</h1>

<p>The origins of coffee (as in the coffee beans) is highly debatable (ref. 12), although it can be said that due to its discovery since time immemorial, it has touched upon every aspect of human civilisation, including religion (as with the case with it replacing wine in the Muslim religion), politics (as with the various bans on coffee) and trade.</p>

<p>An interesting aspect of coffee was its use by America in World War I, and its relation to coffeehouses, which were cornerstones for people to “hang out”.</p>

<h2 id="world-war-i">World War I</h2>

<p>In World War I, coffee was considered to be an essential item in the America army (ref. 13) - it was so essential that coffee became a rationed item in November 29, 1942 (ref. 14). There were only two reasons any resources needed to be rationed in the context of war:</p>
<ol>
  <li>To ensure all civilians get access to said resource fairly;</li>
  <li>To ensure the military has access to said resource.</li>
</ol>

<p><img src="/images/20210425_7.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="A propaganda poster for coffee rationing" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Coffee Rationing in US | Source: <a href="https://www.wearethemighty.com/articles/brief-history-coffee-field/">WeAreTheMighty (ref. 15)</a></p>

<p>As for the reasons why coffee was much needed in the trenches of World War I, it was to combat fatigue, much like how we use coffee nowadays. Having re-energized troops can make a huge difference in the context of war.</p>

<h2 id="coffeehouses">Coffeehouses</h2>

<p>Coffeehouses were popular places for people of all classes to “meet, discuss business, exchange ideas and debate the news of the day” (ref. 16). Having free debate and discussion between people of all social statuses lead to the spread of democracy. However, because coffeehouses were so commonplace and popular, some were filled with criminals, scoundrels and pimps (ref. 16), enough to warrant an attempt was made to ban coffeehouses in 1675.</p>

<p>Coffeehouses soon fell out of favour as the popularity of tea rose, but its impact on democracy can still be felt today.</p>

<h1 id="conclusion">Conclusion</h1>

<p>It is strange to make a blog post about a commodity that is widely enjoyed instead of a programming blog post; luckily, as my blog name suggests, I like to do “Random Shenanigans”, which means that once in a while, an informative blog post such as this is nice to have.</p>

<p>I hope you enjoyed this blog post, as much as I enjoyed writing it! Let’s hope that I get apples instead of lemons from life next time; I haven’t got a lemonade maker.</p>

<p>Happy Coding (&amp; enjoy a cup of coffee :coffee:),</p>

<p>CodingIndex</p>

<h1 id="references">References</h1>

<p>Here are a list of references informally attributed, because I’m too lazy to do a proper citation.</p>

<ol>
  <li><a href="https://www.webmd.com/vitamins/ai/ingredientmono-979/caffeine">https://www.webmd.com/vitamins/ai/ingredientmono-979/caffeine</a></li>
  <li><a href="https://www.healthline.com/nutrition/what-is-caffeine#what-it-is">https://www.healthline.com/nutrition/what-is-caffeine#what-it-is</a></li>
  <li><a href="https://www.healthline.com/health/caffeine-effects-on-body">https://www.healthline.com/health/caffeine-effects-on-body</a></li>
  <li><a href="https://www.fda.gov/consumers/consumer-updates/spilling-beans-how-much-caffeine-too-much">https://www.fda.gov/consumers/consumer-updates/spilling-beans-how-much-caffeine-too-much</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Cup\_(unit)">https://en.wikipedia.org/wiki/Cup_(unit)</a></li>
  <li><a href="https://www.healthline.com/nutrition/caffeine-tolerance">https://www.healthline.com/nutrition/caffeine-tolerance</a></li>
  <li><a href="https://www.apa.org/gradpsych/2015/11/coffee">https://www.apa.org/gradpsych/2015/11/coffee</a></li>
  <li><a href="https://www.healthline.com/nutrition/caffeine-side-effects">https://www.healthline.com/nutrition/caffeine-side-effects</a></li>
  <li><a href="https://www.aarp.org/health/healthy-living/info-10-2013/coffee-for-health.html">https://www.aarp.org/health/healthy-living/info-10-2013/coffee-for-health.html</a></li>
  <li><a href="https://unsplash.com/photos/6VhPY27jdps?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink">https://unsplash.com/photos/6VhPY27jdps?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink</a></li>
  <li><a href="https://www.healthline.com/nutrition/caffeine-in-decaf">https://www.healthline.com/nutrition/caffeine-in-decaf</a></li>
  <li><a href="https://en.wikipedia.org/wiki/History\_of\_coffee">https://en.wikipedia.org/wiki/History_of_coffee</a></li>
  <li><a href="https://www.npr.org/sections/thesalt/2017/04/06/522071853/in-wwi-trenches-instant-coffee-gave-troops-a-much-needed-boost">https://www.npr.org/sections/thesalt/2017/04/06/522071853/in-wwi-trenches-instant-coffee-gave-troops-a-much-needed-boost</a></li>
  <li><a href="https://www.history.com/this-day-in-history/coffee-rationing-begins">https://www.history.com/this-day-in-history/coffee-rationing-begins</a></li>
  <li><a href="https://www.wearethemighty.com/articles/brief-history-coffee-field/">https://www.wearethemighty.com/articles/brief-history-coffee-field/</a></li>
  <li><a href="https://www.historic-uk.com/CultureUK/English-Coffeehouses-Penny-Universities/">https://www.historic-uk.com/CultureUK/English-Coffeehouses-Penny-Universities/</a></li>
</ol>]]></content><author><name>James</name></author><category term="coffee" /><category term="history" /><category term="coffee" /><summary type="html"><![CDATA[Initially, I planned to write about my findings after reverse-engineering some RPG Maker XP, VX, VX Ace, MV and Wolf Editor games (which is not illegal as long as I’m not creating a copy or changing the artifact in any way according to Wikipedia, which is definitely the best source of legal advice. But seriously though, I’m doing it for educational purpose and nothing else.). However, whenever life gives you lemons, you sigh ugh and wait for a better fruit.]]></summary></entry><entry><title type="html">AutoLockdown</title><link href="https://codingindex.xyz/2021/04/25/autolockdown/" rel="alternate" type="text/html" title="AutoLockdown" /><published>2021-04-25T09:22:00+00:00</published><updated>2021-04-25T09:22:00+00:00</updated><id>https://codingindex.xyz/2021/04/25/autolockdown</id><content type="html" xml:base="https://codingindex.xyz/2021/04/25/autolockdown/"><![CDATA[<p>Over the weekend, I got a new phone. The phone was capable of many things that I never had access to - but fingerprint sensing wasn’t one of them.</p>

<p>It should come as no surprise to some of you that I avoid biometric authentication religiously: this is because the attack vectors are so simple, that it renders the purpose of authentication useless. Here are some reasons why:</p>

<ol>
  <li>It is easy to uncover a fingerprint from the surfaces of your phone to be used as moulding to unlock your phone;</li>
  <li>You can be unconscious when your (physical) finger is being used to unlock your phone;</li>
  <li>Should the manufacturer of the fingerprint sensor be untrustworthy, your fingerprint data could be stolen; you only have one fingerprint for your entire life, and it is not changeable.</li>
</ol>

<p>Therefore, I have been using a 14 character password to protect access to my phone for the past three years.</p>

<h1 id="reality">Reality</h1>

<p>In life, there cannot be too much of a good thing; when you are pressed for time, you need to get work done as quickly as possible. Typing a 14 character password might not sound like a time-consuming process on the surface, but one must account for accidental human errors when keying in the password.</p>

<p>Furthermore, with how frequent we unlock our phones during active use, the time taken to unlock the phone accumulates to many hours of frustration, and triggers impatient superiors to no end.</p>

<p>Of course, it is out of the question to simply forgo the use of a locking mechanism - what about all the precious data, banking applications and confidential company documents that you’re storing?</p>

<p>Hence, in conclusion, a quick, yet secure method of authentication has a need to exist.</p>

<h2 id="evaluation">Evaluation</h2>

<p>Let’s evaluate the pros and cons of fingerprint authentication, alongside password authentication one more time.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Feature</th>
      <th style="text-align: center">Password</th>
      <th style="text-align: center">Fingerprint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Fast to unlock</td>
      <td style="text-align: center">No</td>
      <td style="text-align: center"><strong>Yes</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">Secure</td>
      <td style="text-align: center">Following guidelines, <strong>Yes</strong></td>
      <td style="text-align: center">No</td>
    </tr>
    <tr>
      <td style="text-align: center">Changeable</td>
      <td style="text-align: center"><strong>Yes</strong></td>
      <td style="text-align: center">No</td>
    </tr>
    <tr>
      <td style="text-align: center">Lots of apps use it</td>
      <td style="text-align: center">No</td>
      <td style="text-align: center"><strong>Yes</strong></td>
    </tr>
  </tbody>
</table>

<p>Many banking apps, and some password managers use fingerprint authentication as a way to quickly unlock an account. As long as you are conscious while you are doing it, such a feature does not sound too bad; after all, it is comparatively safer than typing a 6 digit numerical pin (banking apps) or a 3 alphanumerical pin (KeepassXC for Android) in the public under the prying eyes of many, to quickly unlock your most precious resources.</p>

<p>To solve our dilemma, why not have both fingerprint and password?</p>

<h1 id="android-feature-lockdown-mode">Android Feature: Lockdown Mode</h1>

<p>In Android 9 (Pie), there exist a feature known as <code class="language-plaintext highlighter-rouge">Lockdown Mode</code>. In this mode, “Smart Lock” features are disabled, biometric authentication is disabled, and notifications no longer show. Users who wish to turn on Lockdown Mode can do it through the power menu, after the feature is enabled.</p>

<p>To learn what is Lockdown Mode, and how to enable it for your phone, visit <a href="https://screenrant.com/android-lockdown-mode-purpose-enable-how-explained/">this screenrant link</a>.</p>

<p>Having discovered Lockdown Mode, I gave in to the temptations of the fingerprint, and registered my own biometrics. However, I found that turning on Lockdown Mode is too user-dependent, meaning that there might be times where I am too fatigued to turn on the mode to protect my phone. Hence, I tried automating the process.</p>

<h1 id="automation">Automation</h1>

<p>I downloaded <a href="https://play.google.com/store/apps/details?id=com.llamalab.automate">Automate</a> and <a href="https://play.google.com/store/apps/details?id=com.radefffactory.lockdown">this nifty app</a> that provides shortcuts to enable Lockdown mode, and linked it up such that whenever I turn off the screen, a 5 minute timer will go off, which will launch the second app to enable Lockdown mode.</p>

<p>5 minutes is an arbitrarily decided duration - I felt that as long as I tried unlocking my phone again within 5 minutes, a fingerprint would be acceptable. While this does not guarantee the safety of my data if I were to be suddenly robbed, I felt that it would “good enough” to prevent my data from being accessed in my sleep by a sneaky adversary.</p>

<p>While it worked well, the whole setup was clunky and cumbersome; furthermore, I felt like it was too overkill. Having used Tasker and Automate before, I knew that battery consumption might become an issue.</p>

<h1 id="the-creation-of-autolockdown">The creation of AutoLockdown</h1>

<p>Hence, to solve all of these problems in one fell swoop, I decided to make an app. The <a href="https://github.com/jameshi16/AutoLockdown">repository</a> can be found on GitHub; essentially, the phone automatically removes biometric authentication as a possible authentication method after a user-configuration period of time.</p>

<p>In the future, I hope to also add scheduling; so, apart from removing biometric authentication after a set duration, it will be removed during, say, bedtime, as well.</p>

<h1 id="conclusion">Conclusion</h1>

<p>If you were in the same dilemma as me, I hope you find <a href="https://github.com/jameshi16/AutoLockdown">AutoLockdown</a> satisfactory; otherwise, go ahead and give me some feedback through <a target="_blank" href="mailto:me@codingindex.xyz">my email</a>!</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="release" /><category term="android" /><category term="app" /><category term="android" /><summary type="html"><![CDATA[Over the weekend, I got a new phone. The phone was capable of many things that I never had access to - but fingerprint sensing wasn’t one of them.]]></summary></entry><entry><title type="html">TOTP from scratch</title><link href="https://codingindex.xyz/2021/03/07/totp-from-scratch/" rel="alternate" type="text/html" title="TOTP from scratch" /><published>2021-03-07T10:54:00+00:00</published><updated>2021-03-07T10:54:00+00:00</updated><id>https://codingindex.xyz/2021/03/07/totp-from-scratch</id><content type="html" xml:base="https://codingindex.xyz/2021/03/07/totp-from-scratch/"><![CDATA[<p>“How do One-Time Passwords (OTP) work?” I asked myself, as I fiddled with my digital banking token to check my non-existent wealth online.</p>

<p>Is there some kind of magic communicating protocol and hardware that I didn’t know of? Perhaps GSM is being used in these banking tokens, or mobile data is being used in my <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2">Google Authenticator</a> app?</p>

<p>Well, of course not. Firstly, hardware tokens need to be low-power and durable; radio communication isn’t exactly the best thing to fit those criteria. Secondly, it would be ridiculous to spend mobile data for a 6 to 8 digit pin. Some <a href="https://www.freecodecamp.org/news/how-time-based-one-time-passwords-work-and-why-you-should-use-them-in-your-app-fdd2b9ed43c3/">quick preliminary research</a> shows that OTPs are generated offline, via a pre-shared key known to both the verifier (i.e. the entity that needs to know it’s you) and the generator (i.e. you).</p>

<p>Naturally, the next question to ask is: “How?”</p>

<p>And, as commonsensical as dunking a donut into beer, I decided to understand and implement Time-based OTP (TOTP) and its components from scratch. The aftermath of this disaster can be found <a href="https://github.com/jameshi16/Bad-TOTP">on my GitHub repository</a>, which comes with GitHub Actions powered tests because I like torturing myself.</p>

<h1 id="table-of-contents">Table Of Contents</h1>

<ol>
<li><a href="#hashes">Hashes</a>
<ul>
<li><a href="#sha-1">SHA1</a></li>
<li><a href="#sha256">SHA256</a></li>
<li><a href="#sha512">SHA512</a></li>
</ul>
</li>
<li><a href="#hmac">HMAC</a></li>
<li><a href="#hotp">HOTP</a></li>
<li><a href="#totp">TOTP</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ol>

<h1 id="hashes">Hashes</h1>

<p>TOTP, or lesser known as <a href="https://tools.ietf.org/html/rfc6238">RFC 6238</a>, is a simple algorithm built on the already existing counter-based OTP algorithm, Hash-Message-Authenticator-Code-based OTP (HOTP). As the name suggests, HOTP uses hashes; in <a href="https://tools.ietf.org/html/rfc4226">RFC 4226</a>, the preferred hashes belong to the SHA family, specifically SHA1.</p>

<p>If you’ve dabbled with hashes, you would know that alongside <a href="/2020/12/05/i-implemented-aes-and-md5/#md5">MD5</a>, SHA-1 is known to be <a href="https://duo.com/decipher/sha-1-fully-and-practically-broken-by-new-collision">“broken”</a>; two PDFs of differing content has colliding SHA-1 functions according to <a href="https://duo.com/decipher/sha-1-fully-and-practically-broken-by-new-collision">an article on ComputerWorld</a>. An alternative interpretation is that SHA-1 is no longer cryptographically safe. However, most of the internet still uses SHA-1 to generate OTPs; while practically infeasible to impersonate, it is nevertheless still a concern for the paranoid.</p>

<p>To ease my mind a little, I also decided to implement SHA-256 and SHA-512 as “drop-in” replacements for SHA-1 when it comes to OTP generation. Hence, this blog post will describe the implementation of SHA-1, SHA-256, and SHA-512.</p>

<h2 id="sha-1">SHA-1</h2>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>Implementing SHA-1 was similar to implementing <a href="/2020/12/05/i-implemented-aes-and-md5/#md5">MD5</a>; although, I ran into some problems specific to the width of <code class="language-plaintext highlighter-rouge">uint_fast*_t</code> types. In a nutshell, don’t use those types - they likely have larger widths which may mess up the hash on a careless programmer’s code (i.e. me).</p>

<p>Before we begin, let’s define a few things:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">WORD</code> is a 32-bit string (== 4 bytes) that can be represented as a sequence of 8 hex digits; in C, this is <code class="language-plaintext highlighter-rouge">uint32_t</code>,</li>
  <li>Everything in SHA-1 is processed in blocks of 512-bits, which is 16 words or 64 bytes,</li>
  <li>Everything in the SHA family should be expressed in Big Endian byte order; furthermore, platform-agnostic endianness should be enforced.</li>
</ul>

<p>In <a href="https://tools.ietf.org/html/rfc3174#section-5">RFC 3174 section 5</a>, some functions are defined for use by SHA-1. In C, they are implemented like so:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SHA1_WORD</span> <span class="nf">sha1_f</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">t</span><span class="p">,</span> <span class="n">SHA1_WORD</span> <span class="n">B</span><span class="p">,</span> <span class="n">SHA1_WORD</span> <span class="n">C</span><span class="p">,</span> <span class="n">SHA1_WORD</span> <span class="n">D</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">B</span> <span class="o">&amp;</span> <span class="n">C</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">39</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">B</span> <span class="o">^</span> <span class="n">C</span> <span class="o">^</span> <span class="n">D</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">59</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">B</span> <span class="o">&amp;</span> <span class="n">C</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">B</span> <span class="o">&amp;</span> <span class="n">D</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span> <span class="o">&amp;</span> <span class="n">D</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">79</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">B</span> <span class="o">^</span> <span class="n">C</span> <span class="o">^</span> <span class="n">D</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// impossible case</span>
<span class="p">}</span>

<span class="n">SHA1_WORD</span> <span class="nf">sha1_K</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mh">0x5A827999</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">39</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mh">0x6ED9EBA1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">59</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mh">0x8F1BBCDC</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mh">0xCA62C1D6</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// impossible case</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The hex digits are copied from the RFC, although it is likely that these are fractional components of the square root of some prime number. Another commonly used function, Shift &amp; Rotate Left should also be defined:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SHA1_WORD</span> <span class="nf">sha1_Sn</span><span class="p">(</span><span class="n">SHA1_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>SHA-1 uses a form of metadata encoding to pad blocks; all blocks must be padded with this metadata no matter its size. Should the addition of the padding exceed the block size, a new block is created. Padding in SHA-1 follows these rules:</p>

<ol>
  <li>Append a bit ‘1’ to the end of the string;</li>
  <li>Append zeros until the following equation is satisfied: <code class="language-plaintext highlighter-rouge">(bitLengthOfMessage + 1 + X) % 512 == 448</code>, where <code class="language-plaintext highlighter-rouge">bitLengthOfMessage</code> is the bit length of the original message, and <code class="language-plaintext highlighter-rouge">X</code> is the number of zeros to append at the end of the message.</li>
</ol>

<p>The following code pads the message, assuming that all the data are aligned nicely to their bytes:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">sha1_pad</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">toPad</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">64</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">toPad</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// spillover</span>
    <span class="n">toPad</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">newArr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">newArr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">newArr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// -8 for 2 words at the back</span>

  <span class="cm">/*
   * This code relies too much on the endianess of the system, so we won't be using it
   * uint64_t* ref = (uint64_t*) (newArr + size + toPad - 8);
   * ref = size * 8;
   */</span>

  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">sizeInBits</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">newArr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that towards the end of the function, a platform-agnostic way of maintaining the big-endian byte order is used.</p>

<p>With all of the pre-requisites in place, the main hashing process can now be done. RFC 3174 gave two different methods to accomplish this; both are essentially the same, except that the second method uses an intelligent way to access data if the underlying message is stored as an array of <code class="language-plaintext highlighter-rouge">WORDs</code>. For the purpose of clarity, only the first method will be explained in this blog post. The SHA-1 algorithm does the following:</p>

<ol>
  <li>Define magic numbers <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h4</code> with values stated in RFC 3174;</li>
  <li>Pad the message using <code class="language-plaintext highlighter-rouge">sha1_pad</code>;</li>
  <li>Split the message into blocks of 512-bits;</li>
  <li>Create a working buffer of 80 WORDS;</li>
  <li>Copy the contents of the 64-byte block into the working buffer (i.e. copy 16 WORDS), using a platform-agnostic way to maintain Big Endianness;</li>
  <li>Generate the values of the remaining words with an algorithm specified in RFC 3174;</li>
  <li>Calculate the intermediary hash;</li>
  <li>Copy the digest back into <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h4</code>.</li>
  <li>When all blocks are processed, return <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h4</code> as an array of bytes, maintaining the Big Endian byte order.</li>
</ol>

<p>Normally, hashing algorithms are implemented with <em>streams</em> in mind, meaning that blocks of data are fed to the algorithm before being finalized into a hash. Given that TOTP would have all the data it needs on-demand, I figured it was not necessary to worry about streaming, instead building a single function to hash the whole message.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">method_one</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SHA1_WORD</span> <span class="n">h0</span> <span class="o">=</span> <span class="mh">0x67452301</span><span class="p">;</span>
  <span class="n">SHA1_WORD</span> <span class="n">h1</span> <span class="o">=</span> <span class="mh">0xefcdab89</span><span class="p">;</span>
  <span class="n">SHA1_WORD</span> <span class="n">h2</span> <span class="o">=</span> <span class="mh">0x98badcfe</span><span class="p">;</span>
  <span class="n">SHA1_WORD</span> <span class="n">h3</span> <span class="o">=</span> <span class="mh">0x10325476</span><span class="p">;</span>
  <span class="n">SHA1_WORD</span> <span class="n">h4</span> <span class="o">=</span> <span class="mh">0xc3d2e1f0</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">h0</code>, <code class="language-plaintext highlighter-rouge">h1</code>, <code class="language-plaintext highlighter-rouge">h3</code>, and <code class="language-plaintext highlighter-rouge">h4</code> are magic initial numbers used by the algorithm; they will be changed later on as the hash digests the data. I am not a security expert, but I gather that these numbers <em>could be</em> anything - perhaps you can make your own variant of SHA-1 just by changing these numbers.</p>

<p>Pad the message carefully.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">size_t</span> <span class="n">messageSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sha1_pad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">messageSize</span><span class="p">);</span>
</code></pre></div></div>

<p>Processing the message block by block, we define a temporary buffer, <code class="language-plaintext highlighter-rouge">W</code>, with the size of 80 WORDS to store data that would later become a hash digest. Then, the first 64 bytes (i.e. 16 WORDS) would be copied into <code class="language-plaintext highlighter-rouge">W</code>, with the endian maintained through a platform-agnostic method.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">messageSize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">block</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">W</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Fill the rest of <code class="language-plaintext highlighter-rouge">W</code> with a method specified in RFC 3174. This step, is the only line that differs between <code class="language-plaintext highlighter-rouge">method_one</code> and <code class="language-plaintext highlighter-rouge">method_two</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span>  <span class="n">sha1_Sn</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">^</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">14</span><span class="p">]</span> <span class="o">^</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">16</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>With all the data filled into <code class="language-plaintext highlighter-rouge">W</code>, compute the hash by digesting every WORD in <code class="language-plaintext highlighter-rouge">W</code> with the above algorithm. This part will be referred to as “the main hashing process” for the remainder of this blog post.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">SHA1_WORD</span> <span class="n">A</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">B</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">C</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">D</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">E</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>
    <span class="n">SHA1_WORD</span> <span class="n">TEMP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">TEMP</span> <span class="o">=</span> <span class="n">sha1_Sn</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha1_f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="o">+</span> <span class="n">E</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">sha1_K</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
      <span class="n">E</span> <span class="o">=</span> <span class="n">D</span><span class="p">;</span>
      <span class="n">D</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
      <span class="n">C</span> <span class="o">=</span> <span class="n">sha1_Sn</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
      <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
      <span class="n">A</span> <span class="o">=</span> <span class="n">TEMP</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Add the intermediary variables back into <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h4</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">h0</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
    <span class="n">h1</span> <span class="o">+=</span> <span class="n">B</span><span class="p">;</span>
    <span class="n">h2</span> <span class="o">+=</span> <span class="n">C</span><span class="p">;</span>
    <span class="n">h3</span> <span class="o">+=</span> <span class="n">D</span><span class="p">;</span>
    <span class="n">h4</span> <span class="o">+=</span> <span class="n">E</span><span class="p">;</span>
  <span class="err">}</span>
</code></pre></div></div>

<p>SHA-1 returns a 160-bit string (i.e. 20 bytes) as a hash result. After taking care of memory management, copy the data from <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h4</code> in a platform-agnostic way to preserve Big Endianness. Return the result, and call it a day.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">free</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
  <span class="n">SHA1_WORD</span><span class="o">*</span> <span class="n">retValView</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHA1_WORD</span><span class="o">*</span><span class="p">)</span> <span class="n">retVal</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SHA1_WORD</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">retValView</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
</code></pre></div></div>

<p>The full code to compute SHA-1 can be found <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/sha1.h">in my GitHub repository</a>; the file is project-independent, so you can drop it into your codebase. Do note that nothing within the repository is production-ready, since roll-your-own-crypto is a bad idea. Use libraries such as <code class="language-plaintext highlighter-rouge">openssl</code> or <code class="language-plaintext highlighter-rouge">libressl</code>.</p>

<p>In theory, SHA-1 is all you need for modern TOTP, especially with the use of <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format#algorithm">Google Authenticator</a>, since, at the time of writing, the <code class="language-plaintext highlighter-rouge">algorithm</code> parameter that specifies the hashing algorithm is ignored by Google Authenticator.</p>

<h2 id="sha-256-optional"><span id="sha256">SHA-256 (Optional)</span></h2>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>SHA-256 and SHA-1 defers by the magic values used in <code class="language-plaintext highlighter-rouge">K</code>, the binary operations used for the hash, and the main hashing process. Furthermore, SHA-256 has a 256-bit output (32 bytes). The padding method is still the same as defined in SHA-1.</p>

<p><code class="language-plaintext highlighter-rouge">K</code>, the magic values, is defined with an array tackling 64 WORDS in SHA-256 rather than 4 magic values over 80 WORDS in SHA-1:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">SHA2_WORD</span> <span class="n">SHA2_K</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x428a2f98</span><span class="p">,</span> <span class="mh">0x71374491</span><span class="p">,</span> <span class="mh">0xb5c0fbcf</span><span class="p">,</span> <span class="mh">0xe9b5dba5</span><span class="p">,</span>
  <span class="mh">0x3956c25b</span><span class="p">,</span> <span class="mh">0x59f111f1</span><span class="p">,</span> <span class="mh">0x923f82a4</span><span class="p">,</span> <span class="mh">0xab1c5ed5</span><span class="p">,</span>
  <span class="mh">0xd807aa98</span><span class="p">,</span> <span class="mh">0x12835b01</span><span class="p">,</span> <span class="mh">0x243185be</span><span class="p">,</span> <span class="mh">0x550c7dc3</span><span class="p">,</span>
  <span class="mh">0x72be5d74</span><span class="p">,</span> <span class="mh">0x80deb1fe</span><span class="p">,</span> <span class="mh">0x9bdc06a7</span><span class="p">,</span> <span class="mh">0xc19bf174</span><span class="p">,</span>
  <span class="mh">0xe49b69c1</span><span class="p">,</span> <span class="mh">0xefbe4786</span><span class="p">,</span> <span class="mh">0x0fc19dc6</span><span class="p">,</span> <span class="mh">0x240ca1cc</span><span class="p">,</span>
  <span class="mh">0x2de92c6f</span><span class="p">,</span> <span class="mh">0x4a7484aa</span><span class="p">,</span> <span class="mh">0x5cb0a9dc</span><span class="p">,</span> <span class="mh">0x76f988da</span><span class="p">,</span>
  <span class="mh">0x983e5152</span><span class="p">,</span> <span class="mh">0xa831c66d</span><span class="p">,</span> <span class="mh">0xb00327c8</span><span class="p">,</span> <span class="mh">0xbf597fc7</span><span class="p">,</span>
  <span class="mh">0xc6e00bf3</span><span class="p">,</span> <span class="mh">0xd5a79147</span><span class="p">,</span> <span class="mh">0x06ca6351</span><span class="p">,</span> <span class="mh">0x14292967</span><span class="p">,</span>
  <span class="mh">0x27b70a85</span><span class="p">,</span> <span class="mh">0x2e1b2138</span><span class="p">,</span> <span class="mh">0x4d2c6dfc</span><span class="p">,</span> <span class="mh">0x53380d13</span><span class="p">,</span>
  <span class="mh">0x650a7354</span><span class="p">,</span> <span class="mh">0x766a0abb</span><span class="p">,</span> <span class="mh">0x81c2c92e</span><span class="p">,</span> <span class="mh">0x92722c85</span><span class="p">,</span>
  <span class="mh">0xa2bfe8a1</span><span class="p">,</span> <span class="mh">0xa81a664b</span><span class="p">,</span> <span class="mh">0xc24b8b70</span><span class="p">,</span> <span class="mh">0xc76c51a3</span><span class="p">,</span>
  <span class="mh">0xd192e819</span><span class="p">,</span> <span class="mh">0xd6990624</span><span class="p">,</span> <span class="mh">0xf40e3585</span><span class="p">,</span> <span class="mh">0x106aa070</span><span class="p">,</span>
  <span class="mh">0x19a4c116</span><span class="p">,</span> <span class="mh">0x1e376c08</span><span class="p">,</span> <span class="mh">0x2748774c</span><span class="p">,</span> <span class="mh">0x34b0bcb5</span><span class="p">,</span>
  <span class="mh">0x391c0cb3</span><span class="p">,</span> <span class="mh">0x4ed8aa4a</span><span class="p">,</span> <span class="mh">0x5b9cca4f</span><span class="p">,</span> <span class="mh">0x682e6ff3</span><span class="p">,</span>
  <span class="mh">0x748f82ee</span><span class="p">,</span> <span class="mh">0x78a5636f</span><span class="p">,</span> <span class="mh">0x84c87814</span><span class="p">,</span> <span class="mh">0x8cc70208</span><span class="p">,</span>
  <span class="mh">0x90befffa</span><span class="p">,</span> <span class="mh">0xa4506ceb</span><span class="p">,</span> <span class="mh">0xbef9a3f7</span><span class="p">,</span> <span class="mh">0xc67178f2</span>
<span class="p">};</span>
</code></pre></div></div>

<p>According to <a href="https://tools.ietf.org/html/rfc6234#page-11">RFC 6234</a>, these constants represent “the first 32 bits of the fractional parts of the cube roots of the first sixty-four prime numbers”.</p>

<p>The binary operations are defined with the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SHA2_WORD</span> <span class="nf">sha2_ROTR</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_CH</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="n">SHA2_WORD</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SHA2_WORD</span> <span class="n">Z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Y</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="o">~</span><span class="n">X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_MAJ</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="n">SHA2_WORD</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SHA2_WORD</span> <span class="n">Z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Y</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">Y</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_BSIG0</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_BSIG1</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_SSIG0</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA2_WORD</span> <span class="nf">sha2_SSIG1</span><span class="p">(</span><span class="n">SHA2_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha2_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ROTR</code> stands for right shift. I have no idea what the other abbreviations mean.</p>

<p>Padding in SHA-256 is the same as that in SHA-1:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">sha2_pad</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">toPad</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">64</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">toPad</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">toPad</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">newArr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">newArr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">newArr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">sizeInBits</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizeInBits</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">newArr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The pre-requisites are done. For the SHA-256, 8 WORDS (256-bits) will be returned as the final hash; hence, 8 variables will be used to represent the working variables to compute the hash:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">sha256</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SHA2_WORD</span> <span class="n">h0</span> <span class="o">=</span> <span class="mh">0x6a09e667</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h1</span> <span class="o">=</span> <span class="mh">0xbb67ae85</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h2</span> <span class="o">=</span> <span class="mh">0x3c6ef372</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h3</span> <span class="o">=</span> <span class="mh">0xa54ff53a</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h4</span> <span class="o">=</span> <span class="mh">0x510e527f</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h5</span> <span class="o">=</span> <span class="mh">0x9b05688c</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h6</span> <span class="o">=</span> <span class="mh">0x1f83d9ab</span><span class="p">;</span>
  <span class="n">SHA2_WORD</span> <span class="n">h7</span> <span class="o">=</span> <span class="mh">0x5be0cd19</span><span class="p">;</span>
</code></pre></div></div>

<p>Unlike SHA-1, these numbers aren’t as nice looking - in fact, they are “the first 32 bits of the fractional parts of the square roots of the first eight prime numbers” according to <a href="https://tools.ietf.org/html/rfc6234#page-13">the RFC</a>. Hence, to make your own variant of SHA-256, you should look for the fractional parts of some other eight prime numbers.</p>

<p>Pad the message.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">size_t</span> <span class="n">messageSize</span><span class="p">;</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sha2_pad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">messageSize</span><span class="p">);</span>
</code></pre></div></div>

<p>Copy the 64 bytes in the block into the first 16 words of the temporary buffer, <code class="language-plaintext highlighter-rouge">W</code>, using a platform-agnostic way to preserve big endianness.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">messageSize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">block</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">W</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Calculate the rest of the WORDS in <code class="language-plaintext highlighter-rouge">W</code> with the algorithm specified in <a href="https://tools.ietf.org/html/rfc6234#page-13">RFC 6234</a>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha2_SSIG1</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">sha2_SSIG0</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">15</span><span class="p">])</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">16</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>SHA-256 uses two temporary buffers alongside the intermediary variables A to H. The outline of the algorithm is also described in the RFC, and so the code here is just the “translated” version.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">SHA2_WORD</span> <span class="n">A</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">B</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">C</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">D</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">E</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">F</span> <span class="o">=</span> <span class="n">h5</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">G</span> <span class="o">=</span> <span class="n">h6</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">H</span> <span class="o">=</span> <span class="n">h7</span><span class="p">;</span>
    <span class="n">SHA2_WORD</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">T1</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">sha2_BSIG1</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha2_CH</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">+</span> <span class="n">SHA2_K</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">];</span>
      <span class="n">T2</span> <span class="o">=</span> <span class="n">sha2_BSIG0</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha2_MAJ</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span>
      <span class="n">H</span> <span class="o">=</span> <span class="n">G</span><span class="p">;</span>
      <span class="n">G</span> <span class="o">=</span> <span class="n">F</span><span class="p">;</span>
      <span class="n">F</span> <span class="o">=</span> <span class="n">E</span><span class="p">;</span>
      <span class="n">E</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">T1</span><span class="p">;</span>
      <span class="n">D</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
      <span class="n">C</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
      <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
      <span class="n">A</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">+</span> <span class="n">T2</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>As per usual with normal digest algorithms, we add the intermediary values back to <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h7</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">h0</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
    <span class="n">h1</span> <span class="o">+=</span> <span class="n">B</span><span class="p">;</span>
    <span class="n">h2</span> <span class="o">+=</span> <span class="n">C</span><span class="p">;</span>
    <span class="n">h3</span> <span class="o">+=</span> <span class="n">D</span><span class="p">;</span>
    <span class="n">h4</span> <span class="o">+=</span> <span class="n">E</span><span class="p">;</span>
    <span class="n">h5</span> <span class="o">+=</span> <span class="n">F</span><span class="p">;</span>
    <span class="n">h6</span> <span class="o">+=</span> <span class="n">G</span><span class="p">;</span>
    <span class="n">h7</span> <span class="o">+=</span> <span class="n">H</span><span class="p">;</span>
  <span class="err">}</span>
</code></pre></div></div>

<p>While a little more inefficient, I decided to use a for-loop over writing 64 lines of code to convert <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h7</code> into a byte array. A faster implementation would be to write all 64 lines, so that the compiler doesn’t generate <code class="language-plaintext highlighter-rouge">JMP</code> instructions which is usually slower to execute.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">free</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
  <span class="n">SHA2_WORD</span><span class="o">*</span> <span class="n">retValView</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHA2_WORD</span><span class="o">*</span><span class="p">)</span> <span class="n">retVal</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">h6</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">h7</span><span class="p">;</span>

  <span class="c1">// platform agnostic big-endian</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SHA2_WORD</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">retValView</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span> 
<span class="err">}</span>
</code></pre></div></div>

<p>The code is <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/sha256.h">available on my GitHub repository</a>.</p>

<h1 id="sha-512-optional"><span id="sha512">SHA-512 (Optional)</span></h1>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>In SHA-512, the function return a 512-bit string based on 1024-bit blocks of data. SHA-512 also uses 64-bit words, which means that we have to use <code class="language-plaintext highlighter-rouge">uint64_t</code> over <code class="language-plaintext highlighter-rouge">uint32_t</code>.</p>

<p>From <a href="https://tools.ietf.org/html/rfc6234#page-11">RFC 6234</a>, the magic number array, <code class="language-plaintext highlighter-rouge">K</code>, is defined as:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">SHA512_WORD</span> <span class="n">sha512_K</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x428a2f98d728ae22</span><span class="p">,</span> <span class="mh">0x7137449123ef65cd</span><span class="p">,</span> <span class="mh">0xb5c0fbcfec4d3b2f</span><span class="p">,</span> <span class="mh">0xe9b5dba58189dbbc</span><span class="p">,</span>
  <span class="mh">0x3956c25bf348b538</span><span class="p">,</span> <span class="mh">0x59f111f1b605d019</span><span class="p">,</span> <span class="mh">0x923f82a4af194f9b</span><span class="p">,</span> <span class="mh">0xab1c5ed5da6d8118</span><span class="p">,</span>
  <span class="mh">0xd807aa98a3030242</span><span class="p">,</span> <span class="mh">0x12835b0145706fbe</span><span class="p">,</span> <span class="mh">0x243185be4ee4b28c</span><span class="p">,</span> <span class="mh">0x550c7dc3d5ffb4e2</span><span class="p">,</span>
  <span class="mh">0x72be5d74f27b896f</span><span class="p">,</span> <span class="mh">0x80deb1fe3b1696b1</span><span class="p">,</span> <span class="mh">0x9bdc06a725c71235</span><span class="p">,</span> <span class="mh">0xc19bf174cf692694</span><span class="p">,</span>
  <span class="mh">0xe49b69c19ef14ad2</span><span class="p">,</span> <span class="mh">0xefbe4786384f25e3</span><span class="p">,</span> <span class="mh">0x0fc19dc68b8cd5b5</span><span class="p">,</span> <span class="mh">0x240ca1cc77ac9c65</span><span class="p">,</span>
  <span class="mh">0x2de92c6f592b0275</span><span class="p">,</span> <span class="mh">0x4a7484aa6ea6e483</span><span class="p">,</span> <span class="mh">0x5cb0a9dcbd41fbd4</span><span class="p">,</span> <span class="mh">0x76f988da831153b5</span><span class="p">,</span>
  <span class="mh">0x983e5152ee66dfab</span><span class="p">,</span> <span class="mh">0xa831c66d2db43210</span><span class="p">,</span> <span class="mh">0xb00327c898fb213f</span><span class="p">,</span> <span class="mh">0xbf597fc7beef0ee4</span><span class="p">,</span>
  <span class="mh">0xc6e00bf33da88fc2</span><span class="p">,</span> <span class="mh">0xd5a79147930aa725</span><span class="p">,</span> <span class="mh">0x06ca6351e003826f</span><span class="p">,</span> <span class="mh">0x142929670a0e6e70</span><span class="p">,</span>
  <span class="mh">0x27b70a8546d22ffc</span><span class="p">,</span> <span class="mh">0x2e1b21385c26c926</span><span class="p">,</span> <span class="mh">0x4d2c6dfc5ac42aed</span><span class="p">,</span> <span class="mh">0x53380d139d95b3df</span><span class="p">,</span>
  <span class="mh">0x650a73548baf63de</span><span class="p">,</span> <span class="mh">0x766a0abb3c77b2a8</span><span class="p">,</span> <span class="mh">0x81c2c92e47edaee6</span><span class="p">,</span> <span class="mh">0x92722c851482353b</span><span class="p">,</span>
  <span class="mh">0xa2bfe8a14cf10364</span><span class="p">,</span> <span class="mh">0xa81a664bbc423001</span><span class="p">,</span> <span class="mh">0xc24b8b70d0f89791</span><span class="p">,</span> <span class="mh">0xc76c51a30654be30</span><span class="p">,</span>
  <span class="mh">0xd192e819d6ef5218</span><span class="p">,</span> <span class="mh">0xd69906245565a910</span><span class="p">,</span> <span class="mh">0xf40e35855771202a</span><span class="p">,</span> <span class="mh">0x106aa07032bbd1b8</span><span class="p">,</span>
  <span class="mh">0x19a4c116b8d2d0c8</span><span class="p">,</span> <span class="mh">0x1e376c085141ab53</span><span class="p">,</span> <span class="mh">0x2748774cdf8eeb99</span><span class="p">,</span> <span class="mh">0x34b0bcb5e19b48a8</span><span class="p">,</span>
  <span class="mh">0x391c0cb3c5c95a63</span><span class="p">,</span> <span class="mh">0x4ed8aa4ae3418acb</span><span class="p">,</span> <span class="mh">0x5b9cca4f7763e373</span><span class="p">,</span> <span class="mh">0x682e6ff3d6b2b8a3</span><span class="p">,</span>
  <span class="mh">0x748f82ee5defb2fc</span><span class="p">,</span> <span class="mh">0x78a5636f43172f60</span><span class="p">,</span> <span class="mh">0x84c87814a1f0ab72</span><span class="p">,</span> <span class="mh">0x8cc702081a6439ec</span><span class="p">,</span>
  <span class="mh">0x90befffa23631e28</span><span class="p">,</span> <span class="mh">0xa4506cebde82bde9</span><span class="p">,</span> <span class="mh">0xbef9a3f7b2c67915</span><span class="p">,</span> <span class="mh">0xc67178f2e372532b</span><span class="p">,</span>
  <span class="mh">0xca273eceea26619c</span><span class="p">,</span> <span class="mh">0xd186b8c721c0c207</span><span class="p">,</span> <span class="mh">0xeada7dd6cde0eb1e</span><span class="p">,</span> <span class="mh">0xf57d4f7fee6ed178</span><span class="p">,</span>
  <span class="mh">0x06f067aa72176fba</span><span class="p">,</span> <span class="mh">0x0a637dc5a2c898a6</span><span class="p">,</span> <span class="mh">0x113f9804bef90dae</span><span class="p">,</span> <span class="mh">0x1b710b35131c471b</span><span class="p">,</span>
  <span class="mh">0x28db77f523047d84</span><span class="p">,</span> <span class="mh">0x32caab7b40c72493</span><span class="p">,</span> <span class="mh">0x3c9ebe0a15c9bebc</span><span class="p">,</span> <span class="mh">0x431d67c49c100d4c</span><span class="p">,</span>
  <span class="mh">0x4cc5d4becb3e42b6</span><span class="p">,</span> <span class="mh">0x597f299cfc657e2a</span><span class="p">,</span> <span class="mh">0x5fcb6fab3ad6faec</span><span class="p">,</span> <span class="mh">0x6c44198c4a475817</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Which are the same eighty prime numbers used in SHA-256, only with more digits representing the fractional parts of the cube roots.</p>

<p>The binary functions are also quite similar to that in <code class="language-plaintext highlighter-rouge">SHA-256</code>, with a few numbers tweaked for working with SHA-512’s comparatively massive WORD and block size:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SHA512_WORD</span> <span class="nf">sha512_ROTR</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_CH</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="n">SHA512_WORD</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SHA512_WORD</span> <span class="n">Z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Y</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="o">~</span><span class="n">X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_MAJ</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">,</span> <span class="n">SHA512_WORD</span> <span class="n">Y</span><span class="p">,</span> <span class="n">SHA512_WORD</span> <span class="n">Z</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Y</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">Y</span> <span class="o">&amp;</span> <span class="n">Z</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_BSIG0</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">39</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_BSIG1</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">41</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_SSIG0</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SHA512_WORD</span> <span class="nf">sha512_SSIG1</span><span class="p">(</span><span class="n">SHA512_WORD</span> <span class="n">X</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span> <span class="o">^</span> <span class="n">sha512_ROTR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">61</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The algorithm for padding is still the same as that in SHA-1, except that the numbers must be adjusted for SHA-512 due to the change in the block size. As a quick reference, 1024-bits is 128 bytes. This is evident below:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">sha512_pad</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">toPad</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">128</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">toPad</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">toPad</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">newArr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">newArr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">newArr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">lowerSizeInBits</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// whatever can be captured will be captured</span>
  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">upperSizeInBits</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">;</span> <span class="c1">// this is (size &gt;&gt; 64) * 8</span>

  <span class="k">const</span> <span class="kt">uintptr_t</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">upperSizeInBits</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">newArr</span><span class="p">[</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowerSizeInBits</span><span class="p">;</span> 

  <span class="k">if</span> <span class="p">(</span><span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">toPad</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">newArr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now with all that out of the way, let’s do the hashing process.</p>

<p>Like SHA-256, these numbers are extracted from the fractional parts of the first eight prime numbers, only with more digits representing the fraction.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">sha512</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SHA512_WORD</span> <span class="n">h0</span> <span class="o">=</span> <span class="mh">0x6a09e667f3bcc908</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h1</span> <span class="o">=</span> <span class="mh">0xbb67ae8584caa73b</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h2</span> <span class="o">=</span> <span class="mh">0x3c6ef372fe94f82b</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h3</span> <span class="o">=</span> <span class="mh">0xa54ff53a5f1d36f1</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h4</span> <span class="o">=</span> <span class="mh">0x510e527fade682d1</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h5</span> <span class="o">=</span> <span class="mh">0x9b05688c2b3e6c1f</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h6</span> <span class="o">=</span> <span class="mh">0x1f83d9abfb41bd6b</span><span class="p">;</span>
  <span class="n">SHA512_WORD</span> <span class="n">h7</span> <span class="o">=</span> <span class="mh">0x5be0cd19137e2179</span><span class="p">;</span>
</code></pre></div></div>

<p>Pad the message so that we have full 1024-bit blocks to work with.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">size_t</span> <span class="n">messageSize</span><span class="p">;</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="n">sha512_pad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">messageSize</span><span class="p">);</span>
</code></pre></div></div>

<p>Copy the message into a temporary 80-byte buffer, <code class="language-plaintext highlighter-rouge">W</code> with a platform-agnostic way of maintaining endianness. Because WORD sizes are 64-bits in SHA-512 instead of 32-bits in SHA-256, 8 bytes can fit within one WORD, which is why this block of code is 4 lines longer than that in the implementation of SHA-256.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">messageSize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">block</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">W</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="p">)</span> <span class="n">block</span><span class="p">[</span><span class="n">t</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Fill up the remaining data with the algorithm specified by the RFC, which should be almost identical to that of SHA-256.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha512_SSIG1</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">sha512_SSIG0</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">15</span><span class="p">])</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">16</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Main computation steps, which should be identical to that of SHA-256.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">SHA512_WORD</span> <span class="n">A</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">B</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">C</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">D</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">E</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">F</span> <span class="o">=</span> <span class="n">h5</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">G</span> <span class="o">=</span> <span class="n">h6</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">H</span> <span class="o">=</span> <span class="n">h7</span><span class="p">;</span>
    <span class="n">SHA512_WORD</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">T1</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">sha512_BSIG1</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha512_CH</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha512_K</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">t</span><span class="p">];</span>
      <span class="n">T2</span> <span class="o">=</span> <span class="n">sha512_BSIG0</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">sha512_MAJ</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span> 
      <span class="n">H</span> <span class="o">=</span> <span class="n">G</span><span class="p">;</span>
      <span class="n">G</span> <span class="o">=</span> <span class="n">F</span><span class="p">;</span>
      <span class="n">F</span> <span class="o">=</span> <span class="n">E</span><span class="p">;</span>
      <span class="n">E</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">T1</span><span class="p">;</span>
      <span class="n">D</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
      <span class="n">C</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
      <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
      <span class="n">A</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">+</span> <span class="n">T2</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Accumulate the intermediary variables into <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h7</code> as usual.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">h0</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
    <span class="n">h1</span> <span class="o">+=</span> <span class="n">B</span><span class="p">;</span>
    <span class="n">h2</span> <span class="o">+=</span> <span class="n">C</span><span class="p">;</span>
    <span class="n">h3</span> <span class="o">+=</span> <span class="n">D</span><span class="p">;</span>
    <span class="n">h4</span> <span class="o">+=</span> <span class="n">E</span><span class="p">;</span>
    <span class="n">h5</span> <span class="o">+=</span> <span class="n">F</span><span class="p">;</span>
    <span class="n">h6</span> <span class="o">+=</span> <span class="n">G</span><span class="p">;</span>
    <span class="n">h7</span> <span class="o">+=</span> <span class="n">H</span><span class="p">;</span>
  <span class="err">}</span>
</code></pre></div></div>

<p>Perform some memory management, and copy <code class="language-plaintext highlighter-rouge">h0</code> to <code class="language-plaintext highlighter-rouge">h7</code> in a platform-agnostic way to preserve big-endianness. The full code can be found <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/sha512.h">in my GitHub repository</a>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">free</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="n">SHA512_WORD</span><span class="o">*</span> <span class="n">retValView</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHA512_WORD</span><span class="o">*</span><span class="p">)</span> <span class="n">retVal</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h0</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">h1</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">h3</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">h4</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">h6</span><span class="p">;</span>
  <span class="n">retValView</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">h7</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SHA512_WORD</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">retValView</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">retVal</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<h1 id="hmac">HMAC</h1>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>At this point, a possible TOTP implementation might be to simply hash the current time with a symmetric key, truncate that hash, return 6 to 8 digits and call it a day. This is quite similar to the current modern-day implementation of OTP, albeit using internet standards that already exist.</p>

<p>While hashes are used to tell us about the <em>contents</em> of information in the form of a digest, Hash-based Message Authentication Codes (HMACs) are a way to check:</p>

<ol>
  <li>The authenticity (i.e. is the person sending the message who I expect it to be?) of the content;</li>
  <li>The integrity (i.e. has it been modified?) of the content.</li>
</ol>

<p>Lets say Bob wants to send a message to Alice, with HMAC as a way to verify and authenticate the message:</p>

<ol>
  <li>Bob and Alice exchange a shared secret, perhaps through the <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie-Hellman key exchange</a>, or going retro-style and exchanging it physically with paper and pen;</li>
  <li>Bob writes a message, uses a hash algorithm like SHA-256 and combines it with the shared secret in a manner described in <a href="https://tools.ietf.org/html/rfc2104">RFC 2104</a> to produce a HMAC;</li>
  <li>Bob sends the resulting message and HMAC to Alice, perhaps through two independent communication channels;</li>
  <li>Alice receives the message, uses a hash algorithm like SHA-256, combines it with the shared secret that was given to her in Step 1, and computes her own HMAC;</li>
  <li>Alice compares her HMAC to the HMAC generated by Bob;</li>
  <li>If the HMAC matches, she knows that the message was definitely written by Bob, <strong>and</strong> her message integrity is intact and not maliciously modified by a third party.</li>
</ol>

<p>From the above description, one can gather that HMACs have two components:</p>

<ol>
  <li>The hash function; and</li>
  <li>The shared key.</li>
</ol>

<p>In truth, while HMAC might be surrounded in mystery and seem like a difficult algorithm, it cannot get easier to implement:</p>

<p><img src="/images/20210307_1.png" style="max-width: 800px; width: 100%; margin: 0 auto; display: block;" alt="hash(key xor opad, hash(key xor ipad, text))" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">HMAC algorithm | Source: <a href="https://tools.ietf.org/html/rfc2104">RFC 2104</a></p>

<p>Moreover, the padding for the key is dead-simple: append <code class="language-plaintext highlighter-rouge">0x00</code> until the key equals the block size of the hashing algorithm. RFC 2104 is a very ancient RFC, and hence only mentions MD5 and SHA-1 as possible hashing algorithms; in truth, any modern-day hashing algorithms can be used.</p>

<p>Without further ado, here is the code for padding:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">hmac_pad</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blockSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">blockSize</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">retVal</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">retVal</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">blockSize</span> <span class="o">-</span> <span class="n">size</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As for the HMAC code, let’s do it step by step. HMAC might not be a complicated algorithm, but it can look quite scary at first. Case in point, look at the function signature:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">hmac</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">keySize</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">H</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">),</span> <span class="kt">size_t</span> <span class="n">blockSize</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">outputLength</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">workingKey</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">K</span><span class="p">;</span> 

  <span class="k">if</span> <span class="p">(</span><span class="n">keySize</span> <span class="o">&gt;</span> <span class="n">blockSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">H</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">keySize</span><span class="p">);</span>
    <span class="n">workingKey</span> <span class="o">=</span> <span class="n">hmac_pad</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">outputLength</span><span class="p">,</span> <span class="n">blockSize</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">workingKey</span> <span class="o">=</span> <span class="n">hmac_pad</span><span class="p">(</span><span class="n">workingKey</span><span class="p">,</span> <span class="n">keySize</span><span class="p">,</span> <span class="n">blockSize</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>The function accepts a message, the message size, a key, the key size, a hash function, the hash’s block size in bytes, and the hash’s output length in bytes. So many parameters to mess up! Typically, just like the hashes, all the parameters are enclosed in a structure, such that you only need to pass a single structure to the function and call a digest function for each block of the message; however, as our goal is to generate an OTP from a fixed length key, I figured that it was not necessary.</p>

<p>The above code pads the key if the key is not wide enough; otherwise, if the key is too long, it will be hashed down first before padding, as specified in the RFC.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">intermediate1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">blockSize</span><span class="p">);</span>
  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">intermediate2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">blockSize</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blockSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">intermediate1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">workingKey</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x36</span><span class="p">;</span>
    <span class="n">intermediate2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">workingKey</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x5c</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>I will admit, this is not my best work; creating tons of intermediate variables just to compute a HMAC is probably very resource-wasteful. However, I didn’t care to optimize the code further than I have to, in effort to prevent me from losing interest. The code above hashes what the RFC defines as <code class="language-plaintext highlighter-rouge">ipad</code>, a block of <code class="language-plaintext highlighter-rouge">0x36</code>, and <code class="language-plaintext highlighter-rouge">opad</code>, a block of <code class="language-plaintext highlighter-rouge">0x5c</code>, to the key, storing the results in intermediate variables to be used later. In short, these compute <code class="language-plaintext highlighter-rouge">K XOR opad</code> and <code class="language-plaintext highlighter-rouge">K XOR ipad</code>.</p>

<p>To overcome the oversight of not having a streamable hashing function, I had to concatenate the result of <code class="language-plaintext highlighter-rouge">K XOR ipad</code> with the message before I could perform any hashing operations on it. The code computes <code class="language-plaintext highlighter-rouge">K XOR ipad, text</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">intermediate3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">blockSize</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">intermediate3</span><span class="p">,</span> <span class="n">intermediate1</span><span class="p">,</span> <span class="n">blockSize</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">intermediate3</span> <span class="o">+</span> <span class="n">blockSize</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div>

<p>This computes <code class="language-plaintext highlighter-rouge">H(K XOR ipad, text)</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">intermediate4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">H</span><span class="p">(</span><span class="n">intermediate3</span><span class="p">,</span> <span class="n">blockSize</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div>

<p>Again, due to the oversight of not having a streamable hashing function, I concatenated the result of <code class="language-plaintext highlighter-rouge">H(K XOR ipad, text)</code> to <code class="language-plaintext highlighter-rouge">K XOR opad</code> to produce <code class="language-plaintext highlighter-rouge">K XOR opad, H(K XOR ipad, text)</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">intermediate5</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">blockSize</span> <span class="o">+</span> <span class="n">outputLength</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">intermediate5</span><span class="p">,</span> <span class="n">intermediate2</span><span class="p">,</span> <span class="n">blockSize</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">intermediate5</span> <span class="o">+</span> <span class="n">blockSize</span><span class="p">,</span> <span class="n">intermediate4</span><span class="p">,</span> <span class="n">outputLength</span><span class="p">);</span>
</code></pre></div></div>

<p>Finally, this line computes <code class="language-plaintext highlighter-rouge">H(K XOR opad, H(K XOR ipad, text))</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">H</span><span class="p">(</span><span class="n">intermediate5</span><span class="p">,</span> <span class="n">blockSize</span> <span class="o">+</span> <span class="n">outputLength</span><span class="p">);</span>
</code></pre></div></div>

<p>All that is left is to free all the intermediate variables, and return the result:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">free</span><span class="p">(</span><span class="n">intermediate1</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">intermediate2</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">intermediate3</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">intermediate4</span><span class="p">);</span>
  <span class="n">Pfree</span><span class="p">(</span><span class="n">intermediate5</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">workingKey</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</code></pre></div></div>

<p>And presto, we’ve implemented HMAC! I used <a href="https://www.devglan.com/online-tools/hmac-sha256-online">this online tool</a> to test the same HMAC implementation on the SHA-256 and SHA-512 algorithms. To call this function, we have to do the following:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "hmac.h"
</span><span class="c1">// include only one of these</span>
<span class="cp">#include "sha1.h"
#include "sha256.h"
#include "sha512.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">message</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"the quick brown fox jumped over the lazy sleeping dog"</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"epic key"</span><span class="p">;</span>

    <span class="c1">// sha1</span>
    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span> <span class="n">method_two</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="c1">// sha256</span>
    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span> <span class="n">sha256</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
    <span class="c1">// sha512</span>
    <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span> <span class="n">sha512</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

    <span class="c1">// do whatever with result</span>
    <span class="n">free</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In case you were wondering what the numbers 20, 32, 64, and 128 mean, you may recall that:</p>

<ul>
  <li>SHA1 has a 512-bit block size (64 bytes) and 160-bit result (20 bytes)</li>
  <li>SHA256 has a 512-bit block size (64 bytes) and 256-bit result (32 bytes)</li>
  <li>SHA512 has a 1024-bit block size (128 bytes) and 512-bit result (64 bytes)</li>
</ul>

<p>The code is available <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/hmac.h">on my GitHub repository</a>.</p>

<h1 id="hotp">HOTP</h1>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>With HMAC implemented, we can finally implement <a href="https://tools.ietf.org/html/rfc4226">RFC 4226</a>, one step shy of our goal to get TOTPs! Being one step away from TOTPs, HOTPs are counter-based, meaning that the end-user would need to manually increment a counter to generate the next OTP used for authentication.</p>

<p>You can probably already see how to generate TOTPs from HOTPs, but for the sake of completeness, let’s talk about how HOTP works. With the HMAC algorithm, we need to specific a message and the key; in the context of HOTPs, the message would be the counter value, and the key would be an actual cryptographic secret. From there, we would get a unique value from HMAC every increment of the counter. However, even though getting the user to type 20 hexadecimal numbers might be a fun way to torture them, we have to think about practicality, and instead choose to <em>truncate</em> the value produced by the HMAC algorithm.</p>

<p>In other words, HOTP is defined as <code class="language-plaintext highlighter-rouge">HOTP(K,C) = Truncate(HMAC-SHA-*(K, C))</code>, where <code class="language-plaintext highlighter-rouge">K</code> is the key, <code class="language-plaintext highlighter-rouge">C</code> is the counter value, <code class="language-plaintext highlighter-rouge">HMAC-SHA-*</code> is any SHA family hashing algorithm, and <code class="language-plaintext highlighter-rouge">Truncate</code> is the truncation function that will cut our value short, and produce 6 to 8 digits of user-friendly numbers for their consumption.</p>

<p>Luckily for us, <code class="language-plaintext highlighter-rouge">Truncate</code> has a simple definition. Given the hash result, <code class="language-plaintext highlighter-rouge">H</code>, in byte array form, arranged in Big Endian:</p>

<ol>
  <li>Obtain the last 4 bits in the last byte within <code class="language-plaintext highlighter-rouge">H</code>, i.e. <code class="language-plaintext highlighter-rouge">H[len(H) - 1]</code>;</li>
  <li>Convert (if necessary) the numerical value of the 4 bits (i.e. 0101 base 2 is 5 base 10) to a number, <code class="language-plaintext highlighter-rouge">i</code>;</li>
  <li>Define a 4-byte variable and assign it to contain the values, in native byte order, <code class="language-plaintext highlighter-rouge">H[i]</code> to <code class="language-plaintext highlighter-rouge">H[i + 3]</code>;</li>
  <li>Mask the first bit of the 4-byte variable, and modulo it with 10^(number of digits in OTP) to obtain a 6 to 8 digit number OTP.</li>
</ol>

<p>Sounds complicated? Well, programmers like to see code, so here you go:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="nf">hotp_DT</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint8_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> 
    <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> 
    <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Dead-simple, I tell you. Words are meaningless constructs in the face of code, unless functional programming is involved.</p>

<p>For the actual HOTP algorithm, I figured to use a structure for once:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">uint64_t</span> <span class="n">counter</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">secret</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">secretSize</span><span class="p">;</span>

  <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">hashFn</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">blockSize</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">outputLength</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hotp_context</span><span class="p">;</span>
</code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">uint64_t</code> for the counter might seem overkill, but the size of the counter is <a href="https://tools.ietf.org/html/rfc4226#page-5">defined</a> in the RFC; it makes sense too, because later on in TOTP, we are going to need <code class="language-plaintext highlighter-rouge">uint64_t</code>, as storing time in a <code class="language-plaintext highlighter-rouge">uint32_t</code> variable will be a bad idea closer to the year 2038. Let’s work on the HOTP algorithm itself.</p>

<p>Since we have a 64-bit counter of unknown byte order, we need to first break it down into a Big Endian byte array.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="nf">hotp</span><span class="p">(</span><span class="n">hotp_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">digits</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span> <span class="n">counter</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">counter</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>
</code></pre></div></div>

<p>We then run the counter and secret through HMAC, which computes <code class="language-plaintext highlighter-rouge">HMAC-SHA-*(K, C)</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">hs</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">secretSize</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hashFn</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">blockSize</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outputLength</span><span class="p">);</span>
</code></pre></div></div>

<p>Truncating it with the function we wrote earlier, we get our <em>close to</em> final result.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="n">Snum</span> <span class="o">=</span> <span class="n">hotp_DT</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">outputLength</span><span class="p">);</span>
</code></pre></div></div>

<p>All we need to do now is to perform memory cleanup, and return the number of digits we desire from the algorithm:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">free</span><span class="p">(</span><span class="n">hs</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">Snum</span> <span class="o">%</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">digits</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>

<p>To use the <code class="language-plaintext highlighter-rouge">hotp</code> function, the following C code can be used:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "sha1.h"
#include "hotp.h"
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="n">secret</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"a very secret key!!!"</span><span class="p">;</span>

  <span class="n">hotp_context</span> <span class="n">ctx</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">secret</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">secret</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">secretSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">hashFn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span> <span class="n">method_two</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">blockSize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">outputLength</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hotp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Refer to the <a href="#hmac">HMAC</a> section to change the values of <code class="language-plaintext highlighter-rouge">ctx.hashFn</code>, <code class="language-plaintext highlighter-rouge">ctx.blockSize</code> and <code class="language-plaintext highlighter-rouge">ctx.outputLength</code>. The full C code can be found in <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/hotp.h">my GitHub repository</a>.</p>

<h1 id="totp">TOTP</h1>

<p><a href="#table-of-contents">Back to Table Of Contents</a></p>

<p>And finally, <a href="https://tools.ietf.org/html/rfc6238">RFC 6238</a>, the whole purpose of this blog post. TOTPs! HOTPs are slightly troublesome, requiring the user to increment the counter manually - this meant that receivers of HOTP needed to define an interval of OTPs that they’ll accept, through the resynchronization parameter. This is error-prone, and highly frustrating for the end-user, especially due to off-by-one errors and naughty toddlers incrementing HOTP counters.</p>

<p>TOTPs solve this problem by using Real-Time clocks available on most low-powered hardware, and relatively high-powered devices like smart phones and laptops - they use time as a means to calculate the counter value in HOTP. In other words, TOTP can be said to be a simple extension of HOTPs.</p>

<p>In TOTPs, two more parameters are defined:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">T0</code>, the “beginning” time to consider, which is defaults to 0, representing UNIX Epoch;</li>
  <li><code class="language-plaintext highlighter-rouge">X</code>, the time-step to consider, which defaults to 30 seconds.</li>
</ul>

<p>The counter value is defined as <code class="language-plaintext highlighter-rouge">(timestamp in seconds - T0) / X</code>, and the key is still an actual cryptographic key.</p>

<p>As such, the implementation of TOTP is extremely trivial:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="nf">totp</span><span class="p">(</span><span class="n">hotp_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">digits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">T0</span><span class="p">)</span> <span class="o">/</span> <span class="n">X</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">hotp</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">digits</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Bam. Done. That’s TOTP, RFC 6238. The RFC also talks about time drift and whatnot, but since we are <em>generating</em> OTPs, it shouldn’t be too much of a bother for us. You can test the <code class="language-plaintext highlighter-rouge">totp</code> implementation with:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "sha1.h"
#include "hotp.h"
#include "totp.h"
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="n">secret</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"a very secret key!!!"</span><span class="p">;</span>

  <span class="n">hotp_context</span> <span class="n">ctx</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">secret</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">secret</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">secretSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">hashFn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span> <span class="n">method_two</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">blockSize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">outputLength</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">totp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The OTP generated by the code written so far matches with the <a href="https://totp.danhersam.com/">TOTP generator</a> written by <a href="https://dan.hersam.com/">Dan Hersam</a>. Do note that Dan’s site uses Base32 keys, so you’ll need a <a href="https://emn178.github.io/online-tools/base32_encode.html">Base32 encoder</a>; <strong>make sure to remove all the padding before using it as a key (i.e. delete all the <code class="language-plaintext highlighter-rouge">=</code>)</strong>.</p>

<blockquote>
  <p>Why? Dan’s implementation of TOTP relies on a library called <code class="language-plaintext highlighter-rouge">otpauth</code> on version <code class="language-plaintext highlighter-rouge">v3.1.3</code>. In <a href="https://github.com/hectorm/otpauth/blob/v3.1.3/src/utils.js#L143">line 143 of this version’s utility function</a>, where base32 is encoded into an <code class="language-plaintext highlighter-rouge">ArrayBuffer</code>, the padding characters, <code class="language-plaintext highlighter-rouge">=</code> are not handled at all, leading to an error that causes the token to be generated wrongly. This is fixed in a subsequent version of <code class="language-plaintext highlighter-rouge">otpauth</code>, but unfortunately, Dan has since stopped maintaining the TOTP generator.</p>
</blockquote>

<p>The code for <a href="https://github.com/jameshi16/Bad-TOTP/blob/master/totp.h">TOTP can be found on my GitHub repository</a>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Implementing TOTP from all of its components was quite a journey for me. In the modern world, we build great-scaled applications on the shoulders of giants - libraries do most of our heavy lifting. However, it is important to visit the low-level once in a while to marvel at the smaller building blocks, understand design considerations behind every line of code, and take it all in as an art-form.</p>

<p>Some day, new algorithms will be developed in favour of whatever we use today; surely, they will have more extensive use-cases only imaginable by those of the future.</p>

<p>Let’s see what tomorrow brings!</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="totp" /><category term="c" /><category term="rfc" /><category term="scratch" /><category term="totp" /><category term="c" /><category term="rfc" /><category term="scratch" /><summary type="html"><![CDATA[“How do One-Time Passwords (OTP) work?” I asked myself, as I fiddled with my digital banking token to check my non-existent wealth online.]]></summary></entry><entry><title type="html">ZeroTier OpenVPN NAT - Part 1</title><link href="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-1/" rel="alternate" type="text/html" title="ZeroTier OpenVPN NAT - Part 1" /><published>2021-02-14T13:31:00+00:00</published><updated>2021-02-14T13:31:00+00:00</updated><id>https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-1</id><content type="html" xml:base="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-1/"><![CDATA[<p>Happy New Year :fireworks:! What, New Year was one month ago, and I’ve henceforth lost all right to celebrate it?</p>

<p>Well, as they (read: <em>I</em>) say, the day doesn’t end until you go to sleep; and I’ve been awake for a really, <em>really</em> long time :coffee:. Regardless of the late and obligatory greeting, my New Year’s resolution is to deliver interesting blog posts every month of the year - let’s hope I don’t run out of unconventional ideas to blog about. Also, January doesn’t count as a month.</p>

<p>Enjoy!</p>

<h1 id="preface-skippable">Preface (Skippable)</h1>

<p><a href="#goal">SKIP: I don’t have the time, bring me to the next section :angry:</a></p>

<p>Decentralized networks are quite interesting. Instead of a star-like topology like in traditional client-server models, decentralized networks are usually peer-to-peer (P2P), meaning they have a spider-web-like topology.</p>

<p><img src="/images/20210214_1.svg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Star Model" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Traditional Client-Server Model | Source: <a href="https://en.wikipedia.org/wiki/Peer-to-peer">Wikipedia</a></p>

<p><img src="/images/20210214_2.svg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Spider-web Model" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Peer-to-Peer Model | Source: <a href="https://en.wikipedia.org/wiki/Peer-to-peer">Wikipedia</a></p>

<p>There are many arguments online about which model is better than the other in terms of network performance, redundancy and host stability; you can read more about a standardized response to “Client-Server Model vs Peer-to-Peer model” <a href="https://cio-wiki.org/wiki/Client_Server_Architecture#Advantages_and_Disadvantages_of_the_Client_Server_Architecture.5B7.5D">through this link</a>.</p>

<p>In this decade, we saw the rise of Bitcoin, a cryptocurrency that uses Blockchain technology, as a decentralized payment alternative to standard bank transfers / credit card payments. Many began to ride on the bandwagon, inventing new cryptocurrencies, merging Blockchain technology with the supply chain, and applying the idea of decentralization into every nook and cranny of technology.</p>

<p>One such impacted technology is Virtual Private Networks (VPNs). Recently, the consumer definition of VPNs are “a more privacy oriented internet connection that can be used to bypass geological restrictions”; however, this is not the original purpose or definition of VPN. Instead, VPNs, by definition from <a href="https://www.cisco.com/c/en/us/products/security/vpn-endpoint-security-clients/what-is-vpn.html">Cisco</a>, are extensions of another network by making it available on the internet; a user can securely access the resources on a private network via a VPN service.</p>

<p>An advantage of accessing the private network over exposing the services to the internet is the battle-tested authentication &amp; encryption tunnel created for the connection: no matter what protocol the services in the private network use, be it encrypted or not, they can all be securely accessed via a VPN tunnel over the network. Moreover, given a properly configured firewall for each host in the network, creating and hosting new services becomes a simple task, as private networks are implicitly trusted by many applications.</p>

<p>Before 2011, most users or corporates leveraged the power of (true) VPNs either by hosting it themselves, or via a managed decentralized P2P service like <a href="https://en.wikipedia.org/wiki/LogMeIn_Hamachi">LogMeIn Hamachi</a>; as a side-note reminiscing my past, Hamachi was one of the services I used frequently, as it was one of the easier ways to host a Minecraft server without port-forwarding. It is also worth it to note that Hamachi’s selling point was not it’s decentralization, but it’s ability to create a VLAN. In 2011, a lesser-known alternative sprung up, known as <a href="https://www.zerotier.com/">ZeroTier</a>.</p>

<p>Unlike Hamachi, ZeroTier has less restrictions on the number of hosts per network (5 vs 50 at the time of writing), has Software-Defined Networking (i.e. something like kernel IPTables and iproute2), allowed for Full Bridging Mode (i.e. tunnel all internet connection to a host on the Software-Defiend network), and is mostly open-source; this means that the technology behind the core aspects of ZeroTier, such as using <a href="https://en.wikipedia.org/wiki/STUN">STUN</a>, <a href="https://en.wikipedia.org/wiki/UDP_hole_punching">UDP Hole Punching</a>, route discovery and tunnel encryption are under public scrutiny, which helps to create a more secure service. Moreover, ZeroTier is constantly evolving to become more decentralized; with the introduction of <a href="https://www.zerotier.com/manual/#4_4">Moons</a>, it is ZeroTier’s aim to achieve infrastructure federation, i.e. little to no reliance on ZeroTier’s root servers. In a nutshell, the main difference between Hamachi and ZeroTier is their emphasis on decentralization.</p>

<p>Personally, I believe that true decentralization can only occur when the community is heavily involved in the project; barring conspiracy, projects such as the <a href="https://en.wikipedia.org/wiki/Tor_\(anonymity_network\)">Tor Project</a> or <a href="https://geti2p.net/en/">I2P</a> can only achieve their “freedom of internet via anonymity” goal through peer-hosted servers or clients. Hence, it makes sense for more users to jump aboard the decentralization train - so that we may ideally achieve a freer internet with less surveillance.</p>

<hr />

<h1 id="goal">Goal</h1>

<p>On almost all of my devices (which includes one Single Board Computer akin to a Raspberry Pi), I have a VPN connection to a provider I trust, and an installation of ZeroTier. The VPN provider connects me to the internet, while ZeroTier gives me access to services on my VLAN; however, there are two main problems with this setup:</p>

<ol>
  <li>Android devices cannot dual-wield VPN connections; in other words, I cannot connect to my VPN provider and ZeroTier at the same time;</li>
  <li>For <em>true</em> decentralization &amp; federation, this setup relies too much on UDP connectivity - despite being in 2021, several locations (universities, coffee shops) still block UDP connections.</li>
</ol>

<p>As my goal is to achieve peak decentralization, <strong>and</strong> retain my VPN connection to my VPN provider, it falls on me to implement a solution that can combine the best of both worlds. Additionally, there are the following constraints:</p>

<ol>
  <li>I cannot port-forward. My solution must rely on resources most people can access; routers have subjective access levels for each individual. Moreover, dynamic IP addresses are a thing; any solution that requires the exposure of a service to the plain internet is out of the question.</li>
  <li>One device. The solution must be implementable on a single device; money (and hence, resources) does not grow on trees.</li>
  <li>Otherwise unaffecting. The solution must not disrupt the default gateways on the implemented devices; in other words, the device can still have plain internet access <em>alongside</em> hosting whatever solution I implement.</li>
  <li>Free. The solution cannot cost extra money.</li>
</ol>

<p>These constraints will help make my solutions implementable across a wider audience, irregardless of how complex a given country’s NAT systems or firewalls are. After racking my head for a bit, I came up with two possible solutions, but none of them perfectly mitigates the problems above; if you decide to implement them, read the text carefully.</p>

<blockquote>
  <p><strong>NOTE</strong>: For all the solutions, I’m assuming that the subnet for ZeroTier is <code class="language-plaintext highlighter-rouge">172.25.0.0/16</code>.</p>
</blockquote>

<h2 id="solution-uno">Solution Uno</h2>

<p>Solution Uno requires a device on your local LAN; a small Single Board Computer (SBC) is good enough. By some clever masquerade and manipulation of the Kernel IP Tables, it is possible to send all internet-bound connections from the ZeroTier adapter to an OpenVPN <code class="language-plaintext highlighter-rouge">tun</code> adapter. Hence, all one needs to do is to establish an OpenVPN connection to the VPN provider while ensuring it does not affect the route table (constraint #3), and create suitable entries in the route table to facilitate forwarding between ZeroTier and OpenVPN.</p>

<p><img src="/images/20210214_3.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Device -&gt; ZeroTier -&gt; SBC -&gt; OpenVPN -&gt; OpenVPN Provider" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Architecture for Solution Uno | Source: Me</p>

<p>Solution Uno’s downside occurs when a network restricts UDP connectivity, and hence prevents ZeroTier from achieving P2P connections; the device will instead be using a root server as a relay, which docks some points in federation.</p>

<h2 id="solution-duo">Solution Duo</h2>

<p>Cloud Computing providers fiercely compete with one another, offering unprecedented prices for infinite scalability, fault tolerance and availability. For non-business consumers like us, we benefit from the competition through the free-tier offerings; for Solution Duo, we utilize Oracle Cloud’s “Always Free Tier”, which allows us to have two <code class="language-plaintext highlighter-rouge">VM.Standard.E2.1.Micro</code> VMs for the low price of absolutely free.</p>

<p><img src="/images/20210214_4.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Device -&gt; OpenVPN -&gt; Oracle Cloud VM -&gt; OpenVPN -&gt; OpenVPN Provider" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Architecture for Solution Duo | Source: Me</p>

<p>By configuring an OpenVPN server and ZeroTier on an Oracle Cloud VM, it becomes possible to set up routes to forward packets to and fro the OpenVPN <code class="language-plaintext highlighter-rouge">tun</code> and ZeroTier adapter. Taking care not to disrupt the default gateway (constraint #3), an OpenVPN client connection can be established from within the VM, connecting to the VPN provider. In essence, an external device will be connecting to a OpenVPN proxy that also happens to route ZeroTier addresses.</p>

<p>The main downside of this approach is the connection speed; Oracle Cloud does not have datacenters in certain parts of the world, which may increase latency of any given VPN connection.</p>

<h2 id="bonus-solution-dinosaur">Bonus: Solution Dinosaur</h2>

<p>As a bonus solution (and if you have time), both Solution Uno and Solution Duo can be implemented together, forming something akin a multi-directional bridge. If the device has an unrestricted internet connection, and is also an Android device, then simply connecting to the ZeroTier network via the official Android app will connect it to both the VPN provider and the ZeroTier network. If you want to maximize federation, and the device has an internet connection that blocks UDP connections, then connecting to the Oracle Cloud VM via an OpenVPN app will also connect the device to both the VPN and the ZeroTier network.</p>

<p><img src="/images/20210214_5.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Device -&gt; OpenVPN -&gt; Oracle Cloud VM -&gt; ZeroTier -&gt; SBC -&gt; OpenVPN -&gt; OpenVPN Provider" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Architecture for Solution Dinosaur | Source: Me</p>

<p>While it is an abomination, I personally use this method. A more ideal solution would be to host a ZeroTier moon on Oracle Cloud, and then getting the device to orbit it, but such a feature is unavailable on Android at the time of writing.</p>

<blockquote>
  <p><strong>NOTE</strong>: There is a rumor that this feature will come in ZeroTier 2.0, according to this <a href="https://www.reddit.com/r/zerotier/comments/d9xuv3/force_zerotier_client_to_only_use_your_own_moons/">Reddit post</a>.</p>
</blockquote>

<hr />

<h1 id="bookmark">Bookmark</h1>

<p>I will implement all three solutions in different parts:</p>

<ul>
  <li><a href="/2021/02/14/zerotier-openvpn-nat-part-2">Part 2</a> - Solution Uno</li>
  <li><a href="/2021/02/14/zerotier-openvpn-nat-part-3">Part 3</a> - Solution Duo</li>
  <li><a href="/2021/02/14/zerotier-openvpn-nat-part-4">Part 4</a> - Solution Dinosaur</li>
</ul>

<p>You can bookmark <a href="#bookmark">this link</a> to come back later.</p>

<hr />

<h1 id="conclusion">Conclusion</h1>

<p>While decentralization is an important step forward for the internet, a large part of the world is still resisting those changes; by disrupting UDP connectivity, peer-to-peer connections are difficult, if not, impossible to establish, hindering the progress towards a freer and open internet.</p>

<p>I hope that by coming up with solutions to workaround these disruptions, we can bridge the missing gaps required to get everyone on decentralized networks, private or not.</p>

<p>This was a particularly long series of blog posts - if you find any mistakes in the posts, please tweet <a href="https://twitter.com/jameshi16">@me</a>.</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><summary type="html"><![CDATA[Happy New Year :fireworks:! What, New Year was one month ago, and I’ve henceforth lost all right to celebrate it?]]></summary></entry><entry><title type="html">ZeroTier OpenVPN NAT - Part 2</title><link href="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-2/" rel="alternate" type="text/html" title="ZeroTier OpenVPN NAT - Part 2" /><published>2021-02-14T13:29:00+00:00</published><updated>2021-02-14T13:29:00+00:00</updated><id>https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-2</id><content type="html" xml:base="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-2/"><![CDATA[<p><img src="/images/20210214_3.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Architecture" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Uno Architecture</p>

<p><a href="/2021/02/14/zerotier-openvpn-nat-part-1#bookmark">&lt;&lt; Take me back to Part 1</a></p>

<p>In this part, we will be implementing Solution Uno. Solution Uno has the following main design goals:</p>

<ul>
  <li>Connect from a device that can only have one VPN connection (like an Android device)</li>
  <li>Connect from a restricted device that only allows VPN configurations (like a ISP home router)</li>
</ul>

<h1 id="step-0-pre-requisites">Step 0: Pre-requisites</h1>

<p>You will need a low-powered host capable of hosting an OpenVPN Server and maintaining a ZeroTier connection, like a Single Board Computer. Preferably, you will want administrative privileges; this guide will assume that you’ve got your hands on a Raspberry Pi with some flavour of Linux installed, particularly, Debian/Ubuntu.</p>

<p>You will need administrative access to your ZeroTier network through ZeroTier Central or some equivalent (if you run your own controller).</p>

<h1 id="step-1-installing-packages">Step 1: Installing packages</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> https://install.zerotier.com | <span class="nb">sudo </span>bash
<span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>openvpn
</code></pre></div></div>

<p>After installing ZeroTier, configure it to join your network; a simple <code class="language-plaintext highlighter-rouge">sudo zerotier-cli join &lt;networkID&gt;</code> should do. Run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ip <span class="nb">link</span> | <span class="nb">grep</span> <span class="s2">"zt"</span>
</code></pre></div></div>

<p>Note down the full device name; it should look like this: <code class="language-plaintext highlighter-rouge">ztly52mmwy</code>.</p>

<h1 id="step-2-create-files">Step 2: Create files</h1>

<p>In this step, we are going to create a SystemD unit file, and two scripts that the OpenVPN daemon will call when routes are being setup and torn down. If you are not using a flavour of Linux that uses SystemD, then adapt the files based on your favoured init system.</p>

<p><code class="language-plaintext highlighter-rouge">/etc/systemd/system/zt2ovpn.service</code>:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">Binds ZeroTier tunnel to OpenVPN</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="s">simple</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="s">openvpn --cd /etc/openvpn/client --config &lt;insert_vpn_conf_here&gt;.conf --route-noexec --route-up /etc/openvpn/client/up-script.sh --route-pre-down /etc/openvpn/client/down-script.sh</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="s">multi-user.target</span>
</code></pre></div></div>

<p>Remember to replace <code class="language-plaintext highlighter-rouge">&lt;insert_vpn_conf_here&gt;.conf</code> with your VPN provider’s configuration.</p>

<p>The most important part of this service is the command in the <code class="language-plaintext highlighter-rouge">ExecStart</code> directive:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openvpn <span class="nt">--cd</span> /etc/openvpn/client <span class="nt">--config</span> &lt;insert_vpn_conf_here&gt;.conf <span class="nt">--route-noexec</span> <span class="nt">--route-up</span> /etc/openvpn/client/up-script.sh <span class="nt">--route-pre-down</span> /etc/openvpn/client/down-script.sh
</code></pre></div></div>

<p>As long as there is some variant of this in the init system, the setup should work as expected. One peculiar flag you may notice is the <code class="language-plaintext highlighter-rouge">--route-noexec</code> flag; this flag prevents the VPN from writing to the route table. This is required to fulfill constraint #3, which states that the ZeroTier to OpenVPN tunnel should be otherwise unaffecting.</p>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/client/up-script.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_CIDR</span><span class="o">=</span><span class="s2">"172.25.0.0/16"</span>

<span class="nb">set</span> <span class="nt">-e</span>

sysctl <span class="nt">-w</span> net.ipv4.ip_forward<span class="o">=</span>1

<span class="nb">touch</span> /etc/iproute2/rt_tables.d/zt2ovpn.conf
<span class="nb">echo</span> <span class="s2">"42069 zt2ovpn"</span> <span class="o">&gt;</span> /etc/iproute2/rt_tables.d/zt2ovpn.conf

ip rule add from <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> table zt2ovpn
ip route add default via <span class="k">${</span><span class="nv">route_vpn_gateway</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> table zt2ovpn
ip route add <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table zt2ovpn

iptables <span class="nt">-I</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-I</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-t</span> nat <span class="nt">-I</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>
<p>Edit <code class="language-plaintext highlighter-rouge">ZT_DEVICE</code> to whatever device name you’ve noted down in step 1, and <code class="language-plaintext highlighter-rouge">ZT_CIDR</code> to whatever you set in ZeroTier Central or equivalent.</p>

<p>This script will be executed by OpenVPN when a connection is up; since we told OpenVPN not to add routes, we have to do it manually in this script. The line <code class="language-plaintext highlighter-rouge">sysctl -w net.ipv4.ip_forward=1</code> enables IP forwarding on the system, which is required to forward packets between the ZeroTier adapter and the VPN tunnel. The next few lines adds a new route table effective only for <code class="language-plaintext highlighter-rouge">${ZT_CIDR}</code>: this is required as we do not want to affect the host system’s routing, dictated by constraint #3. We set the default route to the VPN gateway, and properly route any connections to ZeroTier devices for the new table that we just created. The last few <code class="language-plaintext highlighter-rouge">iptables</code> lines essentially just accepts connections from the ZeroTier adapter, allow forwarding for that device, and allow any exiting connections to the OpenVPN tunnel adapter to be masqueraded.</p>

<p>For some systems, you may need to add a few lines to accept connections from the OpenVPN tunnel adapter:</p>

<p>(Optional addon for <code class="language-plaintext highlighter-rouge">/etc/openvpn/client/up-script.sh</code>)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-I</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-m</span> state <span class="nt">--state</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-I</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-m</span> state <span class="nt">--state</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
</code></pre></div></div>

<p>Next, create the down script.</p>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/client/down-script.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_CIDR</span><span class="o">=</span><span class="s2">"172.25.0.0/16"</span>

ip rule delete from <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> table zt2ovpn
ip route delete default via <span class="k">${</span><span class="nv">route_vpn_gateway</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> table zt2ovpn
ip route delete <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table zt2ovpn

<span class="nb">rm</span> <span class="nt">-f</span> /etc/iproute2/rt_tables.d/zt2ovpn.conf

iptables <span class="nt">-D</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-D</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-t</span> nat <span class="nt">-D</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<p>The down script is essentially the opposite of the up script; it deletes the entries created by the up script. If you added the optional addons for <code class="language-plaintext highlighter-rouge">/etc/openvpn/client/up-script.sh</code>, then you may need these lines too:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-D</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-m</span> state <span class="nt">--state</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-D</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-m</span> state <span class="nt">--state</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
</code></pre></div></div>

<h1 id="step-3-enable--start-the-service">Step 3: Enable &amp; Start the service</h1>

<p>Try starting the service with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl start zt2ovpn
</code></pre></div></div>

<p>Hopefully, there would be no errors. If there are errors, then find out what they are:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl status zt2ovpn
<span class="nb">sudo </span>journalctl <span class="nt">-u</span> zt2ovpn <span class="nt">-f</span>
</code></pre></div></div>

<p>If everything is alright, enable the service to start it on system start:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>zt2ovpn
</code></pre></div></div>

<h1 id="step-4-add-entry-to-zerotier-central-or-equivalent">Step 4: Add entry to ZeroTier Central (or equivalent)</h1>

<p>Navigate to your network on ZeroTier, and add a Managed Route:</p>

<p><img src="/images/20210214_6.png" style="max-width: 600px; width: 100%; margin: 0 auto; display: block;" alt="Adding a Managed Route" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Adding a Managed Route | Source: Me</p>

<p>Under <code class="language-plaintext highlighter-rouge">(Via)</code> should be the IP address of the host (Single Board Computer) you are using; for me, it was <code class="language-plaintext highlighter-rouge">172.25.0.1</code>. Once done, click on Submit.</p>

<h1 id="step-5-testing">Step 5: Testing</h1>

<p>Now, test it on your devices. For any device with <code class="language-plaintext highlighter-rouge">zerotier-cli</code>, run:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>zerotier-cli <span class="nb">set</span> &lt;networkId&gt; <span class="nv">allowDefault</span><span class="o">=</span>1
</code></pre></div></div>

<p>For Android/iOS devices, find the “Route Via ZeroTier” option:
<img src="/images/20210214_7.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Route Via ZeroTier" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Route Via ZeroTier option | Source: Me</p>

<p>Check your IP address with your favourite method; if your VPN provider provides a way to check IP addresses, DNS and WebRTC leaks, use that instead.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Congratulations! You’ve successfully set up Solution Uno. <a href="/2021/02/14/zerotier-openvpn-nat-part-1#bookmark">Click here</a> to go back to Part 1; otherwise, if you are satisfied, then we’re done here.</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><summary type="html"><![CDATA[Uno Architecture]]></summary></entry><entry><title type="html">ZeroTier OpenVPN NAT - Part 3</title><link href="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-3/" rel="alternate" type="text/html" title="ZeroTier OpenVPN NAT - Part 3" /><published>2021-02-14T13:28:00+00:00</published><updated>2021-02-14T13:28:00+00:00</updated><id>https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-3</id><content type="html" xml:base="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-3/"><![CDATA[<p><img src="/images/20210214_4.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Architecture" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Duo Architecture</p>

<p><a href="/2021/02/14/zerotier-openvpn-nat-part-1#bookmark">&lt;&lt; Take me back to Part 1</a></p>

<p>Solution Duo was designed with the following goals:</p>

<ul>
  <li>Guaranteed connectivity</li>
  <li>High Federation</li>
</ul>

<h1 id="step-0-pre-requisites">Step 0: Pre-requisites</h1>

<p>You will need an <a href="https://cloud.oracle.com">Oracle Cloud</a> account. An account will remain always-free until it is explicitly upgraded; so don’t worry too much about being charged.</p>

<h1 id="step-1-creating-cloud-resources-skippable">Step 1: Creating cloud resources (Skippable)</h1>

<p>It is not an explicit requirement to create any of the resources here; however, it is good practice (at least in AWS) to house all the resources in their proper groups.</p>

<p>For this step we will be creating/modifying the following things:</p>
<ul>
  <li>Virtual Cloud Network</li>
  <li>Subnet</li>
  <li>Internet Gateway</li>
  <li>Network Security Group</li>
  <li>Security List</li>
  <li>Route Table</li>
</ul>

<p>Navigate to the <a href="https://cloud.oracle.com/networking/vcns">Virtual Cloud Networks</a> page, and click on “Create VCN”.</p>

<p><img src="/images/20210214_8.png" style="max-width: 600px; width: 100%; margin: 0 auto; display: block;" alt="Creating VCN" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Creating VCN | Source: Me</p>

<p>Name the VCN whatever you like; it does not matter. After you are done, click on “Create VCN”.</p>

<p>Oracle Cloud will redirect you to the page detailing the VCN. From the sidebar, click on “Internet Gateways”:</p>

<p><img src="/images/20210214_14.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate to Route Tables" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate to Route Tables | Source: Me</p>

<p>Create an Internet Gateway, and name it anything you want.</p>

<p><img src="/images/20210214_15.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Create an Internet Gateway" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Name your internet gateway | Source: Me</p>

<p>From the sidebar, click on “Route Tables”:</p>

<p><img src="/images/20210214_10.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate to Route Tables" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate to Route Tables | Source: Me</p>

<p>Click on “Create Route Table”:</p>

<p><img src="/images/20210214_11.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Create Route Table" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Create a Route Table | Source: Me</p>

<p>Name the Route Table anything you want, and then click on “Create”:</p>

<p><img src="/images/20210214_12.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Naming the Route Table" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Name the Route Table | Source: Me</p>

<p>After the page redirects, click into the Route Table you just created:</p>

<p><img src="/images/20210214_13.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Click into the Route Table" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Click the Route Table | Source: Me</p>

<p>Then, click on “Add Route Rules”:</p>

<p><img src="/images/20210214_16.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Adding Route Rules" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Add Route Rules button | Source: Me</p>

<p>In the dialog that appears, choose “Internet Gateway” as the Target Type, <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> as the Destination CIDR Block, and set <code class="language-plaintext highlighter-rouge">Target Internet Gateway</code> to the Internet Gateway you just created. After that, click on “Add Route Rules”.</p>

<p><img src="/images/20210214_17.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Configuring Route Table" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Configure the Route Table | Source: Me</p>

<p>Navigate back to the VCN page by clicking on the VCN name on the breadcrumbs bar:</p>

<p><img src="/images/20210214_18.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate back to the VCN page" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate back to the VCN page | Source: Me</p>

<p>From here, click on “Create Subnet”:</p>

<p><img src="/images/20210214_9.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Click on Create Subnet" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Creating Subnet | Source: Me</p>

<p>Then, configure the subnet:</p>

<p><img src="/images/20210214_19.png" style="max-width: 700px; width: 100%; margin: 0 auto; display: block;" alt="Click on Create Subnet" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Configuring the Subnet | Source: Me</p>

<p>After being redirected back to the subnet page, click on “Security List” on the sidebar. You do not need to wait for the Subnet to finish provisioning:</p>

<p><img src="/images/20210214_20.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate to Security List" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate to Security List | Source: Me</p>

<p>Click on create “Create Security List”:</p>

<p><img src="/images/20210214_21.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Create Security List" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Create a security list | Source: Me</p>

<p>Fill in the details for the Security List. Take care to include rules for port 22 and port 443 (OpenVPN TCP) for TCP, and port 1194 (OpenVPN UDP) for UDP; you can click on “Add Ingress Rule” or “Add Egress Rule” to create new rules for the Security List accordingly. Keep the “Stateless” box unchecked, so that ZeroTier can smoothly perform UDP hole punching.</p>

<p><img src="/images/20210214_22.png" style="max-width: 900px; width: 100%; margin: 0 auto; display: block;" alt="Configure Security List" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Configure the security list | Source: Me</p>

<p>After being redirected back to the Security List page, click on “Network Security Groups” on the sidebar.</p>

<p><img src="/images/20210214_23.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate to Network Security Groups" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate to Network Security Groups | Source: Me</p>

<p>Click on “Create Network Security Group”.</p>

<p><img src="/images/20210214_24.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Create Network Security Group" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Create Network Security Group | Source: Me</p>

<p>Name the Network Security Group whatever you want, then click Next:</p>

<p><img src="/images/20210214_25.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Name the Network Security Group" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Name the Network Security Group | Source: Me</p>

<p>Add the same rules as you did for the Security List:</p>

<p><img src="/images/20210214_26.png" style="max-width: 800px; width: 100%; margin: 0 auto; display: block;" alt="Configure the Network Security Group" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Configure the Network Security Group | Source: Me</p>

<p>Go back to the subnet page:</p>

<p><img src="/images/20210214_18.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate back to the VCN page" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate back to the VCN page | Source: Me</p>

<p><img src="/images/20210214_27.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Navigate back to the subnet page" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Navigate to the subnet page | Source: Me</p>

<p>Click into the public subnet created earlier:</p>

<p><img src="/images/20210214_28.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Click into the subnet created earlier" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Click into the subnet you created earlier | Source: Me</p>

<p>Click on add security list:</p>

<p><img src="/images/20210214_30.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Click on Add Security List" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Click on Add Security List | Source: Me</p>

<p>Add the security list created earlier:</p>

<p><img src="/images/20210214_29.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Add the security list created earlier" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Add the security list created earlier | Source: Me</p>

<p>Delete the default security list from the subnet:</p>

<p><img src="/images/20210214_31.png" style="max-width: 600px; width: 100%; margin: 0 auto; display: block;" alt="Delete default security list" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Delete the default security list | Source: Me</p>

<h1 id="step-2-create-a-vm">Step 2: Create a VM</h1>

<p>Go to the <a href="https://cloud.oracle.com/compute/instances">instances page</a>, and click on “Create Instance”:</p>

<p><img src="/images/20210214_32.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Create an instance" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Create an instance | Source: Me</p>

<p>You can leave the instance name as it’s default, or name it whatever you like. Click on the box containing the Container Image, and choose the “Canonical Ubuntu 20.04 Minimal” image. If you went through all the steps in Step 1, then under “Configure networking”, check “Use network security group to control traffic”; select the VCN, Subnet and Network Security Group created in Step 1. Under “Public IP Address”, select “Assign a public IPv4 address”.</p>

<p>Remember to click on “Save Private Key” so that you can connect to the instance later on. Then, click the “Create” button.</p>

<p><img src="/images/20210214_33.png" style="max-width: 800px; width: 100%; margin: 0 auto; display: block;" alt="Create a VM instance" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Create a VM instance | Source: Me</p>

<h2 id="optional">Optional</h2>

<p>If you want some redundancy that a Cloud VM instance can have, you can:</p>

<ol>
  <li>Create and attach a block volume (free tier: 100GB); put all your configuration files there.
    <ul>
      <li>You may need to stop the <code class="language-plaintext highlighter-rouge">zerotier-one</code> service to <code class="language-plaintext highlighter-rouge">rm -rf /var/lib/zerotier-one</code>, so that you can run <code class="language-plaintext highlighter-rouge">ln -s /var/lib/zerotier-one /mnt/blockvolume/zerotier</code> to more effectively transfer ZeroTier identities from one instance to another.</li>
    </ul>
  </li>
  <li>Create an image once you are done setting up the instance; then, create an instance pool that uses the created image.</li>
  <li>Reserve a public IP so that you can reattach it to a new instance.</li>
  <li>Use Dynamic DNS for your instance, <em>or</em> use Oracle Cloud’s load balancer; take note that Oracle Cloud’s load balancer is a paid service.</li>
</ol>

<p>This guide doesn’t cover these, because I am too lazy to explain them, out of scope, and I’m running out of time :sweat_smile:, but they are simple enough that an afternoon should suffice to research how to accomplish them.</p>

<h1 id="step-3-install-packages-on-vm">Step 3: Install packages on VM</h1>

<p>For this step, we must install a text editor (vim, nano, etc), ZeroTier, easy-rsa and OpenVPN. Additionally it is recommended that you install UFW, although Step 1 should have amortized your instance enough.</p>

<p>SSH to the instance with the downloaded key, then run the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> https://install.zerotier.com | <span class="nb">sudo </span>bash
<span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>openvpn vim easy-rsa ufw
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>zerotier-one <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>systemctl start zerotier-one
<span class="nb">sudo </span>zerotier-cli <span class="nb">join</span> &lt;network ID&gt;
</code></pre></div></div>

<p>Ensure on ZeroTier Central or equivalent that your VM instance has joined the network. Do note down the ZeroTier tunnel device name:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip <span class="nb">link</span> | <span class="nb">grep</span> <span class="s2">"zt"</span>
</code></pre></div></div>

<p>Before you forget, allow SSH connections and enable UFW:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ufw allow 22/tcp
<span class="nb">sudo </span>ufw <span class="nb">enable</span>
</code></pre></div></div>

<p>Oracle Cloud adds their own rules to <code class="language-plaintext highlighter-rouge">iptables</code>, which causes some routing problems later on down the road. If you plan on hosting other services, do take note of Oracle Cloud’s rules (which by default only allows connections from TCP port 22):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>iptables <span class="nt">-vL</span>
</code></pre></div></div>

<p>This guide will add entries into <code class="language-plaintext highlighter-rouge">iptables</code> such that they are not blocked by Oracle Cloud’s default rules; you can refer to them to add rules for your own services.</p>

<h1 id="step-4-create--configure-openvpn-server"><span id="step4">Step 4: Create &amp; Configure OpenVPN server</span></h1>

<p>This step is adopted from <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">DigitalOcean’s guide on how to setup an OpenVPN server</a>; that guide uses Ubuntu 16.04 with easy-rsa 2, while this guide uses Ubuntu 20.04 with easy-rsa 3. There are also easy setup scripts online, although you should exercise caution when running scripts downloaded from the internet.</p>

<p>Before we can even configure the OpenVPN server, we must become a Certificate Authority and issue certificates for both the server and client. This allows clients authenticate the server, and vice-versa.</p>

<p>Find a suitable working folder, and create a folder to store CA related files:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make-cadir openvpn-ca
</code></pre></div></div>

<p>Then, append the following lines into the <code class="language-plaintext highlighter-rouge">openvpn-ca/vars</code> file:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">export</span> <span class="py">KEY_COUNTRY</span><span class="p">=</span><span class="s">"US"</span>
<span class="err">export</span> <span class="py">KEY_EMAIL</span><span class="p">=</span><span class="s">"donotemail@exdee.exdee"</span>
<span class="err">export</span> <span class="py">KEY_CITY</span><span class="p">=</span><span class="s">"Somewhere"</span>
<span class="err">export</span> <span class="py">KEY_PROVINCE</span><span class="p">=</span><span class="s">"There"</span>
<span class="err">export</span> <span class="py">KEY_ORG</span><span class="p">=</span><span class="s">"CodingIndex"</span>
<span class="err">export</span> <span class="py">KEY_OU</span><span class="p">=</span><span class="s">"ADMIN"</span>
<span class="err">export</span> <span class="py">KEY_NAME</span><span class="p">=</span><span class="s">"server"</span>
</code></pre></div></div>

<p>Change the values of all the variables to whatever you want; just try not to change <code class="language-plaintext highlighter-rouge">KEY_NAME</code>, unless you have to - it is easier to follow the guide if you name your key “server”.</p>

<p>Next, you will want to change your working directory to <code class="language-plaintext highlighter-rouge">openvpn-ca</code>, so that you can run the <code class="language-plaintext highlighter-rouge">easyrsa</code> executable with the following subcommands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>openvpn-ca
./easyrsa init-pki
./easyrsa build-ca
./easyrsa build-server-full server nopass
./easyrsa gen-dh
<span class="nb">mkdir </span>keys <span class="o">&amp;&amp;</span> openvpn <span class="nt">--genkey</span> <span class="nt">--secret</span> keys/ta.key
</code></pre></div></div>

<p>Easy-rsa may prompt you for additional information.</p>
<blockquote>
  <p>Run <code class="language-plaintext highlighter-rouge">easyrsa --pki-dir=&lt;insert directory here&gt;</code> to change where the PKIs are stored, which by default is <code class="language-plaintext highlighter-rouge">${PWD}/pki</code>.</p>
</blockquote>

<p>You <em>should</em> then create as many client certificates as the devices you plan to connect to this server. But it is not strictly necessary, as one certificate can be used for multiple devices. Here is how to create a single client certificate:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./easyrsa build-client-full client1 nopass
</code></pre></div></div>

<p>Copy the appropriate certificates to the <code class="language-plaintext highlighter-rouge">/etc/openvpn</code> folder:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>keys/ta.key <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/private/server.key <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/issued/server.crt <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/dh.pem /etc/openvpn
</code></pre></div></div>

<p>Next, download the sample server configuration file from the OpenVPN’s Git repository (if you are on an Ubuntu minimal image, you should not have this on your system because it has been minimized):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/openvpn
<span class="nb">sudo </span>wget https://raw.githubusercontent.com/OpenVPN/openvpn/master/sample/sample-config-files/server.conf
</code></pre></div></div>

<p>Edit the server configuration file; for this part, we will configure a TCP OpenVPN server listening on port 443, but the method to configure are the same for the UDP OpenVPN server listening on port 1194 if you decide to host two OpenVPN servers. Modify the following lines by searching for them in your favourite editor:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/server.conf</code>:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port</span> <span class="m">443</span>
<span class="n">proto</span> <span class="n">tcp</span>
<span class="n">user</span> <span class="n">nobody</span>
<span class="n">group</span> <span class="n">nogroup</span>
<span class="n">cipher</span> <span class="n">AES</span>-<span class="m">256</span>-<span class="n">CBC</span>
<span class="n">auth</span> <span class="n">SHA256</span>
<span class="n">push</span> <span class="s2">"redirect-gateway def1 bypass-dhcp"</span>
<span class="n">push</span> <span class="s2">"dhcp-option DNS 208.67.222.222"</span>
<span class="n">push</span> <span class="s2">"dhcp-option DNS 208.67.220.220"</span>
<span class="n">dh</span> <span class="n">dh</span>.<span class="n">pem</span>

<span class="c"># these line does not exist by default
</span><span class="n">auth</span> <span class="n">SHA256</span>
</code></pre></div></div>

<p>Try starting the OpenVPN server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start openvpn@server
<span class="nb">sudo </span>systemctl status openvpn@server
</code></pre></div></div>

<p>If the server successfully initializes, then enable the server, and note down the tunnel device used for the connection:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>openvpn@server
ip <span class="nb">link</span> | <span class="nb">grep</span> <span class="s2">"tun"</span>
</code></pre></div></div>

<p>More than likely, the result should show <code class="language-plaintext highlighter-rouge">tun0</code>.</p>

<p>Download your VPN provider’s OpenVPN configuration file, and copy them into <code class="language-plaintext highlighter-rouge">/etc/openvpn</code>. Afterwards, create a service file in <code class="language-plaintext highlighter-rouge">/etc/systemd/system</code>:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/systemd/system/vpnprovider.service</code>:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">Binds OpenVPN server tunnel to OpenVPN client tunnel</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="s">simple</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="s">openvpn --cd /etc/openvpn --config &lt;client config file here&gt; --route-noexec --route-up /etc/openvpn/client-up.sh --route-pre-down /etc/openvpn/client-down.sh</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="s">multi-user.target</span>
</code></pre></div></div>

<p>Then, create the files <code class="language-plaintext highlighter-rouge">/etc/openvpn/client-up.sh</code> and <code class="language-plaintext highlighter-rouge">/etc/openvpn/client-down.sh</code> to manually route:</p>
<ul>
  <li>All connections to 0.0.0.0/0 to the VPN provider;</li>
  <li>All connections to ZeroTier local address (e.g. 172.25.0.0/16) to ZeroTier.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/client-up.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">SRC_DEVICE</span><span class="o">=</span><span class="s2">"tun0"</span>
<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_CIDR</span><span class="o">=</span><span class="s2">"172.25.0.0/16"</span>

<span class="nb">set</span> <span class="nt">-e</span>

sysctl <span class="nt">-w</span> net.ipv4.ip_forward<span class="o">=</span>1

<span class="nb">touch</span> /etc/iproute2/rt_tables.d/ovpn2ovpn.conf
<span class="nb">echo</span> <span class="s2">"42070 ovpn2ovpn"</span> <span class="o">&gt;</span> /etc/iproute2/rt_tables.d/ovpn2ovpn.conf

ip rule add from 10.8.0.0/24 table ovpn2ovpn
ip route add default via <span class="k">${</span><span class="nv">route_vpn_gateway</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> table ovpn2ovpn
ip route add <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table ovpn2ovpn

iptables <span class="nt">-I</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-I</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-I</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-I</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-t</span> nat <span class="nt">-I</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> MASQUERADE
iptables <span class="nt">-t</span> nat <span class="nt">-I</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/client-down.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">SRC_DEVICE</span><span class="o">=</span><span class="s2">"tun0"</span>
<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_CIDR</span><span class="o">=</span><span class="s2">"172.25.0.0/16"</span>

ip rule delete from 10.8.0.0/24 table ovpn2ovpn
ip route delete default via <span class="k">${</span><span class="nv">route_vpn_gateway</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> table ovpn2ovpn
ip route delete <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table ovpn2ovpn

<span class="nb">rm</span> <span class="nt">-f</span> /etc/iproute2/rt_tables.d/ovpn2ovpn.conf

iptables <span class="nt">-D</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-D</span> INPUT <span class="nt">-i</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-D</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-D</span> FORWARD <span class="nt">-i</span> <span class="k">${</span><span class="nv">SRC_DEVICE</span><span class="k">}</span> <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-t</span> nat <span class="nt">-D</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">dev</span><span class="k">}</span> <span class="nt">-d</span> 0.0.0.0/0 <span class="nt">-j</span> MASQUERADE
iptables <span class="nt">-t</span> nat <span class="nt">-D</span> POSTROUTING <span class="nt">-o</span> <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">ZT_CIDR</span><span class="k">}</span> <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">10.8.0.0/24</code> is the CIDR used by default for <code class="language-plaintext highlighter-rouge">/etc/openvpn/server.conf</code>. Remember to flag the scripts as executable:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod</span> +x /etc/openvpn/client-up.sh /etc/openvpn/client-down.sh
</code></pre></div></div>

<p>Start the custom service:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start vpnprovider
<span class="nb">sudo </span>systemctl status vpnprovider
</code></pre></div></div>

<p>If successfully started, enable the service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>vpnprovider
</code></pre></div></div>

<p>Now that all the services are in place, allow them through the UFW:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ufw allow 9993/udp <span class="c"># for ZeroTier</span>
ufw allow 443/tcp
ufw allow 1194/udp
</code></pre></div></div>

<p>In theory anyway. On Oracle Cloud VM instances, UFW rules are placed <strong>below</strong> a REJECT rule on the IPTables, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4  1344 ACCEPT     all  --  tun0   any     anywhere             anywhere            
 848K  472M ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED
    0     0 ACCEPT     icmp --  any    any     anywhere             anywhere            
  688 59382 ACCEPT     all  --  lo     any     anywhere             anywhere            
    0     0 ACCEPT     udp  --  any    any     anywhere             anywhere             udp spt:ntp
 1294 75128 ACCEPT     tcp  --  any    any     anywhere             anywhere             state NEW tcp dpt:ssh
10739 5199K REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-host-prohibited
    0     0 ufw-before-logging-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-before-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-after-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-after-logging-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-reject-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-track-input  all  --  any    any     anywhere             anywhere 
</code></pre></div></div>

<p>In other words, UFW becomes absolutely useless. As an interesting side note, trying to connect to a port other than TCP port 22 will yield ‘Destination Host Unreachable’ error messages thanks to IPTable rejecting connections with <code class="language-plaintext highlighter-rouge">icmp-host-prohibited</code>. There are two ways to circumvent this:</p>
<ol>
  <li>Delete the REJECT rule;</li>
  <li>Add my own IPTable rules.</li>
</ol>

<p>For this guide, I decided to just <em>add</em> my own iptable rules, since I don’t know the implications of deleting the REJECT rule:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/iptables/rules.v4</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>filter
:INPUT ACCEPT <span class="o">[</span>0:0]
...
<span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> 443 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 1194 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-s</span> tun0 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-s</span> tun1 <span class="nt">-j</span> ACCEPT
...
</code></pre></div></div>

<h1 id="step-5-create-client-configurations"><span id="step5">Step 5: Create Client Configurations</span></h1>

<p>Now, we generate the <code class="language-plaintext highlighter-rouge">.ovpn</code> files used by the clients. For convenience (and to rip off <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">DigitalOcean’s guide</a>), we’ll combine the CA certificate, Client certificate and Client’s key into the <code class="language-plaintext highlighter-rouge">.ovpn</code> file.</p>

<p>Firstly, we generate a working directory to store the files needed for the <code class="language-plaintext highlighter-rouge">.ovpn</code> file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/client/files
</code></pre></div></div>

<p>Then, we download the example client configuration from the official Git repository:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="nt">-O</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/client/files/base.conf https://raw.githubusercontent.com/OpenVPN/openvpn/master/sample/sample-config-files/client.conf
</code></pre></div></div>

<p>Modify <code class="language-plaintext highlighter-rouge">client.conf</code> to match the server configuration (assuming TCP on 443):</p>

<p><code class="language-plaintext highlighter-rouge">${PWD}/client/client.conf</code>:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remote</span> <span class="n">x</span>.<span class="n">x</span>.<span class="n">x</span>.<span class="n">x</span> <span class="m">443</span>
<span class="n">proto</span> <span class="n">tcp</span>
<span class="n">user</span> <span class="n">nobody</span>
<span class="n">group</span> <span class="n">nogroup</span>
<span class="n">cipher</span> <span class="n">AES</span>-<span class="m">256</span>-<span class="n">CBC</span>
<span class="n">auth</span> <span class="n">SHA256</span>

<span class="c"># comment out these lines
</span>;<span class="n">ca</span> <span class="n">ca</span>.<span class="n">crt</span>
;<span class="n">cert</span> <span class="n">client</span>.<span class="n">crt</span>
;<span class="n">key</span> <span class="n">client</span>.<span class="n">key</span>
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">x.x.x.x</code> with the IP assigned to your Oracle VM instance.</p>

<p>The <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">DigitalOcean guide</a> uses a script to generate the <code class="language-plaintext highlighter-rouge">.ovpn</code> file, so that is what we will be doing too. It essentially concatenates all the necessary files together and spits out an <code class="language-plaintext highlighter-rouge">.ovpn</code> file.</p>

<p><code class="language-plaintext highlighter-rouge">${PWD}/client/make_config.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># First argument: Client identifier</span>
<span class="nv">PKI_DIR</span><span class="o">=</span><span class="s2">"../pki"</span>
<span class="nv">CA_DIR</span><span class="o">=</span><span class="s2">"../openvpn-ca"</span>
<span class="nv">OUTPUT_DIR</span><span class="o">=</span><span class="s2">"./files"</span>
<span class="nv">BASE_CONFIG</span><span class="o">=</span><span class="s2">"./files/base.conf"</span>

<span class="nb">cat</span> <span class="k">${</span><span class="nv">BASE_CONFIG</span><span class="k">}</span> <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;ca&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/ca.crt <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/ca&gt;\n&lt;cert&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/issued/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.crt <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/cert&gt;\n&lt;key&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.key <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/key&gt;\n&lt;tls-auth&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">CA_DIR</span><span class="k">}</span>/keys/ta.key <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/tls-auth&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="o">&gt;</span> <span class="k">${</span><span class="nv">OUTPUT_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.ovpn
</code></pre></div></div>

<p>Adjust the directories to their absolute paths just to be sure. Once you are confident that the paths are accurate, give the script the executable go-ahead, and run the script with the parameter of the client name (should be <code class="language-plaintext highlighter-rouge">client1</code>, as generated with <code class="language-plaintext highlighter-rouge">./easyrsa build-client-full client nopass</code>):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;path to client directory&gt;
<span class="nb">chmod</span> +x make_config.sh
./make_config.sh client1
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">.ovpn</code> should be generated in the <code class="language-plaintext highlighter-rouge">./files</code> directory. This file can then be transferred to another device, like your Android device or ISP-controlled router. Give it a spin, and ensure everything is in working order by:</p>
<ul>
  <li>Checking IP address with <a href="https://ifconfig.so">ifconfig.so</a>, or VPN provider internet checker;</li>
  <li>Checking ZeroTier connectivity by pinging peers in the same network.</li>
</ul>

<h1 id="conclusion">Conclusion</h1>

<p>You have successfully set up Solution Duo. <a href="/2021/02/14/zerotier-openvpn-nat-part-1#bookmark">Click here</a> to go back to Part 1; otherwise, if you are satisfied with your setup, then we’re done here.</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><summary type="html"><![CDATA[Duo Architecture]]></summary></entry><entry><title type="html">ZeroTier OpenVPN NAT - Part 4</title><link href="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-4/" rel="alternate" type="text/html" title="ZeroTier OpenVPN NAT - Part 4" /><published>2021-02-14T13:27:00+00:00</published><updated>2021-02-14T13:27:00+00:00</updated><id>https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-4</id><content type="html" xml:base="https://codingindex.xyz/2021/02/14/zerotier-openvpn-nat-part-4/"><![CDATA[<p><img src="/images/20210214_5.png" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Architecture" /></p>
<p class="text-center text-gray lh-condensed-ultra f6">Dinosaur Architecture</p>

<p><a href="/2021/02/14/zerotier-openvpn-nat-part-1#bookmark">&lt;&lt; Take me back to Part 1</a></p>

<p>Solution Dinosaur was designed to combine <a href="/2021/02/14/zerotier-openvpn-nat-part-2">Solution Uno</a> and <a href="/2021/02/14/zerotier-openvpn-nat-part-3">Solution Duo</a>; although this means inheriting both the good and bad of the two solutions, a device will have more options to stay connected to both the VPN provider and the ZeroTier network from anywhere in the world.</p>

<h1 id="step-0-pre-requisites">Step 0: Pre-requisites</h1>

<p>You should complete the all the steps for <a href="/2021/02/14/zerotier-openvpn-nat-part-2">Solution Uno</a>, and up to Step 3 of <a href="/2021/02/14/zerotier-openvpn-nat-part-3">Solution Duo</a>. Do note that a Single Board Computer device is required, alongside the obvious need for an Oracle Cloud account.</p>

<h1 id="step-1-create--configure-openvpn-server">Step 1: Create &amp; Configure OpenVPN server</h1>

<p>This step is quite similar to <a href="/2021/02/14/zerotier-openvpn-nat-part-3#step4">Step 4 of Solution Duo</a>; hence, I’ll be borrowing some text from that step.</p>

<p>Before we can even configure the OpenVPN server, we must become a Certificate Authority and issue certificates for both the server and client. This allows clients authenticate the server, and vice-versa.</p>

<p>Find a suitable working folder, and create a folder to store CA related files:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make-cadir openvpn-ca
</code></pre></div></div>

<p>Then, append the following lines into the <code class="language-plaintext highlighter-rouge">openvpn-ca/vars</code> file:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">export</span> <span class="py">KEY_COUNTRY</span><span class="p">=</span><span class="s">"US"</span>
<span class="err">export</span> <span class="py">KEY_EMAIL</span><span class="p">=</span><span class="s">"donotemail@exdee.exdee"</span>
<span class="err">export</span> <span class="py">KEY_CITY</span><span class="p">=</span><span class="s">"Somewhere"</span>
<span class="err">export</span> <span class="py">KEY_PROVINCE</span><span class="p">=</span><span class="s">"There"</span>
<span class="err">export</span> <span class="py">KEY_ORG</span><span class="p">=</span><span class="s">"CodingIndex"</span>
<span class="err">export</span> <span class="py">KEY_OU</span><span class="p">=</span><span class="s">"ADMIN"</span>
<span class="err">export</span> <span class="py">KEY_NAME</span><span class="p">=</span><span class="s">"server"</span>
</code></pre></div></div>

<p>Change the values of all the variables to whatever you want; just try not to change <code class="language-plaintext highlighter-rouge">KEY_NAME</code>, unless you have to - it is easier to follow the guide if you name your key “server”.</p>

<p>Next, you will want to change your working directory to <code class="language-plaintext highlighter-rouge">openvpn-ca</code>, so that you can run the <code class="language-plaintext highlighter-rouge">easyrsa</code> executable with the following subcommands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>openvpn-ca
./easyrsa init-pki
./easyrsa build-ca
./easyrsa build-server-full server nopass
./easyrsa gen-dh
<span class="nb">mkdir </span>keys <span class="o">&amp;&amp;</span> openvpn <span class="nt">--genkey</span> <span class="nt">--secret</span> keys/ta.key
</code></pre></div></div>

<p>Easy-rsa may prompt you for additional information.</p>
<blockquote>
  <p>Run <code class="language-plaintext highlighter-rouge">easyrsa --pki-dir=&lt;insert directory here&gt;</code> to change where the PKIs are stored, which by default is <code class="language-plaintext highlighter-rouge">${PWD}/pki</code>.</p>
</blockquote>

<p>You <em>should</em> then create as many client certificates as the devices you plan to connect to this server. But it is not strictly necessary, as one certificate can be used for multiple devices. Here is how to create a single client certificate:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./easyrsa build-client-full client1 nopass
</code></pre></div></div>

<p>Copy the appropriate certificates to the <code class="language-plaintext highlighter-rouge">/etc/openvpn</code> folder:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>keys/ta.key <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/private/server.key <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/issued/server.crt <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/pki/dh.pem /etc/openvpn
</code></pre></div></div>

<p>Next, download the sample server configuration file from the OpenVPN’s Git repository (if you are on an Ubuntu minimal image, you should not have this on your system because it has been minimized):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/openvpn
<span class="nb">sudo </span>wget https://raw.githubusercontent.com/OpenVPN/openvpn/master/sample/sample-config-files/server.conf
</code></pre></div></div>

<p>Edit the server configuration file; for this part, we will configure a TCP OpenVPN server listening on port 443, but the method to configure are the same for the UDP OpenVPN server listening on port 1194 if you decide to host two OpenVPN servers. Modify the following lines by searching for them in your favourite editor:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/server.conf</code>:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port</span> <span class="m">443</span>
<span class="n">proto</span> <span class="n">tcp</span>
<span class="n">user</span> <span class="n">nobody</span>
<span class="n">group</span> <span class="n">nogroup</span>
<span class="n">cipher</span> <span class="n">AES</span>-<span class="m">256</span>-<span class="n">CBC</span>
<span class="n">auth</span> <span class="n">SHA256</span>
<span class="n">push</span> <span class="s2">"redirect-gateway def1 bypass-dhcp"</span>
<span class="n">push</span> <span class="s2">"dhcp-option DNS 208.67.222.222"</span>
<span class="n">push</span> <span class="s2">"dhcp-option DNS 208.67.220.220"</span>
<span class="n">dh</span> <span class="n">dh</span>.<span class="n">pem</span>

<span class="c"># these line does not exist by default
</span><span class="n">auth</span> <span class="n">SHA256</span>
<span class="n">up</span> /<span class="n">etc</span>/<span class="n">openvpn</span>/<span class="n">up</span>-<span class="n">script</span>.<span class="n">sh</span>
<span class="n">down</span> /<span class="n">etc</span>/<span class="n">openvpn</span>/<span class="n">down</span>-<span class="n">script</span>.<span class="n">sh</span>
</code></pre></div></div>

<p>Create the files <code class="language-plaintext highlighter-rouge">/etc/openvpn/up-script.sh</code> and <code class="language-plaintext highlighter-rouge">/etc/openvpn/down-script.sh</code>.</p>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/up-script.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_GATEWAY</span><span class="o">=</span><span class="s2">"172.25.0.1"</span>

<span class="nb">touch</span> /etc/iproute2/rt_tables.d/ovpn2zt.conf
<span class="nb">echo</span> <span class="s2">"42069 ovpn2zt"</span> <span class="o">&gt;</span> /etc/iproute2/rt_tables.d/ovpn2zt.conf

ip rule add from 10.8.0.0/24 table ovpn2zt
ip route add default via <span class="k">${</span><span class="nv">ZT_GATEWAY</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table ovpn2zt
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/etc/openvpn/down-script.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">ZT_DEVICE</span><span class="o">=</span><span class="s2">"ztly52mmwy"</span>
<span class="nv">ZT_GATEWAY</span><span class="o">=</span><span class="s2">"172.25.0.1"</span>

ip rule delete from 10.8.0.0/24 table ovpn2zt
ip route delete default via <span class="k">${</span><span class="nv">ZT_GATEWAY</span><span class="k">}</span> dev <span class="k">${</span><span class="nv">ZT_DEVICE</span><span class="k">}</span> table ovpn2zt

<span class="nb">rm</span> <span class="nt">-f</span> /etc/iproute2/rt_tables.d/ovpn2zt.conf
</code></pre></div></div>

<p>The CIDR, <code class="language-plaintext highlighter-rouge">10.8.0.0/24</code> is defined in <code class="language-plaintext highlighter-rouge">/etc/openvpn/server.conf</code>; as long as it has not been changed, the above scripts should work. Change the ZeroTier device variable to the one you noted earlier; the gateway variable should be the IP address of the host from Solution Uno. Remember to run:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod</span> +x /etc/openvpn/up-script.sh /etc/openvpn/down-script.sh
</code></pre></div></div>

<p>Try starting the OpenVPN server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start openvpn@server
<span class="nb">sudo </span>systemctl status openvpn@server
</code></pre></div></div>

<p>If the server starts successfully, enable the service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>openvpn@server
</code></pre></div></div>

<p>Now that all the services are in place, allow them through the UFW:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ufw allow 9993/udp <span class="c"># for ZeroTier</span>
ufw allow 443/tcp
ufw allow 1194/udp
</code></pre></div></div>

<p>In theory anyway. On Oracle Cloud VM instances, UFW rules are placed <strong>below</strong> a REJECT rule on the IPTables, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4  1344 ACCEPT     all  --  tun0   any     anywhere             anywhere            
 848K  472M ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED
    0     0 ACCEPT     icmp --  any    any     anywhere             anywhere            
  688 59382 ACCEPT     all  --  lo     any     anywhere             anywhere            
    0     0 ACCEPT     udp  --  any    any     anywhere             anywhere             udp spt:ntp
 1294 75128 ACCEPT     tcp  --  any    any     anywhere             anywhere             state NEW tcp dpt:ssh
10739 5199K REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-host-prohibited
    0     0 ufw-before-logging-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-before-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-after-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-after-logging-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-reject-input  all  --  any    any     anywhere             anywhere            
    0     0 ufw-track-input  all  --  any    any     anywhere             anywhere 
</code></pre></div></div>

<p>In other words, UFW becomes absolutely useless. As an interesting side note, trying to connect to a port other than TCP port 22 will yield ‘Destination Host Unreachable’ error messages thanks to IPTable rejecting connections with <code class="language-plaintext highlighter-rouge">icmp-host-prohibited</code>. There are two ways to circumvent this:</p>
<ol>
  <li>Delete the REJECT rule;</li>
  <li>Add my own IPTable rules.</li>
</ol>

<p>For this guide, I decided to just <em>add</em> my own iptable rules, since I don’t know the implications of deleting the REJECT rule:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/iptables/rules.v4</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>filter
:INPUT ACCEPT <span class="o">[</span>0:0]
...
<span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> 443 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 1194 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-s</span> tun0 <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> FORWARD <span class="nt">-s</span> zt+ <span class="nt">-j</span> ACCEPT
...
<span class="k">*</span>nat
...
<span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 10.8.0.0/24 <span class="nt">-o</span> zt+ <span class="nt">-j</span> MASQUERADE
...
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">zt+</code> with the actual ZeroTier device if you like to be less permissive.</p>

<h1 id="step-2-create-client-configurations">Step 2: Create Client Configurations</h1>

<p>This step is the same as <a href="/2021/02/14/zerotier-openvpn-nat-part-3#step5">Step 5 of Solution Duo</a>.</p>

<p>Now, we generate the <code class="language-plaintext highlighter-rouge">.ovpn</code> files used by the clients. For convenience (and to rip off <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">DigitalOcean’s guide</a>), we’ll combine the CA certificate, Client certificate and Client’s key into the <code class="language-plaintext highlighter-rouge">.ovpn</code> file.</p>

<p>Firstly, we generate a working directory to store the files needed for the <code class="language-plaintext highlighter-rouge">.ovpn</code> file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/client/files
</code></pre></div></div>

<p>Then, we download the example client configuration from the official Git repository:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="nt">-O</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/client/files/base.conf https://raw.githubusercontent.com/OpenVPN/openvpn/master/sample/sample-config-files/client.conf
</code></pre></div></div>

<p>Modify <code class="language-plaintext highlighter-rouge">client.conf</code> to match the server configuration (assuming TCP on 443):</p>

<p><code class="language-plaintext highlighter-rouge">${PWD}/client/client.conf</code>:</p>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remote</span> <span class="n">x</span>.<span class="n">x</span>.<span class="n">x</span>.<span class="n">x</span> <span class="m">443</span>
<span class="n">proto</span> <span class="n">tcp</span>
<span class="n">user</span> <span class="n">nobody</span>
<span class="n">group</span> <span class="n">nogroup</span>
<span class="n">cipher</span> <span class="n">AES</span>-<span class="m">256</span>-<span class="n">CBC</span>
<span class="n">auth</span> <span class="n">SHA256</span>

<span class="c"># comment out these lines
</span>;<span class="n">ca</span> <span class="n">ca</span>.<span class="n">crt</span>
;<span class="n">cert</span> <span class="n">client</span>.<span class="n">crt</span>
;<span class="n">key</span> <span class="n">client</span>.<span class="n">key</span>
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">x.x.x.x</code> with the IP assigned to your Oracle VM instance.</p>

<p>The <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">DigitalOcean guide</a> uses a script to generate the <code class="language-plaintext highlighter-rouge">.ovpn</code> file, so that is what we will be doing too. It essentially concatenates all the necessary files together and spits out an <code class="language-plaintext highlighter-rouge">.ovpn</code> file.</p>

<p><code class="language-plaintext highlighter-rouge">${PWD}/client/make_config.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># First argument: Client identifier</span>
<span class="nv">PKI_DIR</span><span class="o">=</span>../pki
<span class="nv">CA_DIR</span><span class="o">=</span>../openvpn-ca
<span class="nv">OUTPUT_DIR</span><span class="o">=</span>./files
<span class="nv">BASE_CONFIG</span><span class="o">=</span>./files/base.conf

<span class="nb">cat</span> <span class="k">${</span><span class="nv">BASE_CONFIG</span><span class="k">}</span> <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;ca&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/ca.crt <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/ca&gt;\n&lt;cert&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/issued/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.crt <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/cert&gt;\n&lt;key&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">PKI_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.key <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/key&gt;\n&lt;tls-auth&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="k">${</span><span class="nv">CA_DIR</span><span class="k">}</span>/keys/ta.key <span class="se">\</span>
    &lt;<span class="o">(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'&lt;/tls-auth&gt;'</span><span class="o">)</span> <span class="se">\</span>
    <span class="o">&gt;</span> <span class="k">${</span><span class="nv">OUTPUT_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.ovpn
</code></pre></div></div>

<p>Adjust the directories to their absolute paths just to be sure. Once you are confident that the paths are accurate, give the script the executable go-ahead, and run the script with the parameter of the client name (should be <code class="language-plaintext highlighter-rouge">client1</code>, as generated with <code class="language-plaintext highlighter-rouge">./easyrsa build-client-full client nopass</code>):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;path to client directory&gt;
<span class="nb">chmod</span> +x make_config.sh
./make_config.sh client1
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">.ovpn</code> should be generated in the <code class="language-plaintext highlighter-rouge">./files</code> directory. This file can then be transferred to another device, like your Android device or ISP-controlled router. Give it a spin, and ensure everything is in working order by:</p>
<ul>
  <li>Checking IP address with <a href="https://ifconfig.so">ifconfig.so</a>, or VPN provider internet checker;</li>
  <li>Checking ZeroTier connectivity by pinging peers in the same network.</li>
</ul>

<h1 id="conclusion">Conclusion</h1>

<p>Theoretically, you have set up Solution Dinosaur, which is the same set up I use personally - I may have missed out a few steps, so do your best to fill in the gaps!</p>

<p>Happy Coding</p>

<p>CodingIndex</p>]]></content><author><name>James</name></author><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><category term="openvpn" /><category term="zerotier" /><category term="decentralized" /><summary type="html"><![CDATA[Dinosaur Architecture]]></summary></entry></feed>