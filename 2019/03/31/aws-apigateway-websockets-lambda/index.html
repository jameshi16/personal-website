







<!doctype html>
<html class="height-full">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="While working on a hackathon project, I had difficulty getting AWS Lambda to communicate with API Gateway’s (relatively) new WebSocket Connection URL (which has the form of: https://&amp;lt;api gateway id&amp;gt;.execute-api.&amp;lt;region&amp;gt;.amazonaws.com/&amp;lt;stage&amp;gt;/@connections)..." />
    <title>CodingIndex's Random Shenanigans</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Blog posts (last 10, atom feed)">
    <link href="/feed/anime.xml" type="application/atom+xml" rel="alternate" title="Weaboo Corner (last 10, atom feed)">
    <link href="/assets/styles.css" rel="stylesheet" type="text/css">
    <link href="/favicon.png" rel="icon" type="image/png" sizes="128x128">
  </head>
  <body class="height-full" style="width: 100vw; overflow-x: hidden">




  <div class="container-xl pt-6 p-responsive text-center">
    

<img src="/CodingIndex.png" class="mb-3" style="max-width: 150px;" alt="CodingIndex Logo">
<p class="mb-3 f4 text-gray">A (human) index that likes to code<br><span class="f5">Also drinks way too much coffee <img class="emoji" title=":coffee:" alt=":coffee:" src="https://github.githubassets.com/images/icons/emoji/unicode/2615.png" height="20" width="20"></span></p>
<nav class="UnderlineNavi container-md"> 
  <div class="UnderlineNav-body" style="display: block">
    <a href="/" role="tab" title="Home" class="UnderlineNav-item selected">Home</a>
    <a href="/anime" role="tab" title="Anime" class="UnderlineNav-item ">Anime</a>
    <a href="/about" role="tab" title="About" class="UnderlineNav-item ">About</a>
  </div>
</nav>



    <div class="container-xl f4 text-left border rounded-2 bg-white p-3 p-sm-5 mt-6">
      <p class="f5"><a href="/" class="d-flex flex-items-center"><svg height="16" class="octicon octicon-chevron-left mr-2 v-align-middle" fill="#0366d6" aria-label="Home" viewbox="0 0 16 16" version="1.1" width="16" role="img"><path fill-rule="evenodd" d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"></path></svg>Home</a></p>
      <h1 class="f00-light lh-condensed">AWS API Gateway Websockets with AWS Lambda</h1>
      <p class="text-gray mb-5">Published Mar 31, 2019 12:00</p>
      
  <div class="article">
    <p>While working on a hackathon project, I had difficulty getting AWS Lambda to communicate with API Gateway’s (relatively) new WebSocket Connection URL (which has the form of: <code class="language-plaintext highlighter-rouge">https://&lt;api gateway id&gt;.execute-api.&lt;region&gt;.amazonaws.com/&lt;stage&gt;/@connections</code>),</p>

<h1 id="environment">Environment</h1>
<p>At the time of writing, AWS Lambda provides the following <a href="https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html" target="_blank" rel="noopener noreferrer">environments</a> that I use:</p>
<ul>
  <li>Python 3.7</li>
  <li>Boto3 1.12.42</li>
</ul>

<h1 id="what-i-tried-to-do">What I tried to do</h1>
<ol>
  <li>
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/apigatewaymanagementapi.html" target="_blank" rel="noopener noreferrer">Boto3’s</a> <code class="language-plaintext highlighter-rouge">ApiGatewayManagementApi</code>:
    <ul>
      <li>Didn’t work, because AWS Lambda runs some weird version of Boto3, because despite the version number being higher than the documentation I consulted (v1.9.125), AWS Lambda’s Boto3 doesn’t have <code class="language-plaintext highlighter-rouge">ApiGatewayManagementApi</code>. Maybe it is only available on an offline installation of Boto3, but I didn’t have <img class="emoji" title=":clock10:" alt=":clock10:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png" height="20" width="20">, so I couldn’t test it out.</li>
    </ul>
  </li>
  <li>Looking at the code required for <a href="https://docs.aws.amazon.com/general/latest/gr/sigv4-signed-request-examples.html" target="_blank" rel="noopener noreferrer">implementing AWS SigV4</a>:
    <ul>
      <li>Because AWS Services sometimes need SigV4 so that only authenticated requests are executed;</li>
      <li>Hence, AWS API Gateway’s WebSocket Connection URL requires requests signed with SigV4;</li>
      <li>However, this is way too low-level for something I’m trying to hack in 4 hours;</li>
      <li>So I didn’t do this in the end. This would have worked, if I had enough <img class="emoji" title=":clock10:" alt=":clock10:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png" height="20" width="20"> and patience.</li>
    </ul>
  </li>
  <li>Adding a Boto3 <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" target="_blank" rel="noopener noreferrer">layer</a> on AWS Lambda:
    <ul>
      <li>Layers are like packages for AWS Lambda;</li>
      <li>However, the Boto3 version probably isn’t the issue, because the Boto3 on AWS Lambda has a higher version number compared to the documentation I referred to;</li>
      <li>Moreover, I didn’t want to upload an entire installation of Boto3;</li>
      <li>And more pressingly, I didn’t have <img class="emoji" title=":clock10:" alt=":clock10:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png" height="20" width="20"> to do the above.</li>
    </ul>
  </li>
  <li>Adding a SigV4 layer <a href="https://github.com/DavidMuller/aws-requests-auth" target="_blank" rel="noopener noreferrer">using the code written by David Muller</a> or <a href="https://github.com/jmenga/requests-aws-sign" target="_blank" rel="noopener noreferrer">the one by jmenga</a>:
    <ul>
      <li>Which would have worked, but I found another solution almost immediately after that.</li>
    </ul>
  </li>
</ol>

<h1 id="what-worked">What worked</h1>
<p>On the <a href="https://stackoverflow.com/questions/38144273/making-a-signed-http-request-to-aws-elasticsearch-in-python" target="_blank" rel="noopener noreferrer">StackOverflow post</a> that (3) and (4) came from, there was one very underrated solution by <code class="language-plaintext highlighter-rouge">b.b3rn4rd</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore.credentials</span>
<span class="kn">from</span> <span class="nn">botocore.awsrequest</span> <span class="kn">import</span> <span class="n">AWSRequest</span>
<span class="kn">from</span> <span class="nn">botocore.endpoint</span> <span class="kn">import</span> <span class="n">BotocoreHTTPSession</span>
<span class="kn">from</span> <span class="nn">botocore.auth</span> <span class="kn">import</span> <span class="n">SigV4Auth</span>

<span class="n">params</span> <span class="o">=</span> <span class="s">'{"name": "hello"}'</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'Host'</span><span class="p">:</span> <span class="s">'ram.ap-southeast-2.amazonaws.com'</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">AWSRequest</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">"POST"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">"https://ram.ap-southeast-2.amazonaws.com/createresourceshare"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">SigV4Auth</span><span class="p">(</span><span class="n">boto3</span><span class="p">.</span><span class="n">Session</span><span class="p">().</span><span class="n">get_credentials</span><span class="p">(),</span> <span class="s">"ram"</span><span class="p">,</span> <span class="s">"ap-southeast-2"</span><span class="p">).</span><span class="n">add_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>    


<span class="n">session</span> <span class="o">=</span> <span class="n">BotocoreHTTPSession</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">prepare</span><span class="p">())</span>
</code></pre></div></div>
<p class="text-center text-gray lh-condensed-ultra f6">Credit: <code>b.b3rn4rd</code> from <a href="https://stackoverflow.com/questions/38144273/making-a-signed-http-request-to-aws-elasticsearch-in-python" target="_blank" rel="noopener noreferrer">StackOverflow</a></p>

<p>The problem with the above code is that <code class="language-plaintext highlighter-rouge">BotocoreHTTPSession</code> no longer exists in newer versions of Botocore (and by extension, Boto3), and so I dived into the source code of Boto3 and botocore to find a drop-in replacement: <code class="language-plaintext highlighter-rouge">URLLib3Session</code>,</p>

<p>Changing the code to work with API Gateway’s WebSockets Connection URL, this is what I’ve got:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">botocore.awsrequest</span> <span class="kn">import</span> <span class="n">AWSRequest</span>
<span class="kn">from</span> <span class="nn">botocore.httpsession</span> <span class="kn">import</span> <span class="n">URLLib3Session</span>
<span class="kn">from</span> <span class="nn">botocore.auth</span> <span class="kn">import</span> <span class="n">SigV4Auth</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">URLLib3Session</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="c1"># insert your data here
</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">AWSRequest</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">"POST"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">"https://&lt;api gateway id&gt;.execute-api.&lt;region&gt;.amazonaws.com/&lt;stage&gt;/@connections/&lt;connection id&gt;"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Host'</span><span class="p">:</span> <span class="s">'&lt;api gateway id&gt;.execute-api.&lt;region&gt;.amazonaws.com'</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">SigV4Auth</span><span class="p">(</span><span class="n">boto3</span><span class="p">.</span><span class="n">Session</span><span class="p">().</span><span class="n">get_credentials</span><span class="p">(),</span> <span class="s">"execute-api"</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">region</span><span class="o">&gt;</span><span class="p">).</span><span class="n">add_auth</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="n">session</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">prepare</span><span class="p">())</span>

</code></pre></div></div>

<p>With that, AWS Lambda can now interface with the AWS API Gateway WebSockets Connection URL, and can contact clients connected to the API Gateway via WebSockets. This allowed me to create a real-time dashboard that displays data from AWS DynamoDB streams, which are updated according to create/update/delete events happening to a DynamoDB table.</p>

<p>Well then, time use this knowledge to build the real-time app of your dreams!</p>

<p>Happy Coding,</p>

<p>CodingIndex</p>

  </div>

    </div>
  </div>

    <footer>
      <div class="container-md p-3 text-gray text-center">
        <p>Copyright © CodingIndex 2023</p>
      </div>
    </footer>
  </body>
</html>

