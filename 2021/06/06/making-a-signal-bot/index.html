







<!doctype html>
<html class="height-full">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="Yes, yes, okay, I get it. I missed the May deadline. Here, calm down and have a coffee :coffee:.So, I don’t have many friends. The friends that I have are… strange, to say the least.A while ago, I, ModelConverge and nikhilr migrated to Signal, to escape from the privacy policy change imposed by W..." />
    <title>CodingIndex's Random Shenanigans</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Blog posts (last 10, atom feed)">
    <link href="/feed/anime.xml" type="application/atom+xml" rel="alternate" title="Weaboo Corner (last 10, atom feed)">
    <link href="/assets/styles.css" rel="stylesheet" type="text/css">
    <link href="/favicon.png" rel="icon" type="image/png" sizes="128x128">
  </head>
  <body class="height-full" style="width: 100vw; overflow-x: hidden">




  <div class="container-xl pt-6 p-responsive text-center">
    

<img src="/CodingIndex.png" class="mb-3" style="max-width: 150px;" alt="CodingIndex Logo">
<p class="mb-3 f4 text-gray">A (human) index that likes to code<br><span class="f5">Also drinks way too much coffee <img class="emoji" title=":coffee:" alt=":coffee:" src="https://github.githubassets.com/images/icons/emoji/unicode/2615.png" height="20" width="20"></span></p>
<nav class="UnderlineNavi container-md"> 
  <div class="UnderlineNav-body" style="display: block">
    <a href="/" role="tab" title="Home" class="UnderlineNav-item selected">Home</a>
    <a href="/anime" role="tab" title="Anime" class="UnderlineNav-item ">Anime</a>
    <a href="/about" role="tab" title="About" class="UnderlineNav-item ">About</a>
  </div>
</nav>



    <div class="container-xl f4 text-left border rounded-2 bg-white p-3 p-sm-5 mt-6">
      <p class="f5"><a href="/" class="d-flex flex-items-center"><svg height="16" class="octicon octicon-chevron-left mr-2 v-align-middle" fill="#0366d6" aria-label="Home" viewbox="0 0 16 16" version="1.1" width="16" role="img"><path fill-rule="evenodd" d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"></path></svg>Home</a></p>
      <h1 class="f00-light lh-condensed">Making a Signal bot</h1>
      <p class="text-gray mb-5">Published Jun 06, 2021 10:38</p>
      
  <div class="article">
    <p>Yes, yes, okay, I get it. I missed the May deadline. Here, calm down and have a coffee <img class="emoji" title=":coffee:" alt=":coffee:" src="https://github.githubassets.com/images/icons/emoji/unicode/2615.png" height="20" width="20">.</p>

<p>So, I don’t have many friends. The friends that I have are… strange, to say the least.</p>

<p>A while ago, I, <a href="https://modelconverge.xyz/" target="_blank" rel="noopener noreferrer">ModelConverge</a> and <a href="https://nikhilr.io/" target="_blank" rel="noopener noreferrer">nikhilr</a> migrated to Signal, to escape from the privacy policy change imposed by Whatsapp. While Whatsapp claims that the privacy policy change will only affect Whatsapp Business users, we had already wanted to migrate away from Whatsapp ever since Facebook acquired it; so the policy change by Whatsapp simply acted as a catalyst. We are hence glad to report that we were part of the masses that hugged <a href="https://www.forbes.com/sites/rachelsandler/2021/01/15/so-many-people-are-using-signal-it-caused-an-outage/?sh=7d7968493df2" target="_blank" rel="noopener noreferrer">Signal to death</a> during a mass migration to the Signal platform, especially after <a href="https://twitter.com/elonmusk/status/1347165127036977153?lang=en" target="_blank" rel="noopener noreferrer">Elon Musk’s tweet</a>.</p>

<blockquote>
  <p>For those of you living under a rock, Signal is an instant messenger just like Whatsapp. Many people migrated to Signal because: (i) it is <a href="https://github.com/signalapp" target="_blank" rel="noopener noreferrer">open-source</a>, (ii) it is run by a <a href="https://signalfoundation.org/" target="_blank" rel="noopener noreferrer">non-profit organization</a> and (iii) has <a href="https://signal.org/docs/" target="_blank" rel="noopener noreferrer">libraries &amp; specifications</a> for developers who want to leverage the Signal protocol or platform to build apps.</p>
</blockquote>

<h1 id="spark">Spark</h1>

<p>The Signal messenger is wonderful; but the users - they have too much power. One of my pals, <a href="https://nikhilr.io/" target="_blank" rel="noopener noreferrer">nikhilr</a> decided to change the group’s avatar photo, drastically changing the friendly democratic climate we shared, effectively serving as a declaration of war between all parties involved. What followed was a great group war that is described in history books as the pivotal moment of the greatest creation.</p>

<p><img src="/images/20210606_1.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="Fighting a great war"></p>
<p class="text-center text-gray lh-condensed-ultra f6">Fighting a great war in Signal | Source: Me</p>

<p>I couldn’t just sit idly by and watch as my enemy won battle after battle, getting foothold after foothold on my sanctuary; hence, as a responsible and perfectly rational adult, I decided to abandon all of the work society had me do, and built a Signal bot to eliminate my enemy’s only advantage (free time), and exploit his weakest point (the fact that he is human and hence slower).</p>

<p><img src="/images/20210606_2.jpg" style="max-width: 400px; width: 100%; margin: 0 auto; display: block;" alt="The bot in action, but Nikhil disrupts the policy"></p>
<p class="text-center text-gray lh-condensed-ultra f6">Using a bot to fight the war | Source: Me</p>

<p>As you can clearly see, before nikhilr decided to remove my privileges to edit the Group Avatar like a true savage undeserving of a respectful knight, my bot fought an admirable battle, stunning my enemies who displayed sheer awe towards my cunning plot.</p>

<p>Today, we won’t be building Group Contender Bot; instead, we’ll just be making a simple Signal bot, to jog your creativity and get you started.</p>

<hr>

<h1 id="considerations">Considerations</h1>

<p>Being a container nerd, I decided that my bot <em>must</em> be setup and run in a container. Automatically, this means that the Signal bot can be run from any platform that can run Docker; furthermore, this would deploy nicely on a home server running most services on <code class="language-plaintext highlighter-rouge">docker-compose</code>.</p>

<p>When searching for a way to interface with Signal, I found <a href="https://github.com/AsamK/signal-cli" target="_blank" rel="noopener noreferrer">Signal CLI</a>, which exposes a DBus interface for applications to interact with. Hence, all I needed to do was to get a library that could interface with the DBus, like <a href="https://pypi.org/project/pydbus/" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">pydbus</code></a>.</p>

<h2 id="dbus">DBus</h2>

<p>Many Linux applications talk to each other over the System DBus; according to <a href="https://unix.stackexchange.com/a/604398" target="_blank" rel="noopener noreferrer">this StackOverflow post</a>, it is used as an alternative to <code class="language-plaintext highlighter-rouge">sudo</code>, by allowing a non-privileged application to perform inter-process communication (IPC) to a more privileged application through a bunch of exposed functions. Hence, the system DBus is also the default DBus used by many applications.</p>

<p>Because of the <code class="language-plaintext highlighter-rouge">non-privileged &lt;-&gt; privilege</code> method of communication, container software do not normally expose the System DBus to guest containers because it would open up a whole array of possible vulnerabilities. Thankfully, when digger deeper as to what DBus actually is, I found out that it is essentially a protocol slapped on top of a UNIX socket, meaning that theoretically, it should be possible to construct my own DBus instance <em>just</em> for Signal communication.</p>

<h2 id="python">Python</h2>

<p>The beauty of using the DBus to communicate implies that any language under the sun can be used; I decided to go with Python on an impulse with no clear thought; if I were to make a rational choice, I would have selected <a href="https://golang.org/" target="_blank" rel="noopener noreferrer">Golang</a>, for how simple it is to spawn Go routines for multiprocessing.</p>

<p>On the other hand, Python makes the code more understandable to a wider audience, given its simplicity, and how it is the “comfy” language for most people, allowing a wider audience to develop useful Signal bots.</p>

<hr>

<h1 id="pre-requisites">Pre-requisites</h1>

<p>So, let us build a Signal bot!</p>

<p>First and foremost, we need to install all of the dependencies. On an Ubuntu system, Signal CLI requires <code class="language-plaintext highlighter-rouge">default-jre</code>, while the <code class="language-plaintext highlighter-rouge">pydbus</code> package requires <code class="language-plaintext highlighter-rouge">build-essentials</code>, <code class="language-plaintext highlighter-rouge">libcairo2-dev</code> and <code class="language-plaintext highlighter-rouge">libgirepository1.0-dev</code>. As you can see, for a bot that will run in container, there are quite a lot of dependencies; hence, instead of polluting my otherwise pure host environment, I decided to create a <code class="language-plaintext highlighter-rouge">Dockerfile</code> to build me an environment that can handle Signal CLI.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:latest</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span><span class="s2">"noninteractive"</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> python3 python3-pip default-jre coreutils curl wget libcairo2-dev libgirepository1.0-dev
<span class="k">WORKDIR</span><span class="s"> /tmp</span>
<span class="k">RUN </span>curl <span class="nt">-s</span> https://api.github.com/repos/AsamK/signal-cli/releases/latest <span class="se">\
</span>  | <span class="nb">grep</span> <span class="s2">"browser_download_url.*tar.gz"</span> <span class="se">\
</span>  | <span class="nb">cut</span> <span class="nt">-d</span> : <span class="nt">-f</span> 2,3 <span class="se">\
</span>  | <span class="nb">tr</span> <span class="nt">-d</span> <span class="se">\"</span> <span class="se">\
</span>  | <span class="nb">grep</span> <span class="s2">".gz$"</span> <span class="se">\
</span>  | wget <span class="nt">-qi</span> -
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /opt/cli <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> /opt/bot <span class="o">&amp;&amp;</span> <span class="nb">tar </span>xvf <span class="k">*</span>.tar.gz <span class="nt">-C</span> /opt/cli <span class="o">&amp;&amp;</span> <span class="nb">mv</span> /opt/cli/signal<span class="k">*</span> /opt/cli/signal
<span class="k">WORKDIR</span><span class="s"> /opt/bot</span>
<span class="k">RUN </span>pip <span class="nb">install </span>pydbus PyGObject
</code></pre></div></div>

<blockquote>
  <p>I adapted the <code class="language-plaintext highlighter-rouge">curl</code> command from this <a href="https://gist.github.com/steinwaywhw/a4cd19cda655b8249d908261a62687f8" target="_blank" rel="noopener noreferrer">GitHub gist</a> written by <a href="https://gist.github.com/steinwaywhw" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">@steinwaywhw</code></a>.</p>
</blockquote>

<p>This creates an Ubuntu container with the latest Signal CLI install in <code class="language-plaintext highlighter-rouge">/opt/cli</code>, and the working directory planted in <code class="language-plaintext highlighter-rouge">/opt/bot</code>. To use this container for Signal bot development, you will keep some things at hand:</p>

<ol>
  <li>A phone number you have SMS access to;</li>
  <li>A directory to store your Signal secrets;</li>
  <li>A directory for your bot project;</li>
  <li>A name for your bot.</li>
</ol>

<p>Once you have figured out the phone number &amp; directories you want to use, set them in a terminal you’ll be using for Signal bot related work:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PHONE_NUMBER="&lt;a phone number, with +countrycode prefixed&gt;"
export SIGNAL_CLI_DATA="&lt;a directory for signal secrets&gt;"
export SIGNAL_BOT_PROJECT="&lt;the directory to your bot project&gt;"
export SIGNAL_BOT_NAME="&lt;any alphanumeric name for your bot&gt;"
alias signal-cli='docker run -v "$SIGNAL_BOT_PROJECT:/opt/bot" -v "$SIGNAL_CLI_DATA:/root/.local/share/signal-cli" -e PHONE_NUMBER="$PHONE_NUMBER" signal-bot:latest /opt/cli/signal/bin/signal-cli'
</code></pre></div></div>

<p>For development purposes, we should first link the Signal CLI to our phone number, so that the bot can send and receive messages. To do this, we first copy + paste the <code class="language-plaintext highlighter-rouge">Dockerfile</code> to a local directory, and build the Docker image:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/2fff57fac78826e17ad097dcb4c7ed1e873ddb1e/Dockerfile
docker build . -t signal-bot:latest
</code></pre></div></div>

<p>Now, if you want to link to a phone number <em>you already use for daily Signal usage</em>, then run this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli link -n "$SIGNAL_BOT_NAME" &gt; /tmp/output &amp; \sleep 10 &amp;&amp; cat /tmp/output | curl -F-=\&lt;- https://qrenco.de &amp;&amp; fg
</code></pre></div></div>

<p>A QR code should be generated and then printed on your terminal window; scan the result with your phone’s Signal messenger. If you don’t know how, follow the <a href="https://support.signal.org/hc/en-us/articles/360007320551-Linked-Devices" target="_blank" rel="noopener noreferrer">guide on the official Signal Support</a>.</p>

<p>Your device should be linked.</p>

<p><strong>Otherwise</strong>, if you want to link a completely new phone number, then run this Signal CLI command through the container:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli -u ${PHONE_NUMBER} register
</code></pre></div></div>

<p>You should receive a SMS with your OTP code to activate Signal. Copy that verification code before running this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signal-cli -u ${PHONE_NUMBER} verify &lt;insert verification code&gt;
</code></pre></div></div>

<h1 id="writing-the-bot">Writing the bot</h1>

<p>Now, we move to the stage where we write the bot. No matter what language the bot is written in, the bot needs at least two other running processes:</p>

<ol>
  <li>A DBus daemon; and</li>
  <li>A daemonized Signal CLI process.</li>
</ol>

<p>Hence, before we can even write the content required for the bot, we must first write an entrypoint script for the Docker container. Luckily, we can quite easily write this script:</p>

<p><code class="language-plaintext highlighter-rouge">entrypoint.sh</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nb">export </span><span class="nv">DBUS_SESSION_BUS_ADDRESS</span><span class="o">=</span><span class="si">$(</span>dbus-daemon <span class="nt">--session</span> <span class="nt">--fork</span> <span class="nt">--print-address</span><span class="si">)</span>

<span class="nb">touch</span> /tmp/output.log
/opt/cli/signal/bin/signal-cli <span class="nt">-u</span> <span class="s2">"</span><span class="k">${</span><span class="nv">PHONE_NUMBER</span><span class="k">}</span><span class="s2">"</span> daemon <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp;
dbus-monitor <span class="nt">--session</span> <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp; <span class="c"># comment this out if you no longer need to monitor the bus</span>
<span class="nb">sleep </span>20s <span class="o">&amp;&amp;</span> python3 /opt/bot/script.py <span class="o">&gt;&gt;</span> /tmp/output.log 2&gt;&amp;1 &amp;

<span class="nb">tail</span> <span class="nt">-f</span> /tmp/output.log
</code></pre></div></div>

<p>The script above assumes that you are executing a bot written in Python, with the entrypoint of that bot within <code class="language-plaintext highlighter-rouge">script.py</code> of your project folder, and also assumes that you have set the environmental variables right. Let’s test it out:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alias run_bot="docker run -v \"$SIGNAL_BOT_PROJECT:/opt/bot\" -v \"$SIGNAL_CLI_DATA:/root/.local/share/signal-cli\" -e PHONE_NUMBER=\"$PHONE_NUMBER\" signal-bot:latest ./entrypoint.sh"
wget -O script.py https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/fd3fc896bfe56d18741ba84c8c63d00f34c8434b/receive.py
run_bot
</code></pre></div></div>

<p>The script written by <code class="language-plaintext highlighter-rouge">mh-g</code>, modified by me to use a Session Bus instead, essentially reads every message pumped into Signal out onto the terminal window.</p>

<blockquote>
  <p>The purpose of <code class="language-plaintext highlighter-rouge">sleep 20s</code> is to give Signal CLI some time to: (i) start daemonizing, (ii) connect to the DBus, and (iii) synchronize messages a little before starting the actual script. Sometimes, this takes more than 20s, but for our purposes, it should be good enough. You may sometimes find your bot unresponsive during this stage; but trust me, it’ll work <em>eventually</em>, after catching up with all of the messages.</p>
</blockquote>

<p>Once you have verified the workability of your whole set up, it is time to write code to develop a signal bot. Let’s start with the <code class="language-plaintext highlighter-rouge">receive.py</code> sample code you downloaded to test the workability of your setup:</p>

<p><code class="language-plaintext highlighter-rouge">script.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="k">def</span> <span class="nf">msgRcv</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"msgRcv called"</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">return</span>

<span class="kn">from</span> <span class="nn">pydbus</span> <span class="kn">import</span> <span class="n">SessionBus</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GLib</span>

<span class="n">bus</span> <span class="o">=</span> <span class="n">SessionBus</span><span class="p">()</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">GLib</span><span class="p">.</span><span class="n">MainLoop</span><span class="p">()</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">bus</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'org.asamk.Signal'</span><span class="p">,</span> <span class="s">'/org/asamk/Signal'</span><span class="p">)</span>
<span class="n">signal</span><span class="p">.</span><span class="n">onMessageReceived</span> <span class="o">=</span> <span class="n">msgRcv</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>If you’ve linked the bot to a number that is <em>already</em> using Signal, then you would realize that this piece of code would only work when people other than yourself messages you. If you want to receive <em>all</em> messages, including the ones from yourself, then change:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">def msgRcv(timestamp, source, groupID, message, attachments):
</span>  print("msgRcv called")
  print(message)
  return
<span class="err">
</span><span class="gi">+ def msgSyncRcv(timestamp, source, destination, groupID, message, attachments):
+   msgRcv(timestamp, source, groupId, message, attachments)
+   return
</span><span class="err">
</span>...
<span class="err">
</span><span class="p">signal = bus.get('org.asamk.Signal', '/org/asamk/Signal')
signal.onMessageReceived = msgRcv
</span><span class="gi">+ signal.onSyncMessageReceived = msgSyncRcv
</span><span class="err">
</span><span class="p">if __name__ == '__main__':
</span></code></pre></div></div>

<p>And then run the bot again with the <code class="language-plaintext highlighter-rouge">run_bot</code> command.</p>

<p>Let’s make the bot respond to commands that start with the <code class="language-plaintext highlighter-rouge">/</code> prefix, by changing the contents of the <code class="language-plaintext highlighter-rouge">msgRcv</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">msgRcv</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/'</span><span class="p">:</span>
    <span class="n">signal</span><span class="p">.</span><span class="n">sendGroupMessage</span><span class="p">(</span><span class="s">"{:s} said {:s}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">message</span><span class="p">),</span> <span class="p">[],</span> <span class="n">groupID</span><span class="p">)</span>
  <span class="k">return</span>

</code></pre></div></div>

<p>Now, send a message to the bot with the <code class="language-plaintext highlighter-rouge">/</code> prefix, and you should see that the bot echos you like a parrot. With that, we now have a basic bot. For more things that the bot can do, check out <a href="https://github.com/AsamK/signal-cli/blob/master/man/signal-cli-dbus.5.adoc" target="_blank" rel="noopener noreferrer">Signal CLI’s DBus wiki</a>; all of the functions are available by de-capitalizing the first letter, and then accessing it as a sub-member of the <code class="language-plaintext highlighter-rouge">signal</code> object. This also includes the DBus signals listed on the manpage.</p>

<p>For a more complete guide, let’s make an 8-ball bot, which essentially just returns an 8-ball-esque response based on random probability.</p>

<p>8-ball has <a href="https://en.wikipedia.org/wiki/Magic_8-Ball#Design_and_usage" target="_blank" rel="noopener noreferrer">20 different answers</a>, which can be represented by the following Python list:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s">'It is Certain.'</span><span class="p">,</span> <span class="s">'It is decidedly so.'</span><span class="p">,</span> <span class="s">'Without a doubt.'</span><span class="p">,</span> <span class="s">'Yes definitely.'</span><span class="p">,</span> <span class="s">'You may rely on it.'</span><span class="p">,</span> <span class="s">'As I see it, yes.'</span><span class="p">,</span> <span class="s">'Most likely.'</span><span class="p">,</span> <span class="s">'Outlook good.'</span><span class="p">,</span> <span class="s">'Yes.'</span><span class="p">,</span> <span class="s">'Signs point to yes.'</span><span class="p">,</span> <span class="s">'Reply hazy, try again.'</span><span class="p">,</span> <span class="s">'Ask again later.'</span><span class="p">,</span> <span class="s">'Better not tell you now.'</span><span class="p">,</span> <span class="s">'Cannot predict now.'</span><span class="p">,</span> <span class="s">'Concentrate and ask again.'</span><span class="p">,</span> <span class="s">'Don</span><span class="se">\'</span><span class="s">t count on it.'</span><span class="p">,</span> <span class="s">'My reply is no.'</span><span class="p">,</span> <span class="s">'My sources say no.'</span><span class="p">,</span> <span class="s">'Outlook not so good.'</span><span class="p">,</span> <span class="s">'Very doubtful.'</span><span class="p">]</span>
</code></pre></div></div>

<p>For the <code class="language-plaintext highlighter-rouge">msgRcv</code> function, we basically just choose a random string within the list, and return it whenever we see 8 ball after the <code class="language-plaintext highlighter-rouge">/</code> prefix:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s">'It is Certain.'</span><span class="p">,</span> <span class="s">'It is decidedly so.'</span><span class="p">,</span> <span class="s">'Without a doubt.'</span><span class="p">,</span> <span class="s">'Yes definitely.'</span><span class="p">,</span> <span class="s">'You may rely on it.'</span><span class="p">,</span> <span class="s">'As I see it, yes.'</span><span class="p">,</span> <span class="s">'Most likely.'</span><span class="p">,</span> <span class="s">'Outlook good.'</span><span class="p">,</span> <span class="s">'Yes.'</span><span class="p">,</span> <span class="s">'Signs point to yes.'</span><span class="p">,</span> <span class="s">'Reply hazy, try again.'</span><span class="p">,</span> <span class="s">'Ask again later.'</span><span class="p">,</span> <span class="s">'Better not tell you now.'</span><span class="p">,</span> <span class="s">'Cannot predict now.'</span><span class="p">,</span> <span class="s">'Concentrate and ask again.'</span><span class="p">,</span> <span class="s">'Don</span><span class="se">\'</span><span class="s">t count on it.'</span><span class="p">,</span> <span class="s">'My reply is no.'</span><span class="p">,</span> <span class="s">'My sources say no.'</span><span class="p">,</span> <span class="s">'Outlook not so good.'</span><span class="p">,</span> <span class="s">'Very doubtful.'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">msgRcv</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">groupID</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/'</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">'8ball'</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">signal</span><span class="p">.</span><span class="n">sendGroupMessage</span><span class="p">(</span><span class="s">'8ball: '</span> <span class="o">+</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="p">[],</span> <span class="n">groupID</span><span class="p">)</span>
  <span class="k">return</span>
</code></pre></div></div>

<p>Full code for <code class="language-plaintext highlighter-rouge">script.py</code> can be found in <a href="https://gist.github.com/jameshi16/71764cc0bac84adda717e9ddb0b44364#file-script-py" target="_blank" rel="noopener noreferrer">my gist</a>. After editing the script, the bot can be run with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run_bot
</code></pre></div></div>

<p>Now, on Signal, messaging <code class="language-plaintext highlighter-rouge">/8ball</code> should yield:</p>

<p><img src="/images/20210606_3.PNG" style="max-width: 200px; width: 100%; margin: 0 auto; display: block;" alt="8 ball response"></p>
<p class="text-center text-gray lh-condensed-ultra f6">A response from magical 8 ball | Source: Me</p>

<h1 id="docker-compose">Docker Compose</h1>

<p>The last part is probably the simplest part; writing the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file. The template should be quite self-explanatory:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">signal-bot</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">https://gist.githubusercontent.com/jameshi16/71764cc0bac84adda717e9ddb0b44364/raw/Dockerfile</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">signal-bot</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">/bin/bash -c "./entrypoint.sh"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">${SIGNAL_CLI_DATA}:/root/.local/share/signal-cli</span>
      <span class="pi">-</span> <span class="s">${SIGNAL_BOT_PROJECT}:/opt/bot</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">PHONE_NUMBER=${PHONE_NUMBER}</span>
</code></pre></div></div>

<p>Then, fill in the relevant details in the <code class="language-plaintext highlighter-rouge">.env</code> file. If you have not shutdown the terminal you used in the <a href="#pre-requisite">pre-requisite</a> stage, then you can use this command to generate the <code class="language-plaintext highlighter-rouge">.env</code> file:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -e "SIGNAL_CLI_DATA=${SIGNAL_CLI_DATA}\nSIGNAL_BOT_PROJECT=${SIGNAL_BOT_PROJECT}\nPHONE_NUMBER=${PHONE_NUMBER}" &gt; .env
docker-compose config
</code></pre></div></div>

<p>You should see all of the environment variables substituted. If they are all there, then you can run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up
</code></pre></div></div>

<p>To see the bot in action; and run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up -d
</code></pre></div></div>

<p>To detach it from the terminal, and run it in the background.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Welp, that was fun! I will make the source code for the Group Avatar Contender bot available soon; but don’t count on it to be online after this blog post. Hopefully, this blog post makes up for the missing one you would have otherwise gotten on May. There <em>should</em> be a separate blog post for June; until then, ciao!</p>

<p>Happy Coding,</p>

<p>CodingIndex</p>

  </div>

    </div>
  </div>

    <footer>
      <div class="container-md p-3 text-gray text-center">
        <p>Copyright © CodingIndex 2023</p>
      </div>
    </footer>
  </body>
</html>

